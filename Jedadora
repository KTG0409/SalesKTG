# ------------------ Standard Library Imports ------------------
import os
import re
import json
import html
import base64
import random
import calendar
import pprint
import smtplib
from time import time
from textwrap import shorten, dedent
from collections import Counter
from typing import List, Dict, Any, Union
from datetime import datetime, timedelta
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication
from email.mime.text import MIMEText

# ------------------ Third-Party Libraries ------------------
import requests
import numpy as np
import swisseph as swe
from pytz import timezone
from openai import OpenAI
from weasyprint import HTML
from dotenv import load_dotenv, dotenv_values
from matplotlib.ticker import MaxNLocator
from matplotlib.patches import Patch
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
import matplotlib.font_manager as fm
from dateutil.relativedelta import relativedelta
from timezonefinder import TimezoneFinder

# ------------------ Load Environment Variables ------------------
load_dotenv()
#This is Karen's first app
OPENCAGE_API_KEY = os.getenv("OPENCAGE_API_KEY")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

client = OpenAI(api_key=OPENAI_API_KEY)
openai_api_key = OPENAI_API_KEY

def call_openai_chat(prompt, model="gpt-4o", temperature=0.7):
    response = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": prompt}],
        temperature=temperature
    )
    return response.choices[0].message.content.strip()


# ----- Ephemeris Path -----
swe.set_ephe_path(r"C:\Users\kmort\OneDrive\Documents\Lili Project\swisseph-data\ephe")

# ----- process submissions -----e
def process_submission(name, email, answers, birth_date, birth_time, birth_place):
    print(f"[DEBUG] Generating report for {name} ({email})")

    # PDF output path (Cloud Run allows writing only to /tmp)
    pdf_path = "/tmp/report.pdf"

    # Build a simple HTML string — you can make this as styled as you want
    html_content = f"""
    <html>
        <head>
            <meta charset="utf-8">
            <style>
                body {{ font-family: Arial, sans-serif; }}
                h1 {{ color: #2e6c80; }}
                p {{ font-size: 14px; }}
            </style>
        </head>
        <body>
            <h1>Astrology Report for {name}</h1>
            <p><strong>Email:</strong> {email}</p>
            <p><strong>Birth Date:</strong> {birth_date}</p>
            <p><strong>Birth Time:</strong> {birth_time}</p>
            <p><strong>Birth Place:</strong> {birth_place}</p>
            <h2>Your Answers</h2>
            <ul>
                {''.join(f'<li>{ans}</li>' for ans in answers)}
            </ul>
        </body>
    </html>
    """

    # Generate PDF from HTML
    HTML(string=html_content).write_pdf(pdf_path)

    # Debug check
    if os.path.exists(pdf_path):
        size = os.path.getsize(pdf_path)
        print(f"[DEBUG] PDF generated at {pdf_path}, size: {size} bytes")
    else:
        print("[ERROR] PDF was not created!")

    return pdf_path


def send_email(recipient, name, pdf_path):
    sender_email = "ktg.insights@gmail.com"
    app_password = os.getenv("GMAIL_APP_PASSWORD")  # ← Pull from .env for safety

    subject = f"Your Personalized Report, {name}"
    body = f"""
Hi {name},

Here is your personalized astrology report. Let me know if you have any questions or feedback!

Warmly,  
Liliana 
"""

    # Create the email
    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = recipient
    msg['Subject'] = subject

    msg.attach(MIMEText(body, 'plain'))

    # Attach PDF
    with open(pdf_path, "rb") as f:
        part = MIMEApplication(f.read(), Name="Your_Report.pdf")
        part['Content-Disposition'] = 'attachment; filename="Your_Report.pdf"'
        msg.attach(part)

    # Send the email
    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(sender_email, app_password)
        server.send_message(msg)

    print(f"[DEBUG] Email sent to {recipient}")


# ---- Constants for Images ----

moon_phase_emojis = {
    "New": "🌑", "Waxing": "🌓", "Full": "🌕", "Waning": "🌗"
}

All_Images = {
    # Horoscope
    "Scorpio": "https://i.imgur.com/3gBjnx5.jpg",
    "Pisces": "https://i.imgur.com/B9LPoaq.jpg",
    "Cancer": "https://i.imgur.com/nkqGacb.jpg",
    "Aquarius": "https://i.imgur.com/UZHaEmr.jpg",
    "Gemini": "https://i.imgur.com/dcr9Fty.jpg",
    "Libra": "https://i.imgur.com/5zYpKID.jpg",
    "Taurus": "https://i.imgur.com/hZfasH7.jpg",
    "Capricorn": "https://i.imgur.com/75cpQYE.jpg",
    "Virgo": "https://i.imgur.com/iN462FZ.jpg",
    "Sagittarius": "https://i.imgur.com/7ia4066.jpg",
    "Leo": "https://i.imgur.com/mtViQK6.jpg",
    "Aries": "https://i.imgur.com/T02ErX5.jpg",

    #Trait_icons
    "aquarius icon": "https://imgur.com/HenB7uv.png",
    "aries icon": "https://imgur.com/ALlTT03.png",
    "cancer icon": "https://imgur.com/f6qILhW.png",
    "capricorn icon": "https://imgur.com/HufUQRq.png",
    "gemini icon": "https://imgur.com/V66Aj9z.png",
    "leo icon": "https://imgur.com/ZDzkaZP.png",
    "libra icon": "https://imgur.com/BOXk1PF.png",
    "pisces icon": "https://imgur.com/ezDFQNj.png",
    "sagittarious icon": "https://imgur.com/exQJO2S.png",
    "scorpio icon": "https://imgur.com/9t1Fddk.png",
    "taurus icon": "https://imgur.com/M9sHLDe.png",
    "virgo icon": "https://imgur.com/9X1EHue.png",

    # Chinese Zodiac
    "Rat": "https://imgur.com/6U5uNw5.png",
    "Ox": "https://imgur.com/ALh0g4m.png",
    "Tiger": "https://imgur.com/gzAsYNP.png",
    "Rabbit": "https://imgur.com/UHTK3Qj.png",
    "Dragon": "https://imgur.com/Y2AJUeb.png",
    "Snake": "https://imgur.com/RixSAX9.png",
    "Horse": "https://imgur.com/iV1oEAD.png",
    "Goat": "https://imgur.com/vBZIhnH.png",
    "Monkey": "https://imgur.com/pzLzZht.png",
    "Rooster": "https://imgur.com/pf4wHjl.png",
    "Dog": "https://imgur.com/a/6OehJQC.png",
    "Pig": "https://imgur.com/0XoEOmI.png",

    # Planets
    "Sun_planet": "https://imgur.com/SYngWcq.png",
    "Moon": "https://imgur.com/5F7dg6E.png",
    "Mercury": "https://imgur.com/Yj0rcmG.png",
    "Venus": "https://imgur.com/yTMiu2d.png",
    "Mars": "https://imgur.com/y1G2gdv.png",
    "Jupiter": "https://imgur.com/Um201i6.png",
    "Saturn": "https://imgur.com/qTR0AtS.png",
    "Uranus": "https://imgur.com/D70vnBu.png",
    "Neptune": "https://imgur.com/RSTcTRc.png",
    "Earth": "https://imgur.com/DUrIkCy.png",

    # Decorative Page Breaks
    "pb_moon": "https://imgur.com/5F7dg6E.png",
    "pb_star": "https://imgur.com/dohbVra.png",
    "pb_sun": "https://imgur.com/b4uprtc.png",
    "pb_sunmoon": "https://imgur.com/oyuWlVS.png",

    # Elements
    "Element_Earth": "https://imgur.com/DugzvOo.png",
    "Element_Fire": "https://imgur.com/CYYlI7C.png",
    "Element_Water": "https://imgur.com/by8UAyg.png",
    "Element_Wind": "https://imgur.com/hujdKqG.png",
}

SUN_SIGN_IMAGES = {sign: All_Images[sign] for sign in [
    "Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo",
    "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"
]}

#-----------------IMAGE CONVERSION---------------------------------
def image_url_to_base64(url):
    try:
        response = requests.get(url)
        response.raise_for_status()
        return base64.b64encode(response.content).decode('utf-8')
    except Exception as e:
        print(f"Error loading image from {url}: {e}")
        return None


# ---------------- Human Design Gate Mapping ------------------

# Human Design Gates mapped to zodiac degrees
HD_GATE_ZODIAC_RANGES = {
    1:   (0.000, 5.625),    2:   (5.625, 11.250),
    3:  (11.250, 16.875),   4:  (16.875, 22.500),
    5:  (22.500, 28.125),   6:  (28.125, 33.750),
    7:  (33.750, 39.375),   8:  (39.375, 45.000),
    9:  (45.000, 50.625),  10:  (50.625, 56.250),
    11: (56.250, 61.875),  12:  (61.875, 67.500),
    13: (67.500, 73.125),  14:  (73.125, 78.750),
    15: (78.750, 84.375),  16:  (84.375, 90.000),
    17: (90.000, 95.625),  18:  (95.625, 101.250),
    19: (101.250, 106.875),20:  (106.875, 112.500),
    21: (112.500, 118.125),22:  (118.125, 123.750),
    23: (123.750, 129.375),24:  (129.375, 135.000),
    25: (135.000, 140.625),26:  (140.625, 146.250),
    27: (146.250, 151.875),28:  (151.875, 157.500),
    29: (157.500, 163.125),30:  (163.125, 168.750),
    31: (168.750, 174.375),32:  (174.375, 180.000),
    33: (180.000, 185.625),34:  (185.625, 191.250),
    35: (191.250, 196.875),36:  (196.875, 202.500),
    37: (202.500, 208.125),38:  (208.125, 213.750),
    39: (213.750, 219.375),40:  (219.375, 225.000),
    41: (225.000, 230.625),42:  (230.625, 236.250),
    43: (236.250, 241.875),44:  (241.875, 247.500),
    45: (247.500, 253.125),46:  (253.125, 258.750),
    47: (258.750, 264.375),48:  (264.375, 270.000),
    49: (270.000, 275.625),50:  (275.625, 281.250),
    51: (281.250, 286.875),52:  (286.875, 292.500),
    53: (292.500, 298.125),54:  (298.125, 303.750),
    55: (303.750, 309.375),56:  (309.375, 315.000),
    57: (315.000, 320.625),58:  (320.625, 326.250),
    59: (326.250, 331.875),60:  (331.875, 337.500),
    61: (337.500, 343.125),62:  (343.125, 348.750),
    63: (348.750, 354.375),64:  (354.375, 360.000)
}
def zodiac_degree_to_gate(degree: float) -> Union[int, None]:
    for gate, (start, end) in HD_GATE_ZODIAC_RANGES.items():
        if start <= degree < end:
            return gate
    return None
# ---------------- INTERPRETATION LIBRARIES -----------------

# ---------- Gate Mapping ------------------
human_design_gates = {
    1: "Gate 1 is the gate of creative expression. You radiate originality and bring your authentic self into all you do.",
    2: "Gate 2 holds the energy of direction and receptivity. You intuitively know the path forward when you trust your inner compass.",
    3: "Gate 3 carries transformative potential. You’re drawn to evolve and help systems reorganize from chaos into new form.",
    4: "Gate 4 is the gate of mental answers. Your mind seeks certainty and patterns — you bring logic to ambiguity.",
    5: "Gate 5 governs fixed rhythms. You thrive with structure and predictable flow, helping others ground into routine.",
    6: "Gate 6 is the gate of friction and intimacy. You have emotional boundaries that test and protect closeness.",
    7: "Gate 7 leads through influence. You guide collective direction by aligning with larger visions.",
    8: "Gate 8 is the gate of contribution. You express your uniqueness and empower others to share theirs.",
    9: "Gate 9 brings focus and precision. You can dive deeply into details and follow through on narrow paths.",
    10: "Gate 10 embodies self-love and behavior. You walk your truth and inspire others to live authentically.",
    11: "Gate 11 is the gate of ideas. Your mind generates visions and possibilities that inspire collective imagination.",
    12: "Gate 12 filters expression. You speak with emotional timing and profound impact when the moment is right.",
    13: "Gate 13 is the listener and archivist. You hold stories of the past and offer wisdom from experience.",
    14: "Gate 14 fuels prosperity. You attract resources when aligned with your core direction.",
    15: "Gate 15 amplifies extremes. You embrace diversity and bring wild compassion to collective rhythms.",
    16: "Gate 16 is the gate of enthusiasm and mastery. You dedicate yourself to skill and uplift others through your passion.",
    17: "Gate 17 offers opinions formed through logic. You see what could work and guide others toward clarity.",
    18: "Gate 18 refines systems through critique. You seek to correct patterns that no longer serve.",
    19: "Gate 19 connects needs with resources. You’re deeply attuned to others’ emotional and material welfare.",
    20: "Gate 20 speaks truth in the moment. You act and express from presence and clarity.",
    21: "Gate 21 manages resources and control. You have a natural instinct to organize and protect what matters.",
    22: "Gate 22 processes mood and grace. You hold emotional depth and social charisma.",
    23: "Gate 23 simplifies complexity. You translate insights into concise, transformative truths.",
    24: "Gate 24 is the gate of inner knowing. You reflect and return to mental themes until clarity arises.",
    25: "Gate 25 radiates universal love. You act with innocence and inspire trust through your openness.",
    26: "Gate 26 is the gate of the ego and influence. You remember what matters and shape how stories are told.",
    27: "Gate 27 nurtures life force. You instinctively care for others through devotion and generosity.",
    28: "Gate 28 seeks meaning in struggle. You endure and extract value from life’s challenges.",
    29: "Gate 29 is the gate of deep commitment. You say yes with full energy and teach others to trust devotion.",
    30: "Gate 30 holds intense desire. You long for experience and expansion — your fire draws others in.",
    31: "Gate 31 leads by voice. Your words carry influence when you speak for the collective.",
    32: "Gate 32 detects potential and fear of failure. You track what will last and adapt to ensure continuity.",
    33: "Gate 33 holds retreat and reflection. You honor sacred timing and speak once experience is digested.",
    34: "Gate 34 is pure power in the now. You move with instinctive energy and impact when aligned.",
    35: "Gate 35 is the jack-of-all-trades. You hunger for experience and bring stories back from the edge.",
    36: "Gate 36 feels emotional turbulence. You grow through contrast and catalyze deep compassion.",
    37: "Gate 37 bonds and builds agreements. You are loyal, warm, and protect sacred community.",
    38: "Gate 38 is the fighter for purpose. You resist what lacks meaning and pursue deep alignment.",
    39: "Gate 39 provokes emotional truth. You challenge others into honesty and self-revelation.",
    40: "Gate 40 seeks rest and reciprocity. You work hard and need true recognition and exchange.",
    41: "Gate 41 initiates dreams. You begin emotional journeys and inspire imaginative futures.",
    42: "Gate 42 completes what’s begun. You follow cycles to closure and growth.",
    43: "Gate 43 holds unique insight. You hear mental breakthroughs and speak future truths.",
    44: "Gate 44 recognizes patterns and memory. You sense who’s trustworthy through instinct.",
    45: "Gate 45 is the gate of the monarch. You lead and share from a place of material stewardship.",
    46: "Gate 46 is the love of the body and embodiment. You shine when grounded and aligned in presence.",
    47: "Gate 47 processes confusion into realization. You make meaning through reflection.",
    48: "Gate 48 holds depth and solutions. You have wisdom that emerges with time and trust.",
    49: "Gate 49 revolts against the outdated. You’re loyal until your values are violated.",
    50: "Gate 50 governs values and caretaking. You preserve what supports life and harmony.",
    51: "Gate 51 shocks into awakening. You carry energy that disrupts in service of truth.",
    52: "Gate 52 brings stillness and focus. You know when to pause and where to concentrate energy.",
    53: "Gate 53 begins cycles. You’re a starter who feels the pulse of new growth.",
    54: "Gate 54 is ambition aligned with spirit. You rise when your drive is rooted in deeper purpose.",
    55: "Gate 55 holds faith and emotional spirit. You fluctuate but teach freedom through emotional sovereignty.",
    56: "Gate 56 tells stories and weaves meaning. You entertain, teach, and inspire with your voice.",
    57: "Gate 57 is intuitive clarity. You sense the truth in the now with piercing awareness.",
    58: "Gate 58 brings joyful correction. You push for improvement with vitality and hope.",
    59: "Gate 59 breaks barriers for intimacy. You initiate closeness and bring others into union.",
    60: "Gate 60 accepts limitation as a portal. You honor structure and birth innovation from constraint.",
    61: "Gate 61 asks the unanswerable. You dwell in mystery and transmit hidden truths.",
    62: "Gate 62 brings order through detail. You translate concepts into understandable pieces.",
    63: "Gate 63 questions for clarity. You doubt with purpose — to verify and discern.",
    64: "Gate 64 imagines through confusion. You hold visions that arrive in poetic fragments."
}

# ---------------- FULL TRANSIT MEANINGS MAP ------------------
transit_meanings = {
    "Sun conjunct": {
        "theme": "identity spotlight, personal emergence",
        "guidance": "This is your time to shine — embrace visibility, but lead with integrity."
    },
    "Sun square": {
        "theme": "ego tension, purpose challenges",
        "guidance": "Identity clashes may arise — confront them with courage and humility."
    },
    "Sun opposition": {
        "theme": "mirrors of self, recalibration",
        "guidance": "Others reflect who you're becoming — use contrast to refine your purpose."
    },
    "Sun trine": {
        "theme": "flow in self-expression",
        "guidance": "Your essence flows more easily now — make progress in what lights you up."
    },
    "Sun aspecting": {
        "theme": "subtle self-activation",
        "guidance": "Quiet cues about your purpose emerge — stay alert to inner nudges."
    },

    "Moon conjunct": {
        "theme": "emotional sensitivity, personal tides",
        "guidance": "Feelings rise to the surface — nurture your needs and tend to your roots."
    },
    "Moon square": {
        "theme": "emotional friction, reactive patterns",
        "guidance": "This is a time to investigate your triggers — what needs soothing or release?"
    },
    "Moon opposition": {
        "theme": "relational emotional insight",
        "guidance": "Watch how others stir emotion — their role is to reveal your own inner waves."
    },
    "Moon trine": {
        "theme": "emotional ease and alignment",
        "guidance": "Your intuition and mood flow — trust your gut and connect with care."
    },
    "Moon aspecting": {
        "theme": "background emotional influence",
        "guidance": "Subtle inner tides influence your choices — give space for reflection."
    },

    "Mercury conjunct": {
        "theme": "mental clarity, communication upgrades",
        "guidance": "Your ideas want to be expressed — speak, write, or share with intention."
    },
    "Mercury square": {
        "theme": "mental tension, crossed signals",
        "guidance": "Misunderstandings may arise — clarify, slow down, and double-check."
    },
    "Mercury opposition": {
        "theme": "mental reflection, opposing views",
        "guidance": "Listen more than you speak — what you resist may teach you something vital."
    },
    "Mercury trine": {
        "theme": "ease in thinking and connection",
        "guidance": "This is a great time to pitch, plan, or collaborate — communication flows."
    },
    "Mercury aspecting": {
        "theme": "subtle mental shifts",
        "guidance": "Small messages carry meaning — journal your thoughts and dreams."
    },

    "Venus conjunct": {
        "theme": "love and beauty amplified",
        "guidance": "Enjoy romance, creativity, and self-love — the heart is awake."
    },
    "Venus square": {
        "theme": "relationship friction, value tests",
        "guidance": "What you love may challenge you now — reflect on true worth and balance."
    },
    "Venus opposition": {
        "theme": "desire vs. compromise",
        "guidance": "Opposites attract or repel — assess what’s drawing or draining you."
    },
    "Venus trine": {
        "theme": "flow in attraction and harmony",
        "guidance": "Love, beauty, and connection come naturally — open up to receive."
    },
    "Venus aspecting": {
        "theme": "subtle heart influences",
        "guidance": "Your values shift gently — honor beauty in small moments."
    },

    "Mars conjunct": {
        "theme": "energy surge, action ignition",
        "guidance": "Move boldly — initiate something that reflects your will and desire."
    },
    "Mars square": {
        "theme": "anger triggers, action tension",
        "guidance": "Confrontation can lead to clarity — but pause before reacting."
    },
    "Mars opposition": {
        "theme": "external push for change",
        "guidance": "Challenges may come from others — stand your ground but choose your battles."
    },
    "Mars trine": {
        "theme": "energized momentum",
        "guidance": "Progress flows — use this for physical goals, motivation, or breakthroughs."
    },
    "Mars aspecting": {
        "theme": "low-key motivation",
        "guidance": "Quiet energy stirs within — find your fire without burning out."
    },

    "Jupiter conjunct": {
        "theme": "expansion and optimism",
        "guidance": "Opportunities arise — say yes, but don’t overextend."
    },
    "Jupiter square": {
        "theme": "excess vs. wisdom",
        "guidance": "Growth comes through restraint — don’t mistake indulgence for progress."
    },
    "Jupiter opposition": {
        "theme": "external expansion tests",
        "guidance": "What’s offered may not be aligned — discern your true path."
    },
    "Jupiter trine": {
        "theme": "luck and support",
        "guidance": "Fortune favors aligned action — take the leap where doors open."
    },
    "Jupiter aspecting": {
        "theme": "quiet blessings",
        "guidance": "Trust the undercurrent of growth — small steps matter now."
    },

    "Saturn conjunct": {
        "theme": "serious alignment, karmic weight",
        "guidance": "Responsibility calls — show up with maturity and commitment."
    },
    "Saturn square": {
        "theme": "limits and lessons",
        "guidance": "Delays or blocks may frustrate — see them as growth rituals."
    },
    "Saturn opposition": {
        "theme": "external accountability",
        "guidance": "You may be held to a standard — lead with integrity."
    },
    "Saturn trine": {
        "theme": "stable foundations",
        "guidance": "Long-term efforts yield rewards — invest in what endures."
    },
    "Saturn aspecting": {
        "theme": "soft structure support",
        "guidance": "Your inner discipline whispers — listen to your wise voice."
    },

    "Uranus conjunct": {
        "theme": "shock, breakthrough, surprise",
        "guidance": "Change comes fast — stay adaptable and open to the unexpected."
    },
    "Uranus square": {
        "theme": "revolt or renewal",
        "guidance": "If something breaks, it was unstable — embrace freedom over comfort."
    },
    "Uranus opposition": {
        "theme": "forced liberation",
        "guidance": "You may outgrow old structures — don’t cling to what's crumbling."
    },
    "Uranus trine": {
        "theme": "sudden insight, easeful change",
        "guidance": "Innovative ideas land easily — move with intuitive upgrades."
    },
    "Uranus aspecting": {
        "theme": "underlying disruptions",
        "guidance": "Something’s shifting quietly — stay curious, not controlling."
    },

    "Neptune conjunct": {
        "theme": "dreams and dissolution",
        "guidance": "Mystery deepens — avoid delusion, and anchor in what’s real."
    },
    "Neptune square": {
        "theme": "confusion or spiritual test",
        "guidance": "If things feel foggy, pause — clarity follows surrender."
    },
    "Neptune opposition": {
        "theme": "illusion or inspiration",
        "guidance": "Others may mirror fantasy — ask what’s being idealized."
    },
    "Neptune trine": {
        "theme": "creative flow, intuition",
        "guidance": "Let art, dreams, or meditation guide your next steps."
    },
    "Neptune aspecting": {
        "theme": "subtle inner messages",
        "guidance": "You’re receiving intuitive pings — listen gently, not analytically."
    },

    "Pluto conjunct": {
        "theme": "deep transformation",
        "guidance": "Old identities die — this is a power reclamation."
    },
    "Pluto square": {
        "theme": "power struggle, shadow surfacing",
        "guidance": "Face your fears — you’re strong enough to transmute them."
    },
    "Pluto opposition": {
        "theme": "externalized power dynamics",
        "guidance": "Be mindful of projection and control — transformation requires surrender."
    },
    "Pluto trine": {
        "theme": "easeful renewal",
        "guidance": "You’re transforming with grace — integrate the lessons."
    },
    "Pluto aspecting": {
        "theme": "quiet rebirth",
        "guidance": "You're shifting beneath the surface — honor what’s dying and what’s being born."
    }
}

transit_meanings = {k.lower(): v for k, v in transit_meanings.items()}

    #-------------MOON PHASES---------------

MOON_PHASE_ICONS = {
    "New": "🌑",
    "Waxing": "🌓",
    "Full": "🌕",
    "Waning": "🌗"
}


    #-------------CHINESE ZODIAC---------------

chinese_zodiac_profiles = {
    "Rat": {
        "relationships": "Charming and clever, you engage partners with wit but may avoid emotional depth when stressed.",
        "career": "You’re strategic and resourceful — excelling in planning and negotiation.",
        "money": "You tend to be frugal and financially shrewd, often building wealth quietly.",
        "family": "You’re protective and clever, often taking on a planning or mentoring role."
    },
    "Ox": {
        "relationships": "Dependable and devoted, you show love through consistency, though change can challenge you.",
        "career": "Hardworking and persistent, you excel when routine and perseverance are valued.",
        "money": "You value long-term security and avoid unnecessary risks.",
        "family": "You’re steady and supportive — a calming presence in the home."
    },
    "Tiger": {
        "relationships": "Passionate and independent, you need space and stimulation in relationships.",
        "career": "You’re bold and competitive — excelling in leadership or risk-based ventures.",
        "money": "You’re a spender when inspired, but can generate wealth quickly.",
        "family": "You bring energy and edge, and fiercely protect loved ones."
    },
    "Rabbit": {
        "relationships": "Gentle and romantic, you avoid conflict but can withdraw emotionally under pressure.",
        "career": "You’re calm and elegant — excelling in diplomacy, design, or support roles.",
        "money": "You’re careful with spending and prefer emotional security over status.",
        "family": "You create harmony, but may struggle with confrontation or chaos."
    },
    "Dragon": {
        "relationships": "Charismatic and intense, you crave admiration but may dominate emotionally.",
        "career": "Powerful and visionary, you thrive in leadership, fame, or innovation.",
        "money": "You’re driven to create wealth, often through big risk or ambition.",
        "family": "You inspire and lead — often the source of drama and direction."
    },
    "Snake": {
        "relationships": "Mysterious and wise, you move slowly in love but commit deeply.",
        "career": "Strategic and refined, you thrive where insight and privacy matter.",
        "money": "You use money carefully — investing in security or beauty.",
        "family": "You bring emotional intelligence but may keep secrets to protect yourself."
    },
    "Horse": {
        "relationships": "Lively and freedom-seeking, you love quickly but hate being trapped.",
        "career": "Energetic and adventurous, you excel in travel, sales, or entrepreneurship.",
        "money": "You’re spontaneous with money — it comes and goes fast.",
        "family": "You’re fun and uplifting, though long-term domesticity can feel limiting."
    },
    "Goat": {
        "relationships": "Tender and artistic, you seek emotional connection but avoid conflict.",
        "career": "Creative and intuitive, you thrive in the arts or service roles.",
        "money": "You may overspend emotionally but are generous and kind.",
        "family": "You bring softness and sentiment — often the emotional heart of the family."
    },
    "Monkey": {
        "relationships": "Playful and clever, you need novelty and connection but may avoid emotional responsibility.",
        "career": "Inventive and persuasive, you’re strong in tech, media, or marketing.",
        "money": "You like fast money — smart, flexible, and opportunistic.",
        "family": "You bring laughter and ideas, often shaking up routines."
    },
    "Rooster": {
        "relationships": "Proud and articulate, you offer loyalty but may appear critical or perfectionistic.",
        "career": "Disciplined and precise, you shine in planning, organization, or systems work.",
        "money": "You’re tidy with money and often invest in your appearance or tools.",
        "family": "You offer high standards and protection — sometimes strict, always loyal."
    },
    "Dog": {
        "relationships": "Loyal and loving, you value trust and truth — but need reassurance to feel safe.",
        "career": "Ethical and just, you excel where service, law, or teamwork matters.",
        "money": "You’re cautious but generous when you care.",
        "family": "You’re a protector and moral compass — always there when it counts."
    },
    "Pig": {
        "relationships": "Gentle and romantic, you give your heart easily and enjoy comfort and devotion.",
        "career": "Sincere and hardworking, you do well in wellness, art, or culinary fields.",
        "money": "You appreciate luxury, and may need help with financial boundaries.",
        "family": "You nurture deeply — often putting others’ happiness before your own."
    }
}
    #-------------HUMAN DESIGN---------------
human_design_profiles = {
    "Generator": {
        "relationships": "You thrive when your energy is reciprocated and your passions are shared. You're magnetic when following your joy, but may struggle if you're constantly giving without satisfaction.",
        "career": "You bring sustainable energy to work that excites you. When you're lit up by a project, you become an unstoppable force.",
        "money": "Your financial success flows best when you're responding to opportunities that feel right — not chasing or initiating out of pressure.",
        "family": "You're a stabilizing force, often anchoring the household with consistent energy and grounded presence."
    },
    "Manifestor": {
        "relationships": "You value freedom and self-direction. You may struggle with control or initiating too much in emotional spaces, but you're bold and impactful when in alignment.",
        "career": "You're a visionary who initiates change — best when given independence and authority to lead.",
        "money": "Financial success comes when you act on your inner urges and avoid waiting for permission.",
        "family": "You may challenge norms in your family dynamic — sometimes misunderstood, always forging your own path."
    },
    "Projector": {
        "relationships": "You're designed to wait for recognition — which can feel passive, but leads to the most aligned connections. You read people deeply and need invitations to engage intimately.",
        "career": "You thrive in guiding roles, offering wisdom more than output. Success finds you when you're seen, not when you hustle.",
        "money": "Success comes through alignment and being invited to the right places. Burnout happens when you chase results.",
        "family": "You hold a unique energetic sensitivity — often sensing what others miss, and needing rest and space to reset."
    },
    "Reflector": {
        "relationships": "You're a mirror for your environment — fluid and perceptive. Relationships must feel energetically clean and emotionally safe for you to thrive.",
        "career": "You're most powerful when sampling many environments and offering deep insight — not conforming to standard roles.",
        "money": "Your relationship with money changes over time. Clarity emerges when you honor your cycles.",
        "family": "You reflect the energy of your household. When family is harmonious, you're radiant. When it's tense, you absorb the turbulence."
    },
    "Manifesting Generator": {
        "relationships": "Fast-moving and multifaceted, you love with intensity and changeability. You need freedom and stimulation in love, or you'll lose interest.",
        "career": "You're built for efficiency and innovation — thriving when you pivot often and respond to aligned opportunities.",
        "money": "You attract prosperity through doing what lights you up — and doing it fast.",
        "family": "You bring vitality and variety to your family dynamic, but may need flexibility to feel connected."
    }
}
    #-------------SUN SIGNS---------------
sun_sign_profiles = {
    "Aries": {
        "relationships": "Bold and direct, you lead with passion but must watch for impatience or dominance in love.",
        "career": "You excel in fast-paced environments where courage and leadership matter.",
        "money": "You’re impulsive with spending but driven to earn independently.",
        "family": "You take initiative and protect those you love fiercely."
    },
    "Taurus": {
        "relationships": "Loyal and affectionate, you seek stability and sensuality but may resist change.",
        "career": "Reliable and grounded, you excel where patience and consistency are valued.",
        "money": "Security-minded, you prefer tangible assets and saving long-term.",
        "family": "You provide grounding and comfort, often becoming the emotional and physical rock."
    },
    "Gemini": {
        "relationships": "Playful and curious, you crave mental stimulation but may struggle with consistency.",
        "career": "You shine in roles that allow flexibility, communication, and variety.",
        "money": "You approach money lightly — it’s a means to explore, not accumulate.",
        "family": "You keep things lively, and may juggle many family dynamics at once."
    },
    "Cancer": {
        "relationships": "Deeply nurturing, you form strong bonds and seek emotional safety.",
        "career": "You’re compassionate and protective, ideal for caregiving or emotionally intelligent roles.",
        "money": "You save for security and family, not status.",
        "family": "Home is everything — you hold tradition and family ties close."
    },
    "Leo": {
        "relationships": "Warm and generous, you lead with your heart and love being adored.",
        "career": "You command attention and do well where you’re seen and appreciated.",
        "money": "You spend to celebrate — but you also know how to attract wealth.",
        "family": "You’re the shining center of your family, bringing joy and drama."
    },
    "Virgo": {
        "relationships": "Caring and attentive, you show love through practical acts, but may seem overly critical.",
        "career": "Detail-oriented and service-driven, you thrive where precision matters.",
        "money": "You manage money carefully and efficiently.",
        "family": "You’re the organizer and quiet caretaker — always noticing what needs fixing."
    },
    "Libra": {
        "relationships": "Romantic and thoughtful, you seek balance, but may avoid conflict too much.",
        "career": "You do well in diplomacy, design, or partnership-based roles.",
        "money": "You enjoy beauty and harmony — your spending reflects your aesthetic.",
        "family": "You maintain peace and fairness in the household, sometimes at your own expense."
    },
    "Scorpio": {
        "relationships": "Intense and loyal, you connect deeply but guard your vulnerability.",
        "career": "You excel where strategy, depth, or transformation is needed.",
        "money": "You use money as a tool of power and security.",
        "family": "You’re protective and private — family loyalty runs deep."
    },
    "Sagittarius": {
        "relationships": "Adventurous and free-spirited, you need space and honesty in love.",
        "career": "You thrive in roles with travel, philosophy, or growth.",
        "money": "You may spend freely to expand experience.",
        "family": "You inspire your family with vision, but may resist routine."
    },
    "Capricorn": {
        "relationships": "Steady and committed, you show love through dedication and building a future.",
        "career": "Ambitious and structured, you thrive in responsibility and leadership.",
        "money": "You are strategic and long-term focused with wealth.",
        "family": "You may be the backbone — teaching discipline and legacy."
    },
    "Aquarius": {
        "relationships": "Unconventional and intellectual, you value friendship and freedom in love.",
        "career": "You shine in innovation, tech, or social change roles.",
        "money": "You can be detached from materialism, but care about causes.",
        "family": "You challenge traditions, helping the family evolve and think differently."
    },
    "Pisces": {
        "relationships": "Dreamy and sensitive, you crave soul-deep connection but may idealize partners.",
        "career": "Creative and empathic, you do best in artistic or healing fields.",
        "money": "You may be inconsistent, valuing experience over savings.",
        "family": "You bring compassion and emotional healing, often acting as the family empath."
    }
}
    #-------------NUMEROLOGY---------------
life_path_profiles = {
    "1": {
        "relationships": "You value independence and strength in relationships, often leading or protecting those you love.",
        "career": "Ambitious and driven, you’re a natural leader who thrives when creating your own path.",
        "money": "You pursue financial independence and often see money as a tool for autonomy.",
        "family": "You may play the role of protector or provider, taking responsibility seriously."
    },
    "2": {
        "relationships": "You seek harmony and connection, and are deeply attuned to your partner’s needs.",
        "career": "You work best in partnerships or supportive roles where emotional intelligence matters.",
        "money": "You value shared financial goals and tend to avoid financial conflict.",
        "family": "You often become the emotional glue in families, smoothing over conflicts with empathy."
    },
    "3": {
        "relationships": "Charming and expressive, you bring joy and creativity but may avoid emotional heaviness.",
        "career": "You excel in communication, media, or any role that lets your self-expression shine.",
        "money": "You’re optimistic and generous, though long-term planning may be a growth edge.",
        "family": "You keep things light and fun, often lifting the energy of those around you."
    },
    "4": {
        "relationships": "You offer loyalty and steadiness, and expect the same in return.",
        "career": "Hardworking and reliable, you shine in structured environments.",
        "money": "You save carefully, preferring predictable security over risk.",
        "family": "You create a solid and dependable foundation — a rock for others."
    },
    "5": {
        "relationships": "Adventurous and curious, you seek freedom and stimulation in relationships.",
        "career": "Dynamic and adaptable, you thrive where variety and movement are constant.",
        "money": "You may take financial risks or value money for the freedom it offers.",
        "family": "You challenge norms and may struggle with conventional roles, but offer perspective and playfulness."
    },
    "6": {
        "relationships": "Devoted and nurturing, you often take responsibility for the wellbeing of others.",
        "career": "Service-oriented and loyal, you do best in roles that feel meaningful and moral.",
        "money": "You use money to provide stability and support for others.",
        "family": "You are the caregiver — always making sure others are safe and loved."
    },
    "7": {
        "relationships": "You need solitude and deep connection. Emotional intimacy takes time and trust.",
        "career": "Analytical and spiritual, you excel in research or roles that require inner reflection.",
        "money": "You’re thoughtful about money and may use it to build independence and insight.",
        "family": "You may seem distant but offer quiet wisdom and space for growth."
    },
    "8": {
        "relationships": "You’re protective and powerful, seeking loyalty and strength in a partner.",
        "career": "Born to lead, you excel in business, finance, or any realm where results matter.",
        "money": "You pursue wealth to gain influence and ensure stability.",
        "family": "You set standards high and expect others to rise to meet them, often as a provider."
    },
    "9": {
        "relationships": "You bring empathy and wisdom, often giving more than you receive.",
        "career": "You’re drawn to humanitarian work or anything with purpose and heart.",
        "money": "You use money to support causes or those in need, not for status.",
        "family": "You’re compassionate and forgiving, always seeking harmony."
    },
    "11": {
        "relationships": "Spiritually attuned, you seek soulful connection but may feel overwhelmed by intensity.",
        "career": "You’re a visionary — idealistic and creative, but must manage emotional ups and downs.",
        "money": "You may have a complex relationship with money, seeing it as energy or responsibility.",
        "family": "You may feel both devoted and energetically sensitive to family roles."
    },
    "22": {
        "relationships": "You balance practicality with idealism, often mentoring or grounding others emotionally.",
        "career": "You’re a master builder — great at bringing big visions to life.",
        "money": "You use resources wisely, often investing in long-term structures.",
        "family": "You take on major roles in supporting or shaping the family legacy."
    }
}
    #-------------ENNEAGRAM---------------
enneagram_profiles = {
    "Type 1": {
        "relationships": "You bring integrity and structure, but may struggle with self-criticism or expecting perfection from others.",
        "career": "Principled and responsible, you aim to improve systems but can be rigid when under pressure.",
        "money": "Disciplined with finances, you value ethical spending and fairness.",
        "family": "A moral compass within the family unit, you lead by example and value tradition."
    },
    "Type 2": {
        "relationships": "Warm and generous, you express love through acts of service but may neglect your own needs.",
        "career": "Supportive and people-focused, you thrive in nurturing roles but risk burnout if boundaries aren’t clear.",
        "money": "Often generous, your spending may prioritize others over yourself.",
        "family": "You create emotional glue in families, often taking on caregiver roles instinctively."
    },
    "Type 3": {
        "relationships": "Charming and ambitious, you attract admiration but may struggle to reveal your true self emotionally.",
        "career": "Driven and image-conscious, you excel in goal-oriented roles but must balance authenticity with success.",
        "money": "Financial success may be tied to self-worth; status and results matter.",
        "family": "You may feel pressure to perform or appear accomplished, even within close relationships."
    },
    "Type 4": {
        "relationships": "Romantic and emotionally rich, you crave depth and uniqueness but may battle envy or emotional intensity.",
        "career": "Creative and insightful, you thrive when work has personal meaning.",
        "money": "You may use spending for emotional expression or escape.",
        "family": "You value emotional authenticity and may challenge surface-level family dynamics."
    },
    "Type 5": {
        "relationships": "Private and thoughtful, you build trust slowly and need space to feel safe emotionally.",
        "career": "Independent and cerebral, you shine in research or systems work.",
        "money": "You value self-sufficiency and security, often saving rather than spending.",
        "family": "Boundaries are essential; you show care through information or quiet support."
    },
    "Type 6": {
        "relationships": "Loyal and devoted, you seek consistency but may struggle with fear or doubt.",
        "career": "Responsible and collaborative, you shine in team settings where trust matters.",
        "money": "Security-focused, you likely plan carefully and avoid risk.",
        "family": "You anchor the family through consistency and protective energy."
    },
    "Type 7": {
        "relationships": "Energetic and optimistic, you bring fun and spontaneity, but may resist emotional heaviness.",
        "career": "Multi-talented and future-focused, you’re great at brainstorming and innovation.",
        "money": "Money is a tool for freedom and adventure, not hoarding.",
        "family": "You’re the spark that brings joy, though consistency may be your growth edge."
    },
    "Type 8": {
        "relationships": "Passionate and protective, you love fiercely but may struggle with control or vulnerability.",
        "career": "Commanding and strategic, you thrive where strength and vision are needed.",
        "money": "You view wealth as power and security, and prefer independence.",
        "family": "You guard your loved ones with intensity and lead with boldness."
    },
    "Type 9": {
        "relationships": "Calm and accepting, you foster peace but may suppress your own needs to avoid conflict.",
        "career": "Steady and diplomatic, you bridge gaps and bring people together.",
        "money": "You prefer simplicity and avoid drama with finances.",
        "family": "You’re the emotional anchor, harmonizing the household gently."
    }
}

    # ---- Shadow Work Action Library Sun Signs----

shadow_work_library = {
    "SunSigns": {
        "Aries": {
            "shadow": (
                "Aries energy is fiery, fast, and fiercely independent. But in shadow, this can lead to impulsivity, reactivity, and a sense of needing to prove oneself through action. "
                "Anger may mask vulnerability. Aries often pushes forward before assessing emotional consequences — mistaking momentum for growth. Shadow work means learning to pause, to process, and to let others lead at times. "
                "True courage sometimes means holding still when every instinct says to rush ahead."
            ),
            "journal_prompts": [
                "When was the last time I acted before thinking, and what were the results?",
                "How does my need to be first or right affect my relationships?",
                "Where am I avoiding stillness because it makes me uncomfortable?",
                "What does anger usually protect me from feeling?",
                "How can I practice courage through patience?",
                "In what ways do I associate slowness with weakness?",
                "Where do I struggle to let others take the lead?",
                "What am I proving — and to whom?",
                "How does my body feel when I slow down my decisions?",
                "Where do I rush through life instead of sitting with uncertainty?",
                "What messages did I receive about vulnerability growing up?",
                "How can I channel my fire into something sustainable today?"
            ],
            "celebration_prompts": [
                "When was the last time my boldness led to a breakthrough?",
                "What makes my passion contagious to others?",
                "How does my confidence inspire those around me?",
                "What’s something brave I’ve done that I’m proud of?",
                "How do I show up with leadership even when afraid?",
                "What challenges have I charged into — and emerged stronger from?",
                "How do I embody authentic courage in my life?",
                "Who has benefited from my ability to take initiative?",
                "What fires me up in a way that’s healthy and expansive?",
                "What makes my energy magnetic to others?",
                "How do I stay true to myself in a world that rewards conformity?",
                "How does my assertiveness open doors for others?"
            ]
        },
        "Taurus": {
            "shadow": (
                "Taurus energy is grounding and persistent, but in shadow, it can harden into stubbornness, resistance to change, and over-attachment to comfort. "
                "You may cling to routines, relationships, or beliefs long past their expiration — all in the name of safety. True growth requires you to loosen your grip, even when the unknown feels threatening."
            ),
            "journal_prompts": [
                "Where in my life am I clinging to something simply because it’s familiar?",
                "How do I respond to unexpected change?",
                "What does comfort mean to me — and when does it become limiting?",
                "Where am I confusing security with stagnation?",
                "What fear arises when I consider trying something new?",
                "In what ways do I resist feedback or other perspectives?",
                "Where do I equate control with safety?",
                "What routines feel nourishing vs. numbing?",
                "How does my body react when I’m pushed outside my comfort zone?",
                "How do I handle loss or endings?",
                "What belief am I holding onto that no longer feels alive?",
                "How can I create groundedness without becoming immobile?"
            ],
            "celebration_prompts": [
                "What do I love most about my loyalty and consistency?",
                "When have I provided calm and stability for someone else?",
                "How does my presence soothe others?",
                "What have I cultivated slowly and patiently?",
                "How do I honor beauty and the senses in my daily life?",
                "What’s a strength I bring through my grounded nature?",
                "When did I remain steady through someone else’s chaos?",
                "How do I invest deeply in people or projects that matter to me?",
                "What values do I embody just by being myself?",
                "What part of my life feels truly rooted right now?",
                "How do I express love through practical action?",
                "What brings me simple, consistent joy?"
            ]
        },
        "Gemini": {
            "shadow": (
                "Gemini’s gift is curiosity and adaptability — but in shadow, this becomes distraction, inconsistency, and emotional avoidance through constant movement or talk. "
                "You may shift identities to mirror others or over-intellectualize feelings to stay safe. Real integration comes when you slow down, stay present, and speak from your core instead of your head."
            ),
            "journal_prompts": [
                "Where in my life do I feel scattered — and why?",
                "What am I avoiding by staying busy or entertained?",
                "How often do I speak before I really feel something?",
                "Where do I struggle to stay present with discomfort?",
                "How do I react when silence enters a conversation?",
                "What identities do I shift into depending on who I’m around?",
                "What deeper truth have I been avoiding by staying in my head?",
                "How does my curiosity sometimes keep me from commitment?",
                "Where do I fear being seen as boring or predictable?",
                "How can I bring more intentionality to my communication?",
                "What emotions feel hardest to name or sit with?",
                "Where might I be skimming the surface instead of going deep?"
            ],
            "celebration_prompts": [
                "What makes my perspective flexible and open?",
                "How do I bring playfulness and levity into hard moments?",
                "When has my curiosity led to something beautiful?",
                "What conversations have changed someone’s life — or mine?",
                "How do I connect people or ideas in innovative ways?",
                "When have I stayed open when others shut down?",
                "What have I learned recently that lit me up?",
                "How does my adaptability serve my relationships?",
                "What unique connections do I make naturally?",
                "What have I taught someone without even trying?",
                "Where have I embraced duality instead of choosing a side?",
                "What do people admire about my communication style?"
            ]
        },
        "Cancer": {
         "shadow": (
             "Cancer's deep emotional sensitivity becomes a protective shell when wounded. The shadow of Cancer clings to the past, over-nurtures to feel needed, or retreats when vulnerability feels unsafe. "
             "There can be resentment when care isn’t returned. True growth invites open receiving, emotional honesty, and the courage to let others care for you."
         ),
         "journal_prompts": [
             "When do I give care hoping to be needed?",
             "How do I react when my emotional needs aren’t met?",
             "What part of my past am I still emotionally protecting?",
             "Where do I fear being too much emotionally?",
             "What does emotional safety look like to me?",
             "When have I withdrawn instead of expressing myself?",
             "How do I nurture without self-sacrifice?",
             "What stories from childhood still shape how I connect?",
             "Where do I feel unappreciated — and have I voiced it?",
             "How do I protect myself from being hurt again?",
             "How do I know when I’m caring out of fear vs love?",
             "What would it look like to ask for support today?"
         ],
         "celebration_prompts": [
             "What’s one way I show up as a safe space for others?",
             "How does my emotional attunement help me lead with heart?",
             "What have I built or protected that nurtures others?",
             "How do I honor and remember the people I love?",
             "What rituals or routines bring me comfort?",
             "When have I let my emotions guide me wisely?",
             "What’s something tender about me that I’m proud of?",
             "How do I create warmth in my home or relationships?",
             "What makes my sensitivity a strength?",
             "When did my empathy make a meaningful impact?",
             "How do I express love without words?",
             "What part of my inner world is most beautiful?"
        ]
        },
        "Leo": {
            "shadow": (
                "Leo thrives on expression, joy, and recognition — but its shadow seeks validation over authenticity. When insecure, Leo may perform instead of connect, needing applause to feel loved. "
                "The true heart of Leo is generous and magnetic when grounded in self-worth. Shadow work means knowing you're enough without the spotlight."
            ),
            "journal_prompts": [
                "What do I do to gain attention or admiration?",
                "Where do I feel unseen or unappreciated?",
                "How do I react when I don’t feel validated?",
                "What part of me feels like it has to perform?",
                "Where do I fear being ordinary?",
                "When was the last time I expressed myself just for joy?",
                "What makes me worthy beyond what I produce or share?",
                "What is the difference between confidence and performance for me?",
                "What does being truly seen feel like?",
                "Where do I seek applause instead of intimacy?",
                "What creative impulse have I suppressed lately?",
                "How do I honor my heart’s truth even when no one is watching?"
            ],
            "celebration_prompts": [
                "What lights me up from the inside out?",
                "How do I shine naturally without trying?",
                "When has my confidence uplifted someone else?",
                "What’s one creative act I’m proud of?",
                "What makes my presence joyful to others?",
                "How do I express myself with heart?",
                "When have I led with courage and generosity?",
                "What does it feel like to be fully alive?",
                "What has my boldness made possible?",
                "Who has benefited from my warmth and loyalty?",
                "How do I radiate love even in tough moments?",
                "What makes me magnetic in an authentic way?"
            ]
        },
        "Virgo": {
            "shadow": (
                "Virgo is discerning, practical, and detail-oriented — but its shadow becomes critical, perfectionistic, or overly responsible. The urge to fix everything can become control. "
                "You may overwork to feel worthy, or struggle to rest unless everything’s resolved. Growth means accepting imperfection as part of wholeness — in yourself and others."
            ),
            "journal_prompts": [
                "Where do I set impossible standards for myself or others?",
                "How do I feel when things are messy or incomplete?",
                "When do I over-function for others?",
                "How does criticism show up in my inner voice?",
                "What does rest bring up for me emotionally?",
                "Where do I seek control to avoid vulnerability?",
                "How do I measure my worth — and is it fair?",
                "What am I constantly fixing instead of accepting?",
                "How does my need to be useful affect my relationships?",
                "What imperfection in myself am I learning to love?",
                "What does compassion look like in moments of failure?",
                "Where do I mistake efficiency for value?"
            ],
            "celebration_prompts": [
                "What systems or care practices have I created for others?",
                "What makes my eye for detail a gift?",
                "When have I made something better through thoughtful attention?",
                "How does my dedication create lasting impact?",
                "What’s one problem I solved in a practical, elegant way?",
                "How do I show love through acts of service?",
                "What makes me trustworthy in times of stress?",
                "How have I healed others through my care?",
                "What’s one routine that nourishes me deeply?",
                "When have I brought order to chaos?",
                "What does my integrity look like in action?",
                "How do I refine rather than perfect?"
            ]
        },
        "Libra": {
            "shadow": (
                "Libra values balance, beauty, and connection — but in shadow, it can avoid conflict, lose identity in relationships, or prioritize peace over truth. "
                "You may over-accommodate to be liked, or defer decisions out of fear of disharmony. True harmony is forged through honest presence, not constant appeasement."
            ),
            "journal_prompts": [
                "When have I said yes to avoid rocking the boat?",
                "Where do I hide my truth to be liked?",
                "How do I react to conflict — and why?",
                "What does people-pleasing cost me?",
                "Where do I fear being alone with my own needs?",
                "When have I silenced myself to keep peace?",
                "What relationships feel balanced vs. one-sided?",
                "How does indecision show up in my life?",
                "Where have I confused harmony with avoidance?",
                "How do I handle anger — my own or others’?",
                "What would radical honesty look like for me today?",
                "What does my inner equilibrium need right now?"
            ],
            "celebration_prompts": [
                "What makes my presence feel harmonious to others?",
                "How do I create beauty in my space or relationships?",
                "What’s one time I mediated or restored balance?",
                "How do I cultivate fairness in my choices?",
                "What values guide my sense of justice?",
                "What does elegance mean to me — and how do I embody it?",
                "How do I support connection between others?",
                "What’s one relationship I’ve deeply nurtured?",
                "What decisions have brought more peace to my life?",
                "How do I model grace under pressure?",
                "What’s one boundary I held kindly but clearly?",
                "How do I advocate with compassion?"
            ]
        },
        "Scorpio": {
            "shadow": (
                "Scorpio is intense, intuitive, and transformative — but its shadow hides pain beneath control, secrecy, or emotional withdrawal. "
                "You may test loyalty through distance or build walls where bridges could be. Healing means letting others see your depth without defensiveness. Vulnerability is not weakness — it’s power refined by truth."
            ),
            "journal_prompts": [
                "What do I keep hidden out of fear of judgment?",
                "When have I tested someone’s loyalty instead of expressing a need?",
                "How do I protect myself emotionally — and does it still serve me?",
                "Where do I hold grudges or struggle to forgive?",
                "What past wound am I still protecting?",
                "How does control show up in my relationships?",
                "Where am I afraid to be truly seen?",
                "What part of me do I deem ‘too much’ for others?",
                "How do I express anger — and what’s underneath it?",
                "When do I withhold instead of connect?",
                "What does healthy vulnerability feel like to me?",
                "How have I grown through emotional intensity?"
            ],
            "celebration_prompts": [
                "What truths have I faced that others might avoid?",
                "How has my emotional depth been a gift to others?",
                "What transformations have I undergone and survived?",
                "How do I intuitively understand what others feel?",
                "Where have I used pain as fuel for healing?",
                "What relationships feel honest and soul-deep?",
                "How do I protect what I value with fierce loyalty?",
                "What makes me emotionally fearless?",
                "What secrets have I turned into strength?",
                "What have I forgiven — and how did it change me?",
                "How do I guide others through the dark?",
                "What gives my intensity its power?"
            ]
        },
        "Sagittarius": {
            "shadow": (
                "Sagittarius is adventurous, visionary, and philosophical — but in shadow, can become escapist, arrogant, or resistant to commitment. "
                "You may chase freedom without noticing who you leave behind. Depth comes not from constant motion, but from presence. True expansion includes stillness."
            ),
            "journal_prompts": [
                "What do I avoid by staying in motion?",
                "Where do I fear being trapped — and is it real?",
                "When has restlessness kept me from intimacy?",
                "What belief do I defend even when it limits me?",
                "How do I respond to emotional demands from others?",
                "Where do I fear losing freedom in commitment?",
                "What am I running toward — or away from?",
                "How do I confuse movement with growth?",
                "What part of me wants to be fully rooted?",
                "Where does curiosity meet avoidance in my life?",
                "What truth do I know but avoid living?",
                "When have I fled instead of stayed to learn?"
            ],
            "celebration_prompts": [
                "What’s one idea or philosophy that’s changed my life?",
                "How have I inspired others to broaden their view?",
                "What’s one leap of faith I’m proud I took?",
                "Where has my optimism opened doors?",
                "How do I embody freedom in a healthy way?",
                "What’s something bold I said or did that felt true?",
                "Where have I bridged cultures, minds, or beliefs?",
                "How do I bring hope to challenging situations?",
                "What adventure helped me find part of myself?",
                "What do I see from the mountaintop that others miss?",
                "How do I live with purpose and play?",
                "What makes me a seeker of wisdom?"
            ]
        },
        "Capricorn": {
            "shadow": (
                "Capricorn builds, leads, and perseveres — but in shadow, it becomes rigid, overly self-reliant, and emotionally armored. "
                "You may associate worth with productivity or fear asking for help. Growth lies in softness, surrender, and the reminder that you are more than what you accomplish."
            ),
            "journal_prompts": [
                "What do I fear would happen if I stopped working?",
                "Where do I feel I must carry everything alone?",
                "How do I react to emotional vulnerability?",
                "What parts of me are buried beneath responsibility?",
                "Where am I withholding softness or affection?",
                "How do I define success — and is it my definition?",
                "When have I judged myself for needing support?",
                "What does trust mean to me — and how do I build it?",
                "What does rest mean in my life?",
                "How do I armor myself emotionally?",
                "What’s one area where I could delegate or release control?",
                "What legacy am I building — and for whom?"
            ],
            "celebration_prompts": [
                "What have I created through hard work and resilience?",
                "How do I show up when things get difficult?",
                "What responsibilities have I handled with quiet strength?",
                "What’s one structure I built that still stands strong?",
                "How do I lead by example?",
                "What makes me trustworthy in a crisis?",
                "What values drive my ambition?",
                "How do I honor tradition and vision at once?",
                "Who has benefited from my stability and grit?",
                "What’s something I built that I’m proud of?",
                "When did I overcome a mountain others wouldn’t attempt?",
                "What does discipline make possible in my life?"
            ]
        },
        "Aquarius": {
            "shadow": (
                "Aquarius brings innovation, vision, and intellectual clarity — but in shadow, it can detach from emotion, overanalyze, or resist closeness. "
                "You may fear losing identity in intimacy, or stay in your mind to avoid vulnerability. Healing means remembering that connection doesn’t require conformity — and feeling is part of freedom."
            ),
            "journal_prompts": [
                "Where do I withhold emotional closeness?",
                "When do I feel most disconnected — and why?",
                "What makes me uncomfortable about emotional expression?",
                "How do I react to others’ emotional needs?",
                "What does freedom mean in relationships?",
                "Where do I fear being ‘too much’ or ‘not enough’?",
                "What causes me to feel misunderstood?",
                "How do I balance independence with belonging?",
                "When have I felt alone in a crowd?",
                "What beliefs keep me distant from intimacy?",
                "Where do I hide in ideas instead of presence?",
                "What does emotional authenticity look like for me?"
            ],
            "celebration_prompts": [
                "What makes my vision ahead of its time?",
                "How do I challenge the status quo with purpose?",
                "Where have I broken free from limiting norms?",
                "What does it feel like to be fully myself?",
                "How do I bring people together around big ideas?",
                "What makes me a revolutionary thinker?",
                "What truths have I spoken bravely?",
                "What communities have I uplifted or helped reform?",
                "When have I held my own in the face of conformity?",
                "How do I love uniquely — and fully?",
                "What future am I helping to build?",
                "How do I honor both individuality and humanity?"
            ]
        },
        "Pisces": {
            "shadow": (
                "Pisces is empathetic, dreamy, and spiritually attuned — but in shadow, it dissolves into escapism, martyrdom, or emotional overwhelm. "
                "You may absorb others’ pain without boundaries, or retreat into fantasy to avoid reality. Growth means staying grounded while keeping your heart open — feeling everything without losing yourself."
            ),
            "journal_prompts": [
                "Where do I escape instead of face something hard?",
                "How do I blur boundaries in the name of love?",
                "What part of me longs to be rescued?",
                "Where do I carry emotions that aren’t mine?",
                "When have I sacrificed myself to avoid guilt?",
                "What illusions am I still holding onto?",
                "What does spiritual bypassing look like in my life?",
                "How do I respond to practical needs?",
                "Where can I show compassion *and* clarity?",
                "What do I need to forgive in myself?",
                "What’s the difference between sensitivity and victimhood for me?",
                "How can I stay soft without collapsing?"
            ],
            "celebration_prompts": [
                "What makes my imagination a superpower?",
                "How have I healed others with my presence alone?",
                "What beauty have I created or witnessed deeply?",
                "When have I trusted my intuition and been right?",
                "What does compassion look like in action for me?",
                "How do I honor the invisible threads that connect us?",
                "What’s something only I could have seen or understood?",
                "How do I nurture magic in the mundane?",
                "Where have I shown mercy others wouldn’t?",
                "What makes me a dreamer the world needs?",
                "How do I hold space for others’ pain without judgment?",
                "What makes me most connected to the divine or universal?"
            ]
        }
     },
    "Chinese Zodiac": {
        "Rat": {
            "shadow": (
                "Rat energy is clever, strategic, and resourceful. But in shadow, it can become overly guarded, emotionally distant, or manipulative. "
                "You may avoid vulnerability by staying one step ahead of others, always calculating outcomes. True intimacy asks you to be present, not just prepared."
            ),
            "journal_prompts": [
                "Where do I withhold emotions to maintain control?",
                "What am I afraid will happen if I let someone see my true feelings?",
                "How does my need to be prepared keep me from being spontaneous?",
                "In what ways do I use charm to avoid deeper honesty?",
                "What would it mean to trust someone fully?",
                "Where do I fear being outsmarted — and how does that shape my relationships?",
                "What role has emotional safety played in my life?",
                "How can I tell the difference between intuition and suspicion?",
                "How do I use intellect to shield my heart?",
                "What situations make me feel emotionally exposed — and how do I handle them?"
            ],
            "celebration_prompts": [
                "What do I admire about my ability to adapt quickly?",
                "How has my cleverness helped others solve a problem?",
                "When have I used my mind to protect what matters most?",
                "How do I show up with loyalty, even if I don’t always say it aloud?",
                "What’s a time I used strategy to create a win for everyone?",
                "What makes my way of thinking unique?",
                "Where do I bring insight or foresight to a group?",
                "How has my ability to think ahead supported my goals?",
                "What do I treasure most about my resourcefulness?",
                "How does my presence make people feel understood or safe?"
            ]
        },
        "Ox": {
            "shadow": (
                "Ox energy is strong, dependable, and steady. In shadow, it can become rigid, resistant to change, and emotionally repressed. "
                "You may push through challenges without asking for help, believing it's a burden to rely on others. But strength also means allowing support."
            ),
            "journal_prompts": [
                "Where am I refusing help, even when I need it?",
                "How do I define strength — and is that definition serving me?",
                "What am I clinging to out of routine or fear of change?",
                "How does my loyalty sometimes trap me?",
                "When have I silenced my emotions to keep things stable?",
                "What part of my life needs more flexibility?",
                "What does it feel like to trust someone else with responsibility?",
                "Where do I equate vulnerability with weakness?",
                "What belief am I carrying that no longer supports who I’m becoming?",
                "What happens when I pause instead of pushing forward?"
            ],
            "celebration_prompts": [
                "What does my consistency allow others to depend on?",
                "When have I seen something through that others would’ve quit?",
                "How do I embody loyalty in my relationships?",
                "What do I love about my patience?",
                "What’s something I’ve built slowly that brings me pride?",
                "Where does my persistence shine brightest?",
                "How does my reliability comfort others?",
                "What makes me feel grounded and rooted?",
                "What values do I uphold through action rather than words?",
                "When have I stood firm in something important to me?"
            ]
        },
        "Tiger": {
            "shadow": (
                "Tiger energy is bold, passionate, and brave. In shadow, it can be reckless, confrontational, or unwilling to compromise. "
                "You may rush into action without considering consequences or resist vulnerability out of fear it dulls your power. True strength also listens."
            ),
            "journal_prompts": [
                "Where am I rushing ahead before assessing emotional impact?",
                "How do I respond when someone questions my decisions?",
                "What does vulnerability feel like in my body?",
                "When do I confuse control with leadership?",
                "Where has my boldness helped — and where has it hurt?",
                "How can I honor my instincts while creating space for others?",
                "Where do I fear being seen as weak?",
                "How do I act when I feel cornered emotionally?",
                "What role does impulsiveness play in my day-to-day life?",
                "What would it mean to slow down without losing power?"
            ],
            "celebration_prompts": [
                "What am I most proud of facing head-on?",
                "How has my bravery created change?",
                "What do I love about my boldness?",
                "When did I take a leap others were afraid to?",
                "How do I inspire others through action?",
                "What does power look like when I’m fully aligned?",
                "What gives me confidence even in the unknown?",
                "How do I protect those I love?",
                "What’s a risk I took that paid off?",
                "What fuels my courage at its best?"
            ]
        },
        "Rabbit": {
            "shadow": (
                "Rabbit energy is gentle, sensitive, and thoughtful — but in shadow, it can become overly avoidant, conflict-averse, and self-sacrificing. "
                "You may tiptoe around tension, hiding your truth to maintain peace. Growth comes when you trust that your voice is worth hearing, even if it ruffles feathers."
            ),
            "journal_prompts": [
                "When have I avoided speaking up to keep the peace?",
                "What situations make me shrink or stay silent?",
                "What do I fear will happen if I’m direct with others?",
                "Where do I suppress anger — and how does it resurface later?",
                "How do I protect others at my own expense?",
                "What boundaries do I struggle to hold?",
                "What do I need to feel safe expressing myself?",
                "What am I tolerating that quietly drains me?",
                "How do I confuse harmony with emotional suppression?",
                "Where have I mistaken silence for strength?"
            ],
            "celebration_prompts": [
                "When has my empathy helped someone feel seen?",
                "How do I bring softness into a harsh world?",
                "What do I appreciate about my emotional sensitivity?",
                "When did I create peace through compassion?",
                "What beauty have I nurtured in my environment or relationships?",
                "How do I protect others without even trying?",
                "What makes my presence feel calming?",
                "When have I used gentleness to disarm conflict?",
                "How do I honor kindness as a strength?",
                "What feels sacred about my way of moving through life?"
            ]
        },
        "Dragon": {
            "shadow": (
                "Dragon energy is powerful, visionary, and magnetic. In shadow, it may become domineering, prideful, or consumed by the need to win. "
                "You may fear failure so deeply that you try to control everything around you. True power includes softness, humility, and room for others to shine too."
            ),
            "journal_prompts": [
                "What does failure represent to me — and why do I fear it?",
                "Where am I trying to control outcomes rather than trusting the process?",
                "When do I equate being right with being worthy?",
                "How do I handle situations where I’m not in charge?",
                "Where do I struggle to share the spotlight?",
                "What’s underneath my need to be impressive?",
                "How do I respond when someone challenges my ideas?",
                "What do I need to feel safe letting go?",
                "When have I led from ego rather than vision?",
                "What does healthy power look like in my life?"
            ],
            "celebration_prompts": [
                "What’s one visionary idea I’ve brought into reality?",
                "Where has my boldness lifted others?",
                "How do I embody strength with grace?",
                "When did I use my power to protect someone vulnerable?",
                "How do I stay rooted in my sense of purpose?",
                "What’s something ambitious I dared to try — and succeeded?",
                "Where have I inspired others by simply being myself?",
                "What’s magnetic about my energy?",
                "When did I choose courage over comfort?",
                "What makes me a natural leader, even without trying?"
            ]
        },
        "Snake": {
            "shadow": (
                "Snake energy is wise, intuitive, and composed — but in shadow, it can become secretive, overly private, or emotionally withdrawn. "
                "You may hesitate to show your full self, fearing exposure. Real intimacy comes from being seen in your complexity, not just your poise."
            ),
            "journal_prompts": [
                "What do I hide, and why do I hide it?",
                "How do I respond when someone asks for emotional vulnerability?",
                "Where have I kept people at arm’s length — and at what cost?",
                "What am I protecting myself from by staying mysterious?",
                "Where does privacy serve me — and where does it isolate me?",
                "How do I respond to being misunderstood?",
                "What would it feel like to be fully seen and accepted?",
                "How can I let someone in without losing myself?",
                "What part of my emotional world do I rarely express?",
                "What scares me about being transparent?"
            ],
            "celebration_prompts": [
                "What makes my presence feel quietly powerful?",
                "How do I use wisdom to support others?",
                "When have I trusted my intuition — and been right?",
                "How does my calm center help during chaos?",
                "What do I appreciate about my ability to observe deeply?",
                "What have I transformed internally that others don’t know about?",
                "How do I lead through subtle influence?",
                "What makes me feel most in alignment with my truth?",
                "How do I balance thoughtfulness with instinct?",
                "What’s beautiful about the way I protect my peace?"
            ]
        },
        "Horse": {
            "shadow": (
                "Horse energy is spirited, adventurous, and dynamic. In shadow, it can become restless, avoidant, or easily bored. "
                "You may constantly seek stimulation, avoiding emotional depth or long-term commitments. Growth lies in learning to stay, even when things feel slow."
            ),
            "journal_prompts": [
                "What am I running from when I keep busy?",
                "Where in my life do I avoid commitment or consistency?",
                "How do I respond when things become emotionally intense?",
                "When have I sabotaged something by leaving too soon?",
                "What makes me fear slowing down?",
                "How can I stay present in moments that feel uncomfortable?",
                "Where do I confuse freedom with escape?",
                "What would devotion look like for me — in work or love?",
                "What have I avoided that actually deserves my energy?",
                "How do I respond to routine — and what stories do I attach to it?"
            ],
            "celebration_prompts": [
                "What adventure or risk am I most proud of taking?",
                "How does my passion inspire others to move or grow?",
                "What do I love about my ability to leap into life?",
                "How has my spontaneity opened doors?",
                "When have I stayed long enough to create something real?",
                "What makes me a natural catalyst for change?",
                "Where have I turned restlessness into creative momentum?",
                "How does my energy uplift my community or friends?",
                "What values keep me anchored even while in motion?",
                "How do I model bold living for others?"
            ]
        },
        "Goat": {
            "shadow": (
                "Goat energy is compassionate, artistic, and nurturing. In shadow, it may turn into martyrdom, indecision, or people-pleasing. "
                "You may struggle to say no, fearing rejection or guilt. True strength means holding your needs with the same care you offer others."
            ),
            "journal_prompts": [
                "Where do I say yes when I want to say no?",
                "What relationships feel emotionally uneven — and why do I stay?",
                "What part of me believes love must be earned through sacrifice?",
                "How do I respond to guilt, and how does it guide my choices?",
                "Where do I give more than I receive?",
                "What does it feel like to disappoint someone — and can I survive that?",
                "How do I define worth — mine and others’?",
                "Where in my life am I avoiding confrontation by over-accommodating?",
                "What is one truth I’ve been afraid to share?",
                "How can I set boundaries that still feel loving?"
            ],
            "celebration_prompts": [
                "When has my compassion made a real difference?",
                "How do I offer beauty or tenderness to the world?",
                "What do I love about my ability to nurture others?",
                "How have I created sanctuary — emotional or physical?",
                "What makes my sensitivity a superpower?",
                "When did I advocate for someone who couldn’t do it for themselves?",
                "How do I bring softness into a hard world?",
                "What does self-love look like in my life?",
                "When have I held space without needing to fix?",
                "What values guide my generosity?"
            ]
        },
        "Monkey": {
            "shadow": (
                "Monkey energy is clever, curious, and quick-witted. In shadow, it can manifest as trickery, evasion, or emotional detachment. "
                "You may use humor or intellect to deflect intimacy or responsibility. Growth means staying present — even when it’s not fun."
            ),
            "journal_prompts": [
                "What do I use humor to avoid?",
                "When have I distracted myself from emotional discomfort?",
                "Where do I change topics to dodge deeper conversations?",
                "How do I respond when others express pain?",
                "What part of me fears being pinned down?",
                "When have I overpromised and underdelivered — and why?",
                "How do I hide my true emotions behind charm?",
                "What’s uncomfortable about being fully honest?",
                "What role does play serve — and where does it become avoidance?",
                "What would it mean to let someone truly know me?"
            ],
            "celebration_prompts": [
                "How has my humor brought joy to others?",
                "What do I love about my quick mind?",
                "When has my flexibility saved the day?",
                "How do I make life lighter for those around me?",
                "What creative solutions am I proud of devising?",
                "What makes my presence engaging and magnetic?",
                "When have I used wit to build bridges?",
                "What surprises do I bring to people’s lives?",
                "How does curiosity keep me growing?",
                "What makes me uniquely inventive?"
            ]
        },
        "Rooster": {
            "shadow": (
                "Rooster energy is detail-oriented, hardworking, and principled. In shadow, it becomes critical, rigid, or performative. "
                "You may strive for perfection as a way to feel safe or superior. Growth lies in releasing control and trusting that your worth isn’t tied to how polished things look."
            ),
            "journal_prompts": [
                "What does perfection mean to me — and who taught me that?",
                "Where do I feel unsafe unless things are just right?",
                "How do I respond when others fall short of my standards?",
                "When have I chosen being right over being kind?",
                "What’s underneath my need to be seen as competent?",
                "Where do I judge myself most harshly?",
                "What would it feel like to let go — even a little?",
                "How do I handle failure — mine or others’?",
                "When do I mistake order for control?",
                "How can I honor effort over outcomes?"
            ],
            "celebration_prompts": [
                "What’s something I built with care and excellence?",
                "How does my eye for detail make others feel valued?",
                "What do I love about my discipline and work ethic?",
                "When have I stood up for integrity?",
                "How do I bring structure to chaos?",
                "What’s something beautiful about my devotion to improvement?",
                "How do I use feedback as a form of love?",
                "What routines help me stay grounded?",
                "Where do I model accountability for others?",
                "What makes me proud of how I show up every day?"
            ]
        },
        "Dog": {
            "shadow": (
                "Dog energy is loyal, protective, and just. In shadow, it can become overly self-sacrificing, suspicious, or burned out. "
                "You may give so much that you lose yourself. True devotion includes loyalty to your own well-being."
            ),
            "journal_prompts": [
                "Where do I put others’ needs above my own?",
                "What does loyalty mean to me — and when does it become a trap?",
                "When do I ignore red flags out of duty?",
                "How do I respond to betrayal or disappointment?",
                "What boundaries have I let erode for the sake of connection?",
                "How do I confuse love with obligation?",
                "What relationships feel one-sided?",
                "What would self-loyalty look like today?",
                "How do I hold resentment when I overgive?",
                "What stories do I carry about being the protector or savior?"
            ],
            "celebration_prompts": [
                "What relationship am I proud of nurturing?",
                "How do I show up for people when they need me?",
                "When have I stood for justice or truth?",
                "What do I love about my sense of duty?",
                "How has my integrity shaped my life?",
                "When have I been a steady force during chaos?",
                "What promises have I kept that changed lives?",
                "How does my loyalty create safety for others?",
                "When have I protected someone silently?",
                "What values guide how I love?"
            ]
        },
        "Pig": {
            "shadow": (
                "Pig energy is generous, joyful, and warmhearted. In shadow, it may become indulgent, naive, or escapist. "
                "You may avoid hard truths in favor of comfort, or give too much in hopes of being loved. Growth means practicing discernment and balance."
            ),
            "journal_prompts": [
                "Where do I overextend in order to be liked?",
                "What truths have I been avoiding?",
                "How do I handle discomfort — do I numb or indulge?",
                "Where in my life do I confuse pleasure with peace?",
                "What does healthy generosity look like?",
                "When do I give more than I actually have?",
                "How do I react when boundaries are asked of me?",
                "Where have I ignored red flags out of optimism?",
                "How can I stay present without escaping into fantasy?",
                "What do I need to feel safe being discerning?"
            ],
            "celebration_prompts": [
                "How do I create joy for others?",
                "What do I love about my open heart?",
                "How has my generosity helped someone in a real way?",
                "What feels sacred about my capacity to forgive?",
                "What moments of beauty have I amplified in others’ lives?",
                "When have I been a source of light for someone in darkness?",
                "How do I create abundance through attitude?",
                "What makes my warmth healing?",
                "What’s one thing I gave freely that I’m proud of?",
                "How do I remind others that softness is strength?"
            ]
        }
    },
    "LifePaths": {
        1: {
            "shadow": (
                "Life Path 1s are natural leaders, driven, independent, and often feel the need to prove themselves through accomplishment. In shadow, this can become isolation, stubbornness, and an unwillingness to collaborate. "
                "They may resist asking for help, fearing it shows weakness. The shadow work of a 1 lies in balancing independence with openness — knowing that true strength includes vulnerability and interdependence."
            ),
            "journal_prompts": [
                "Where in my life do I feel I must handle everything alone?",
                "What would asking for help look like — and why does that feel hard?",
                "When does my independence become a wall?",
                "Where have I rejected collaboration out of pride?",
                "What am I afraid might happen if I let others lead?",
                "How do I react to criticism or challenge?",
                "When do I push too hard without rest?",
                "What does 'proving myself' mean — and to whom?",
                "Where do I tie my worth to output or success?",
                "How can I lead from compassion rather than control?",
                "What does it mean to trust others with my vision?",
                "Where am I being invited to soften?"
            ],
            "celebration_prompts": [
                "What is something I’ve built from the ground up?",
                "When did I show leadership that changed the course of something?",
                "What am I most proud of accomplishing solo?",
                "How does my drive serve those around me?",
                "When have I inspired others with my courage?",
                "What legacy am I actively creating?",
                "How do I stand up for what I believe in?",
                "When did I trust my instincts — and it paid off?",
                "What makes my perspective uniquely valuable?",
                "Who has thanked me for blazing a trail?",
                "What challenge did I overcome through sheer determination?",
                "What does my strength make possible for others?"
            ]
        },
        2: {
            "shadow": (
                "Life Path 2s are empathetic, diplomatic, and relational, but in shadow, they may become overly accommodating, conflict-averse, or lose their identity in service to others. "
                "Their deep desire for harmony can prevent authentic expression. Their shadow work involves reclaiming their voice, trusting that speaking up is not betrayal — it's connection."
            ),
            "journal_prompts": [
                "Where do I stay silent to avoid rocking the boat?",
                "What am I not saying — and why?",
                "How do I define myself outside of relationships?",
                "Where do I put others' needs before my own?",
                "What does healthy conflict look like to me?",
                "When do I confuse peace with passivity?",
                "How do I feel when someone disagrees with me?",
                "What part of me do I hide to keep others comfortable?",
                "Where am I afraid of being 'too much'?",
                "What boundaries do I struggle to hold?",
                "When have I said 'yes' but meant 'no'?",
                "What would standing in my full truth look like?"
            ],
            "celebration_prompts": [
                "When have I brought people together in a meaningful way?",
                "What’s one time I helped someone feel truly seen?",
                "How do I use empathy as a strength?",
                "What makes my emotional intelligence powerful?",
                "When have I held space for someone with grace?",
                "How do I offer harmony in chaotic situations?",
                "What is my superpower in partnership?",
                "Who has thanked me for my quiet wisdom?",
                "What beauty have I created through collaboration?",
                "How do I embody compassion through action?",
                "What’s something gentle about me that is actually fierce?",
                "How do I nurture without losing myself?"
            ]
        },
        3: {
            "shadow": (
                "Life Path 3s are expressive, creative, and joyful — but in shadow, they may avoid depth, distract themselves with performance, or fear being emotionally vulnerable. "
                "Their charm becomes a shield. The work of the 3 is to move from surface to substance, learning that true connection comes from authenticity, not perfection."
            ),
            "journal_prompts": [
                "Where do I perform instead of expressing how I really feel?",
                "When do I feel pressure to be upbeat even if I’m not?",
                "What emotions do I hide behind humor?",
                "What would it mean to be seen in my messiness?",
                "When do I use busyness to avoid what’s underneath?",
                "How do I feel about silence — especially with others?",
                "What am I afraid people would think if I stopped performing?",
                "Where do I judge myself for being inconsistent?",
                "What part of me wants to be expressed but stays hidden?",
                "When did I learn that showing emotion was unsafe?",
                "How do I hold space for my own vulnerability?",
                "Where is depth calling me to stay a little longer?"
            ],
            "celebration_prompts": [
                "What is something I created that brings me joy?",
                "When have I lifted a room with my presence?",
                "How does my expressiveness inspire others?",
                "What makes my storytelling magnetic?",
                "How do I brighten people’s days — without even trying?",
                "What’s a time I brought humor to a hard moment?",
                "How do I share beauty with the world?",
                "When did I use my voice for something powerful?",
                "What does creativity mean to me, really?",
                "What part of my personality am I proud of?",
                "How do I celebrate life — even in small ways?",
                "What kind of legacy do I want to leave through joy?"
            ]
        },
        4: {
            "shadow": (
                "Life Path 4s are grounded, reliable, and hardworking — but their shadow can show up as rigidity, resistance to change, and fear of uncertainty. "
                "They may cling to routines and structures long past their usefulness. Shadow work for 4 involves loosening the grip on control and allowing flexibility to spark growth."
            ),
            "journal_prompts": [
                "Where in my life am I being overly rigid or inflexible?",
                "How do I respond to sudden changes or surprises?",
                "What fears come up when I'm asked to step outside my routine?",
                "How do I use structure as a shield against discomfort?",
                "When did I learn that control = safety?",
                "What would it feel like to let go, just a little?",
                "How do I react to creative chaos?",
                "Where have I outgrown a structure but stayed anyway?",
                "What does trust in the unknown look like to me?",
                "How can I allow life to unfold without micromanaging it?",
                "What does groundedness look like without control?",
                "When do I confuse stability with stagnation?"
            ],
            "celebration_prompts": [
                "What systems have I built that serve others?",
                "Where has my consistency created beauty?",
                "What does my discipline make possible for me and those I love?",
                "How do I show commitment even when it's hard?",
                "What values guide the way I show up in the world?",
                "When have I provided a safe, dependable presence for someone?",
                "What’s a time I stayed the course and it paid off?",
                "What makes me proud of my work ethic?",
                "What tradition or structure have I lovingly upheld?",
                "How do I bring form to the dreams of others?",
                "What does my rootedness allow me to grow?",
                "What part of my legacy is already alive today?"
            ]
        },
        5: {
            "shadow": (
                "Life Path 5s are dynamic, adventurous, and freedom-seeking — but in shadow, they may become restless, unreliable, or escape discomfort through constant change. "
                "They can struggle with commitment or follow-through. Shadow work for 5 is about choosing a direction with intention and learning to find liberation through depth, not avoidance."
            ),
            "journal_prompts": [
                "What am I running from when I chase constant change?",
                "How does freedom feel different from avoidance?",
                "Where do I struggle to follow through — and why?",
                "What does healthy commitment look like for me?",
                "What discomfort am I avoiding by staying in motion?",
                "How do I feel when I'm truly still?",
                "Where have I traded depth for variety?",
                "What would it feel like to stay the course?",
                "What patterns keep repeating — no matter where I go?",
                "What is one area I could bring consistency to this month?",
                "How do I define freedom beyond escape?",
                "What might I discover if I stayed with one thing long enough?"
            ],
            "celebration_prompts": [
                "Where has my curiosity led me to something beautiful?",
                "What adventure has shaped who I am today?",
                "How do I inspire others to take risks?",
                "What is a change I made that opened up new possibilities?",
                "What makes my energy magnetic and alive?",
                "What does it feel like when I'm fully lit up?",
                "Where do I bring spontaneity and joy to others?",
                "What’s a time I broke the rules — for the better?",
                "How have I grown by trusting my own path?",
                "What kind of movement feels sacred to me?",
                "What have I taught others about freedom?",
                "What do I love about my wildness?"
            ]
        },
        6: {
            "shadow": (
                "Life Path 6s are compassionate, nurturing, and responsible — but their shadow can emerge as martyrdom, over-functioning, or controlling others ‘for their own good.’ "
                "They may derive worth from being needed, losing their boundaries in the process. Shadow work involves reclaiming self-worth beyond service and allowing others to walk their own path."
            ),
            "journal_prompts": [
                "Where do I take on too much responsibility for others’ emotions?",
                "When do I struggle to say no — and what’s behind that?",
                "What does over-functioning look like in my relationships?",
                "How do I use ‘helping’ to feel needed or important?",
                "What would it look like to love without rescuing?",
                "What am I afraid will happen if I stop holding it all together?",
                "Where have I made myself smaller to keep the peace?",
                "What relationships feel one-sided right now?",
                "How do I confuse love with obligation?",
                "Where do I feel resentment — and why?",
                "What does it feel like to let go of control?",
                "Who am I when I am not taking care of anyone else?"
            ],
            "celebration_prompts": [
                "How do I show devotion to those I love?",
                "What’s something beautiful I’ve nurtured into being?",
                "How have I made a difference in someone’s life?",
                "What does sacred responsibility feel like for me?",
                "When have I offered love with no strings attached?",
                "What’s a time I created harmony in chaos?",
                "How do I embody loyalty and protection?",
                "Who has thanked me for being their rock?",
                "What does my care offer the world?",
                "How do I express love through action?",
                "What have I healed through showing up with consistency?",
                "What do I love about being a guardian of the heart?"
            ]
        },
        7: {
            "shadow": (
                "Life Path 7s are introspective, intuitive, and analytical — but in shadow, they may become withdrawn, overly skeptical, or disconnected from their emotions and bodies. "
                "They can isolate themselves in the pursuit of understanding. Shadow work for 7 is about integrating mind, body, and spirit — and trusting lived experience over analysis."
            ),
            "journal_prompts": [
                "What emotions am I avoiding by staying in my head?",
                "When do I feel safe — and when do I feel watched or judged?",
                "How does solitude nourish me, and when does it isolate me?",
                "What beliefs keep me from trusting others fully?",
                "How do I use intellect to avoid vulnerability?",
                "What would it mean to let someone see behind the curtain?",
                "Where do I crave depth — but fear being seen?",
                "When have I cut off connection to protect myself?",
                "What would happen if I let go of needing all the answers?",
                "How do I treat my body when I’m stressed?",
                "What do I believe about intuition — and how often do I trust it?",
                "What does it mean to live, not just think?"
            ],
            "celebration_prompts": [
                "What is a truth I’ve discovered through deep contemplation?",
                "How has solitude helped me understand myself?",
                "What makes my insight valuable to others?",
                "When have I trusted my intuition and it served me?",
                "What mystery do I carry gracefully?",
                "What does spiritual depth mean to me?",
                "How have I offered clarity to someone in confusion?",
                "What’s a time I saw what no one else could see?",
                "How do I bring both logic and wonder to a situation?",
                "What does it feel like to be deeply self-aware?",
                "What gift does my perception offer the world?",
                "How does my presence invite reflection in others?"
            ]
        },
        8: {
            "shadow": (
                "Life Path 8s are powerful, ambitious, and driven — but in shadow, they may struggle with control, workaholism, or valuing achievement over connection. "
                "They can equate success with worth, and fear vulnerability. Their shadow work lies in softening power with presence, and choosing impact over domination."
            ),
            "journal_prompts": [
                "What does power mean to me — and where did I learn that?",
                "How do I feel when I’m not in control?",
                "Where do I use work or productivity to avoid feeling?",
                "When do I struggle to trust others’ competence?",
                "What scares me about failure — really?",
                "How do I respond when my authority is challenged?",
                "What part of me believes I must earn love or respect?",
                "Where am I hiding behind performance?",
                "What would it feel like to lead with softness?",
                "Where do I bulldoze instead of collaborate?",
                "What old story about survival am I still carrying?",
                "How do I define ‘enough’ — and do I believe it?"
            ],
            "celebration_prompts": [
                "What have I built through discipline and focus?",
                "When have I lifted others through my leadership?",
                "How do I use my strength to protect the vulnerable?",
                "What’s a challenge I’ve overcome through grit?",
                "What impact have I made that I’m proud of?",
                "What does it feel like to stand in my power?",
                "What legacy am I actively shaping?",
                "What do others admire about my leadership?",
                "How do I transform pressure into diamonds?",
                "What does ethical ambition look like for me?",
                "How do I embody empowered presence?",
                "Where have I used my voice for justice or truth?"
            ]
        },
        9: {
            "shadow": (
                "Life Path 9s are idealistic, compassionate, and visionary — but in shadow, they may martyr themselves, avoid conflict, or hold onto past wounds. "
                "They can struggle to set boundaries, or resist letting go. Their shadow work is to discern between healthy sacrifice and self-erasure — and to forgive, release, and renew."
            ),
            "journal_prompts": [
                "Where am I holding onto pain that’s ready to be released?",
                "How do I confuse love with self-sacrifice?",
                "What relationship am I still clinging to in my mind?",
                "Where do I struggle to say no — and why?",
                "How does my empathy sometimes override my truth?",
                "What does closure mean to me?",
                "What needs to be completed for me to move on?",
                "Where do I avoid confrontation to keep the peace?",
                "How do I treat myself when others disappoint me?",
                "When did I last let go — and how did it feel?",
                "What does it mean to forgive myself?",
                "Where can I choose compassion without self-betrayal?"
            ],
            "celebration_prompts": [
                "When have I helped someone in a profound way?",
                "What makes my compassion unique?",
                "How do I dream big for the collective?",
                "What does spiritual leadership look like for me?",
                "When have I offered comfort simply by being present?",
                "What injustices have I quietly worked to heal?",
                "What beauty do I see that others often miss?",
                "How have I turned pain into purpose?",
                "What legacy of healing do I hope to leave?",
                "What role do I play in elevating others?",
                "What’s something I’ve forgiven that brought me peace?",
                "How do I walk with heart — even through endings?"
            ]
        }
    },
    "Enneagram" : {
        1: {
            "shadow": (
                "Type 1s are principled, conscientious, and driven to improve the world — but their shadow emerges as harsh inner criticism, rigidity, or perfectionism. "
                "They may suppress anger, fear mistakes, or judge themselves and others too harshly. Shadow work invites softness, self-compassion, and releasing the illusion of control."
            ),
            "journal_prompts": [
                "Where do I hold myself to impossible standards?",
                "What does my inner critic sound like — and what does it need?",
                "How do I respond when I or others make mistakes?",
                "What am I afraid will happen if I let go of control?",
                "How does resentment show up in my body?",
                "Where can I offer myself grace today?",
                "When did I last choose rest over productivity?",
                "How do I treat others when I’m being hard on myself?",
                "What rules have I outgrown but still follow?",
                "What part of me needs forgiveness?",
                "How can I express anger in healthy, constructive ways?",
                "What does it feel like to be good enough as I am?"
            ],
            "celebration_prompts": [
                "What cause or ideal do I feel proud to champion?",
                "How have I improved a space or system through care?",
                "What values do I live by with consistency?",
                "How do I embody integrity in my daily life?",
                "When have I spoken up for what’s right, even when hard?",
                "What kind of structure brings me peace?",
                "What does it feel like to act from principle, not pressure?",
                "How have I uplifted others through my standards?",
                "What brings me quiet pride in my choices?",
                "How do I model accountability without blame?",
                "What has my discipline helped me achieve?",
                "How do I stay true to myself while evolving?"
            ]
        },
        2: {
            "shadow": (
                "Type 2s are generous, warm, and supportive — but in shadow, they may overextend, become resentful, or give in order to be needed. "
                "They may neglect their own needs or struggle to receive. Shadow work involves reclaiming worthiness apart from service and learning to love from overflow, not depletion."
            ),
            "journal_prompts": [
                "Where do I give to others at my own expense?",
                "What do I fear will happen if I say no?",
                "How do I feel when others don’t appreciate my help?",
                "What am I longing to receive — but afraid to ask for?",
                "When do I confuse love with obligation?",
                "How do I treat myself when I’m not helping anyone?",
                "Where have I ignored my own needs for the sake of harmony?",
                "How can I practice loving detachment today?",
                "What would it feel like to rest without guilt?",
                "Where do I withhold honesty to stay needed?",
                "What does it mean to love without rescuing?",
                "How can I nurture myself the way I nurture others?"
            ],
            "celebration_prompts": [
                "How have I offered love without expectation?",
                "When have I created space for someone to feel safe?",
                "What does it feel like to give from a full heart?",
                "Who has thanked me for being present in their life?",
                "What does kindness look like in action for me?",
                "How do I show up when someone is in need?",
                "What’s something beautiful I’ve done just to help?",
                "What makes my support uniquely powerful?",
                "How do I express compassion in quiet ways?",
                "What relationships have I nurtured into deep trust?",
                "When have I loved fiercely and freely?",
                "How does my empathy uplift others?"
            ]
        },
        3: {
            "shadow": (
                "Type 3s are driven, adaptable, and inspiring — but their shadow can emerge as over-identifying with image, suppressing vulnerability, or striving for success at the cost of authenticity. "
                "They may fear failure or disconnection if they slow down. Shadow work invites realignment with inner truth and a gentler definition of worth."
            ),
            "journal_prompts": [
                "What am I afraid others would think if I failed?",
                "Where do I perform instead of showing up fully?",
                "What does rest feel like in my body — and do I avoid it?",
                "What version of me am I trying to protect?",
                "When did I learn that success = love?",
                "What masks do I wear when I feel insecure?",
                "Where do I struggle to be seen without my accomplishments?",
                "What does it mean to be enough without effort?",
                "How do I respond when I feel unrecognized?",
                "What value do I place on appearance vs. essence?",
                "Where am I chasing goals that no longer matter?",
                "How can I show up today from authenticity, not strategy?"
            ],
            "celebration_prompts": [
                "What is something I’ve accomplished that truly matters to me?",
                "When have I inspired others by being myself?",
                "How do I define success on my own terms?",
                "What drives me from the inside, not external praise?",
                "When have I been vulnerable and it strengthened connection?",
                "What kind of leader am I becoming?",
                "What have I created through focus and energy?",
                "What legacy am I building — and why?",
                "What does it feel like to be proud of my growth?",
                "What makes my ambition purposeful?",
                "How do I balance excellence with authenticity?",
                "What makes my story powerful?"
            ]
        },
        4: {
            "shadow": (
                "Type 4s are creative, emotionally attuned, and authentic — but in shadow, they may become self-absorbed, overly melancholic, or defined by their wounds. "
                "They may fear being ordinary or abandon joy in favor of meaning. Shadow work means embracing the full spectrum of life — including the mundane and the beautiful."
            ),
            "journal_prompts": [
                "What story do I tell myself about my pain?",
                "Where do I cling to suffering as part of my identity?",
                "How do I feel about being 'ordinary'?",
                "When do I resist joy — and why?",
                "What would it feel like to belong exactly as I am?",
                "Where do I isolate myself emotionally?",
                "How do I express emotions without losing center?",
                "What do I believe I must feel to be 'real'?",
                "When have I compared myself unfairly?",
                "What does it mean to be enough without being special?",
                "How do I romanticize struggle?",
                "Where do I need to practice grounded presence?"
            ],
            "celebration_prompts": [
                "How do I turn pain into beauty?",
                "What makes my emotional depth a gift?",
                "How have I helped others feel seen?",
                "What part of me is wildly original?",
                "When have I created something deeply meaningful?",
                "How do I honor complexity in a world of shortcuts?",
                "What’s something tender I’ve held with grace?",
                "How do I move others with my honesty?",
                "What role does beauty play in my life?",
                "When have I embraced both shadow and light?",
                "How do I find meaning in the everyday?",
                "What do I love about my emotional intelligence?"
            ]
        },
        5: {
            "shadow": (
                "Type 5s are insightful, cerebral, and observant — but in shadow, they may detach, over-intellectualize, or withdraw to protect their energy. "
                "They may fear depletion or being overwhelmed by demands. Shadow work for 5 is about re-entering the body, trusting connection, and sharing their inner richness."
            ),
            "journal_prompts": [
                "What sensations do I avoid when I retreat into thought?",
                "How do I protect my energy — and when does it isolate me?",
                "Where do I assume others won’t understand me?",
                "When do I feel like I know enough to act?",
                "What does safety mean to me?",
                "How do I experience intimacy — and what blocks it?",
                "What am I afraid will happen if I’m fully seen?",
                "How do I handle demands on my time or attention?",
                "What do I long to express — but keep private?",
                "What helps me return to my body?",
                "When have I shared something that created connection?",
                "Where can I offer my insight more generously?"
            ],
            "celebration_prompts": [
                "What knowledge have I cultivated that matters deeply?",
                "How do I offer clarity or wisdom to others?",
                "When have I been a calm, steady presence in crisis?",
                "What part of my curiosity do I cherish most?",
                "How do I create beauty through understanding?",
                "What’s something I’ve studied with passion?",
                "How do I make others feel safe with my quiet presence?",
                "What boundaries have protected my peace?",
                "What does it feel like when I trust someone with my inner world?",
                "How have I surprised others with emotional depth?",
                "What do I love about my reflective nature?",
                "When have I felt completely at ease in solitude?"
            ]
        },
        6: {
            "shadow": (
                "Type 6s are loyal, responsible, and thoughtful — but their shadow may manifest as overthinking, anxiety, or reliance on external authority. "
                "They may fear being without support and distrust their own instincts. Shadow work invites inner trust, nervous system regulation, and discerning loyalty."
            ),
            "journal_prompts": [
                "What fear am I managing by thinking through every scenario?",
                "When do I struggle to trust my own instincts?",
                "What would it feel like to choose without certainty?",
                "How does anxiety speak in my body?",
                "Where do I outsource my authority — and why?",
                "How do I respond to chaos or unpredictability?",
                "What kind of support helps me feel grounded?",
                "What are my beliefs about loyalty and betrayal?",
                "Where have I been overly cautious?",
                "What helps me access inner calm?",
                "How do I discern real threats from imagined ones?",
                "When do I feel most confident in my own judgment?"
            ],
            "celebration_prompts": [
                "When have I shown fierce loyalty to someone I care about?",
                "What systems or structures have I helped stabilize?",
                "How does my sense of duty uplift others?",
                "When have I spoken truth to protect what matters?",
                "What gives me quiet courage in uncertainty?",
                "How do I prepare in ways that serve the collective?",
                "What makes me a grounding force in my community?",
                "When have I been a calm voice in crisis?",
                "How do I blend responsibility with care?",
                "What values guide my devotion?",
                "How have I earned trust over time?",
                "What does safe leadership look like for me?"
            ]
        },
        7: {
            "shadow": (
                "Type 7s are optimistic, imaginative, and joy-seeking — but in shadow, they may become scattered, avoidant, or unable to sit with discomfort. "
                "They may escape pain through busyness or constant novelty. Shadow work is about presence, integration, and honoring depth without fear."
            ),
            "journal_prompts": [
                "What emotions am I avoiding by staying busy?",
                "Where do I chase experiences instead of presence?",
                "What does stillness bring up in me?",
                "How do I define freedom — and is that working for me?",
                "Where do I fear limitation — and what’s underneath?",
                "How does pain make me want to escape?",
                "What do I need to feel safe enough to slow down?",
                "Where have I left too soon?",
                "How do I experience depth without dread?",
                "What would it mean to stay instead of sprint?",
                "How do I use humor to deflect?",
                "What makes me truly, deeply joyful — not just entertained?"
            ],
            "celebration_prompts": [
                "What’s something I’ve brought lightness to in a dark time?",
                "How do I create joy for myself and others?",
                "What gives me a deep sense of aliveness?",
                "How have I sparked adventure in someone’s life?",
                "What’s a bold choice I made that I’m proud of?",
                "How do I embrace possibility when others lose hope?",
                "When has my spontaneity opened new doors?",
                "What dream am I most excited to follow right now?",
                "What makes my laughter healing?",
                "How do I explore with curiosity instead of fear?",
                "What’s one brilliant idea I brought to life?",
                "When have I danced in uncertainty with grace?"
            ]
        },
        8: {
            "shadow": (
                "Type 8s are strong, direct, and protective — but in shadow, they may become controlling, confrontational, or closed to vulnerability. "
                "They may fear betrayal and suppress softness. Shadow work means letting down the armor and trusting power that includes tenderness."
            ),
            "journal_prompts": [
                "What does vulnerability mean to me — and how do I avoid it?",
                "How do I respond when I feel unsafe or exposed?",
                "Where do I try to control people or outcomes?",
                "How do I relate to authority — mine and others’?",
                "What do I believe about strength and weakness?",
                "What part of me is asking for gentleness?",
                "How do I react when I’m not in charge?",
                "When have I used intensity to mask fear?",
                "How do I soften without losing power?",
                "What does real intimacy require of me?",
                "Where can I be fiercely kind today?",
                "How does my anger want to protect me?"
            ],
            "celebration_prompts": [
                "When have I stood up for someone who couldn’t?",
                "What makes me a powerful advocate?",
                "How do I protect what matters most?",
                "What kind of leader am I when I lead with heart?",
                "When have I used strength to heal, not harm?",
                "How do I transform rage into righteous action?",
                "What boundary has made me feel most sovereign?",
                "What makes my presence formidable and loving?",
                "How have I earned trust through honesty?",
                "When have I mentored someone with care?",
                "What legacy of protection do I leave behind?",
                "What do I love about being bold and brave?"
            ]
        },
        9: {
            "shadow": (
                "Type 9s are peaceful, kind, and inclusive — but in shadow, they may disengage, avoid conflict, or lose themselves to keep others comfortable. "
                "They may struggle with inertia, numbness, or indecision. Shadow work involves claiming voice, vision, and the right to take up space."
            ),
            "journal_prompts": [
                "Where do I go silent instead of saying what I mean?",
                "What do I fear will happen if I rock the boat?",
                "How do I disconnect from myself to keep the peace?",
                "Where am I accommodating at the cost of truth?",
                "What part of me is still waiting for permission to speak?",
                "How do I self-soothe — and when does it turn into avoidance?",
                "What am I passionate about that I rarely share?",
                "How does my body signal that I’ve gone numb?",
                "What would it feel like to fully take up space?",
                "When have I said yes but meant no?",
                "What helps me feel fully awake and alive?",
                "Where do I need to choose action over passivity?"
            ],
            "celebration_prompts": [
                "When have I created peace in chaos?",
                "How do I embody calm and grace for others?",
                "What makes my presence healing?",
                "How do I bridge divides in my community?",
                "When have I offered deep, steady love?",
                "What passion is quietly growing inside me?",
                "How do I model acceptance without judgment?",
                "What truth have I reclaimed recently?",
                "When have I stood up for myself with gentleness?",
                "What gives me a sense of belonging?",
                "How do I unify people without forcing sameness?",
                "What do I love about being the calm in the storm?"
            ]
        }
    },
    "HumanDesign": {
        "Generator": {
            "shadow": (
                "Generators are the life force of the world — builders with sustainable energy when aligned. But in shadow, they may become trapped in frustration, saying yes to things that drain them or chasing what they 'should' do instead of what lights them up. "
                "They may feel stuck, obligated, or overcommitted. True power comes from responding with the gut — not initiating, fixing, or proving. Their work is to wait for what truly excites their energy and say no without guilt."
            ),
            "journal_prompts": [
                "What in my life currently drains me — and why am I still doing it?",
                "When do I say yes from pressure instead of passion?",
                "Where do I ignore my gut because I 'should' do something?",
                "What does frustration usually signal in my life?",
                "How do I feel about saying no?",
                "What would it mean to trust that the right things will come to me?",
                "Where do I push or initiate rather than respond?",
                "What patterns keep me overcommitted?",
                "How can I recognize what genuinely lights me up?",
                "What would a life built on joy feel like?",
                "When do I feel the most alive — and what’s in common there?",
                "What am I ready to stop forcing?"
            ],
            "celebration_prompts": [
                "What do I love building when I feel lit up?",
                "When have I trusted my gut — and it worked beautifully?",
                "What does it feel like to be in flow?",
                "How does my energy support others when I’m aligned?",
                "What have I sustained through steady joy?",
                "What am I proud of saying no to recently?",
                "How do I protect my energy now vs. in the past?",
                "What lights me up — even when no one’s watching?",
                "How do I know when something is a full-body yes?",
                "When did I shift from obligation to desire — and what changed?",
                "How do I nourish the life force within me?",
                "What legacy do I want to build from joy?"
            ]
        },
        "Manifesting Generator": {
            "shadow": (
                "Manifesting Generators are fast, powerful hybrids who are meant to skip steps — but in shadow, they may become scattered, impatient, or ashamed of their nonlinear process. "
                "They can feel frustrated when things slow them down or guilty for shifting directions. Their work lies in trusting their speed *and* their gut, honoring the zigzag path instead of trying to fit a linear mold."
            ),
            "journal_prompts": [
                "Where do I feel guilty for changing my mind?",
                "What stories do I carry about being inconsistent or 'too much'?",
                "When do I rush just to get things over with?",
                "How do I respond when others can’t keep up?",
                "Where have I hidden parts of my process to seem more 'put together'?",
                "What would it feel like to trust my detours?",
                "What have I judged as flaky that may actually be flexible?",
                "What does frustration mean to me lately?",
                "How can I slow down without losing momentum?",
                "What decisions felt like truth in the moment — even if I pivoted later?",
                "How do I react when people tell me to 'focus'?",
                "What’s one nonlinear success story from my life?"
            ],
            "celebration_prompts": [
                "What makes my energy unique and powerful?",
                "How have I mastered rapid shifts others fear?",
                "When have I surprised myself with what I could do quickly?",
                "How do I inspire others to break molds?",
                "Where has my speed served me beautifully?",
                "How do I honor my multifaceted nature now?",
                "When have I let go of guilt and followed my joy?",
                "What’s one success that only happened because I changed direction?",
                "What does freedom of motion look like in my work or life?",
                "How do I trust my process more than I used to?",
                "What do I love most about my energetic power?",
                "What does it feel like to live outside the rules — and win?"
            ]
        },
        "Projector": {
            "shadow": (
                "Projectors are seers — wise guides here to direct others. But in shadow, they may feel invisible, bitter, or overextend themselves trying to prove worth. "
                "They often try to be like energy types, working harder instead of waiting to be recognized. Their shadow work lies in trusting their insight, resting deeply, and allowing themselves to be seen without chasing."
            ),
            "journal_prompts": [
                "Where do I feel unseen or unrecognized — and how do I react?",
                "How do I try to prove my worth?",
                "What’s my relationship to rest — and what do I believe about it?",
                "When have I offered wisdom that wasn’t received?",
                "What does bitterness usually signal in my life?",
                "Where am I trying to be productive to gain approval?",
                "What would it look like to feel valued without effort?",
                "How do I handle not being invited or acknowledged?",
                "Where am I overworking to be chosen?",
                "How do I distinguish between true invitations and forced ones?",
                "What insights am I holding back from the world?",
                "How can I trust timing instead of forcing recognition?"
            ],
            "celebration_prompts": [
                "When has my perspective changed someone’s life?",
                "What do I see clearly that others miss?",
                "How do I protect my energy with grace now?",
                "What’s one moment I truly felt recognized?",
                "How do I use rest as a source of wisdom?",
                "Where have I been the guide others needed?",
                "What do I love about the way I observe and reflect?",
                "How do I uplift others without draining myself?",
                "When did I trust an invitation — and it paid off?",
                "What makes me magnetic when I’m in alignment?",
                "What’s sacred about the way I hold space?",
                "What do I celebrate about being different?"
            ]
        },
        "Manifestor": {
            "shadow": (
                "Manifestors are initiators — here to catalyze action and lead movements. But in shadow, they may become angry, misunderstood, or shut down their voice after early resistance. "
                "They often feel like they must do it all alone. Their work is to reclaim their power to inform, initiate, and move freely — without shrinking to make others comfortable."
            ),
            "journal_prompts": [
                "What makes me angry — and what’s beneath that anger?",
                "When have I felt silenced or blocked?",
                "Where do I hold back from initiating because of others’ reactions?",
                "What’s my relationship to being misunderstood?",
                "How do I respond to resistance?",
                "What parts of myself have I dimmed to avoid conflict?",
                "What do I long to initiate — but haven’t?",
                "What fears do I carry about being too much?",
                "Where do I avoid informing others to protect myself?",
                "How do I reclaim agency in moments of tension?",
                "What does freedom of movement mean to me?",
                "How can I lead without apologizing for it?"
            ],
            "celebration_prompts": [
                "What have I initiated that changed something?",
                "When did I take bold action — and own it?",
                "How does my presence create waves?",
                "What do I love about my independence?",
                "What happens when I speak freely and truthfully?",
                "How have I honored my creative urges?",
                "What does empowered leadership look like in my life?",
                "How do I inspire others to begin?",
                "When have I trusted my urges even when others didn’t get it?",
                "How do I model unapologetic expression?",
                "Where do I thrive when left to lead?",
                "What’s one thing only I could have set in motion?"
            ]
        },
        "Reflector": {
            "shadow": (
                "Reflectors are mirrors — deeply sensitive beings who amplify the health of their environment. In shadow, they may lose themselves in others, feel overwhelmed, or disconnected from their true rhythm. "
                "Their work is to curate their spaces and relationships intentionally, trust their lunar timing, and remember they are not broken for being different — they are rare and essential."
            ),
            "journal_prompts": [
                "How do I feel in the environments I frequent most?",
                "Where am I absorbing energy that doesn’t belong to me?",
                "How do I determine what’s mine vs. what’s others’?",
                "When do I feel most myself?",
                "What does sensitivity mean to me — and how do I care for it?",
                "Where do I over-identify with someone else’s emotions?",
                "What boundaries do I need to honor my rhythm?",
                "What does it mean to take my time with decisions?",
                "What role does space and solitude play in my clarity?",
                "Where am I most reflective — and what shows up there?",
                "How do I honor my uniqueness rather than resist it?",
                "What would it look like to embrace my difference fully?"
            ],
            "celebration_prompts": [
                "What do I notice that others miss?",
                "When have I helped others understand themselves better?",
                "How does my presence shift a room?",
                "What do I love about my sensitivity?",
                "How do I care for my energetic health now?",
                "What happens when I trust my timing?",
                "When did my stillness offer clarity?",
                "What’s sacred about my ability to mirror others?",
                "How have I used gentleness as power?",
                "What does it mean to be rare — and how do I celebrate that?",
                "Where do I feel most in tune with the world?",
                "What do I love about my ever-changing nature?"
            ]
        }
    }
}


trait_libs = {
    "sun_sign_profiles": sun_sign_profiles,
    "life_path_profiles": life_path_profiles,
    "chinese_zodiac_profiles": chinese_zodiac_profiles,
    "human_design_profiles": human_design_profiles,
    "enneagram_profiles": enneagram_profiles
}

def get_birth_traits(traits_dict):
    return [
        traits_dict["sun"]["birth"],
        traits_dict["life_path"]["birth"],
        traits_dict["chinese_zodiac"]["birth"],
        traits_dict["human_design"]["birth"]
    ]

def get_dominant_traits(traits_dict):
    return [
        traits_dict["sun"]["dominant"],
        traits_dict["life_path"]["dominant"],
        traits_dict["chinese_zodiac"]["dominant"],
        traits_dict["human_design"]["dominant"],
        traits_dict["enneagram"]["dominant"]
    ]

def get_undertone_traits(traits_dict):
    return [
        traits_dict["sun"]["undertone"],
        traits_dict["life_path"]["undertone"],
        traits_dict["chinese_zodiac"]["undertone"],
        traits_dict["human_design"]["undertone"],
        traits_dict["enneagram"]["undertone"]
    ]

def get_all_traits(traits_dict):
    return get_birth_traits(traits_dict) + get_dominant_traits(traits_dict) + get_undertone_traits(traits_dict)

def get_trait_dict(system: str, label: Union[str, int], trait_libs: dict) -> dict:
    lib_map = {
        "sun": "sun_sign_profiles",
        "life_path": "life_path_profiles",
        "chinese_zodiac": "chinese_zodiac_profiles",
        "human_design": "human_design_profiles",
        "enneagram": "enneagram_profiles"
    }
    lib_name = lib_map.get(system)
    return trait_libs.get(lib_name, {}).get(label, {})

def get_trait_label(system: str, role: str, standardized_scores: dict) -> Union[str, int]:
    """
    Safely fetch the trait label for a given system and role (birth, dominant, undertone).
    Returns a string (for sun, human_design, etc.) or int (for life_path).
    """
    try:
        return standardized_scores[system][role]
    except KeyError:
        return "Unknown"
        
def resolve_trait(system: str, role: str, standardized_scores: dict, trait_libs: dict) -> tuple:
    label = get_trait_label(system, role, standardized_scores)
    data = get_trait_dict(system, label, trait_libs)
    return label, data


# ------------MOON TRANSITS --------------
def get_moon_transit_by_month(month_index):
    moon_transits = [
        ("Moon conjunct Neptune", "spiritual surrender", "Let go of needing clarity — intuition is your compass."),
        ("Moon trine Venus", "emotional softness", "Let beauty and belonging lead your choices."),
        ("Moon square Saturn", "inner boundaries", "Face the places where structure meets feeling."),
        ("Moon conjunct Pluto", "emotional alchemy", "Something hidden is surfacing — sit with it."),
        ("Moon opposite Mars", "emotional reactivity", "Feel fully before acting rashly."),
        ("Moon in Gate 36", "navigating crisis", "Every tension is a turning point — stay open."),
        ("Moon in Gate 22", "grace under pressure", "Let poise hold space for your truth."),
        ("Moon in Gate 49", "emotional revolution", "Your inner standards are shifting — honor them."),
        ("Moon in Gate 19", "sensitivity to needs", "You’re attuned — now listen to your body."),
        ("Moon trine Mercury", "heart-to-mouth fluency", "Speak what your heart already knows."),
        ("Moon square Uranus", "emotional surprise", "Let spontaneity guide — but stay grounded."),
        ("Moon opposite Sun", "culmination & clarity", "Release what’s ready to end.")
    ]
    return moon_transits[month_index % len(moon_transits)]


# ---------- EMOTIONAL SENSITIVITY WEIGHTS -------------
# emotional_sensitivity_weights.py
emotional_sensitivity = {
    "sun": {
        "Cancer": 1.4, "Pisces": 1.4, "Scorpio": 1.3,
        "Taurus": 1.2, "Virgo": 1.1, "Libra": 1.1,
        "Capricorn": 1.0, "Aquarius": 1.0, "Sagittarius": 1.0,
        "Leo": 0.9, "Aries": 0.9, "Gemini": 0.9
    },
    "life_path": {
        2: 1.4, 6: 1.3, 11: 1.3, 7: 1.2, 9: 1.2,
        3: 1.1, 5: 1.0, 4: 1.0, 1: 0.9, 8: 0.9, 22: 0.9
    },
    "chinese_zodiac": {
        "Rabbit": 1.4, "Goat": 1.3, "Pig": 1.3,
        "Dog": 1.2, "Ox": 1.1, "Monkey": 1.1,
        "Dragon": 1.0, "Tiger": 1.0, "Horse": 0.9,
        "Snake": 0.9, "Rat": 0.9, "Rooster": 0.8
    },
    "human_design": {
        "Projector": 1.4, "Reflector": 1.3, "Manifestor": 1.1,
        "Manifesting Generator": 1.0, "Generator": 1.0
    },
    "enneagram": {
        4: 1.4, 6: 1.3, 2: 1.3, 9: 1.2,
        1: 1.1, 5: 1.1, 3: 1.0, 7: 1.0, 8: 0.9
    }
}



# ----- Trimming logic -----

def trim_to_nearest_sentence(text, limit=400):
    trimmed = text[:limit]
    last_period = trimmed.rfind('.')
    return trimmed[:last_period + 1].strip() if last_period > 100 else trimmed.strip()



# ---------- TRANSIT CALCULATIONS ---------
ZODIAC_SIGNS = [
    "Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo",
    "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"
]

def calculate_transit_score(sun_deg, transit_positions):
    """
    Calculate a score based on angular distance between Sun and each planet in degrees.
    """
    score = 0
    for planet, deg in transit_positions.items():
        if planet == "Sun":
            continue
        angle = abs(deg - sun_deg) % 360
        if angle > 180:
            angle = 360 - angle

        if angle <= 6:
            score += 6  # Conjunct
        elif 82 <= angle <= 98:
            score += 4  # Square
        elif 112 <= angle <= 128:
            score += 3  # Trine
        elif 172 <= angle <= 188:
            score += 5  # Opposition
        elif 52 <= angle <= 68:
            score += 2  # Sextile

    return score

def birthdate_to_jd(birth_date_str):
    """
    Convert a birth date string (YYYY-MM-DD) to Julian Day using Swiss Ephemeris.

    Args:
        birth_date_str (str): Birth date in 'YYYY-MM-DD' format.

    Returns:
        float: Julian Day number corresponding to the birth date.
    """
    dt = datetime.strptime(birth_date_str, "%Y-%m-%d")
    return swe.julday(dt.year, dt.month, dt.day)

def calculate_sun_transits(jd_start, days_ahead=365, step=3):
    import swisseph as swe
    from datetime import datetime

    planet_names = {
        "Moon": swe.MOON,
        "Mercury": swe.MERCURY,
        "Venus": swe.VENUS,
        "Mars": swe.MARS,
        "Jupiter": swe.JUPITER,
        "Saturn": swe.SATURN,
        "Uranus": swe.URANUS,
        "Neptune": swe.NEPTUNE,
        "Pluto": swe.PLUTO
    }

    aspects = {
        "conjunct": 0,
        "square": 90,
        "trine": 120,
        "opposition": 180
    }

    transits = []
    seen = set()  # prevent duplicates

    for offset in range(0, days_ahead, step):
        jd = jd_start + offset
        sun_pos, _ = swe.calc_ut(jd, swe.SUN)
        sun_lon = sun_pos[0]

        for name, code in planet_names.items():
            pos, _ = swe.calc_ut(jd, code)
            planet_lon = pos[0]
            diff = abs((sun_lon - planet_lon) % 360)

            for aspect, angle in aspects.items():
                if abs(diff - angle) <= 6:
                    dt = swe.revjul(jd)  # Convert JD to (year, month, day)
                    dt_str = f"{int(dt[1]):02}/{int(dt[2]):02}/{int(dt[0])}"
                    key = (name, aspect, dt_str)

                    if key not in seen:
                        seen.add(key)
                        transits.append({
                            "date": dt_str,
                            "aspect": aspect,
                            "planet": name
                        })
                    break  # Stop checking more aspects once one matches

    return transits

def get_moon_aspect_to_sun(sun_deg, moon_deg):
    angle = abs(sun_deg - moon_deg) % 360
    if angle > 180:
        angle = 360 - angle

    if angle <= 6:
        return "conjunct"
    elif 82 <= angle <= 98:
        return "square"
    elif 112 <= angle <= 128:
        return "trine"
    elif 172 <= angle <= 188:
        return "opposition"
    elif 52 <= angle <= 68:
        return "sextile"
    else:
        return "aspecting"

def get_sun_transit_aspects(natal_sun_deg, current_transits):
    aspects = []
    for planet, planet_deg in current_transits.items():
        if planet == "Moon":
            continue
        angle = abs(natal_sun_deg - planet_deg) % 360
        if angle > 180:
            angle = 360 - angle

        if angle <= 6:
            aspect = "conjunct"
        elif 82 <= angle <= 98:
            aspect = "square"
        elif 112 <= angle <= 128:
            aspect = "trine"
        elif 172 <= angle <= 188:
            aspect = "opposition"
        elif 52 <= angle <= 68:
            aspect = "sextile"
        else:
            aspect = "aspecting"

        aspects.append((planet, aspect, angle))
    return aspects

# ------------------ SUMMARY SYNTHESIS SECTION ------------------
def generate_summary_synthesis(birth_traits, standardized_scores, client, sun_deg, moon_deg):
    preamble = """
This is your Astrological Fingerprint — the one constellation that belongs to no one else.

Over the pages before, you've explored how your inner wiring shows up in love, money, purpose, and family.
You've worked through your shadows, honored your strengths, and received lunar insight to guide you.

What follows is not a recap. It’s a reframe — the mirror of everything you've remembered.
""".strip()

    # Trait summary for prompt (not shown to user)
    birth_sun = birth_traits.get("Sun")
    birth_lp = birth_traits.get("LifePath")
    birth_czn = birth_traits.get("ChineseZodiac")
    birth_hd = birth_traits.get("HumanDesign")
    dom_sun = standardized_scores["sun"]["dominant"]
    dom_lp = standardized_scores["life_path"]["dominant"]
    dom_czn = standardized_scores["chinese_zodiac"]["dominant"]
    dom_hd = standardized_scores["human_design"]["dominant"]
    dom_ennea = standardized_scores["enneagram"]["dominant"]
    und_sun = standardized_scores["sun"]["undertone"]
    und_lp = standardized_scores["life_path"]["undertone"]
    und_czn = standardized_scores["chinese_zodiac"]["undertone"]
    und_hd = standardized_scores["human_design"]["undertone"]
    und_ennea = standardized_scores["enneagram"]["undertone"]

    trait_summary = f"""
- Four birth traits: {birth_sun} Sun, Life Path {birth_lp}, {birth_czn}, {birth_hd}
- Five dominant traits: {dom_sun}, Life Path {dom_lp}, {dom_czn}, {dom_hd}, Enneagram {dom_ennea}
- Five undertone traits: {und_sun}, Life Path {und_lp}, {und_czn}, {und_hd}, Enneagram {und_ennea}
""".strip()

    # Prompt to GPT
    prompt = f"""
You are writing the final section of a personalized astrology report. It is called: “Your Astrological Fingerprint in Motion.”

This person has a unique combination of 14 traits:
{trait_summary}

These 14 traits represent:
- The original blueprint of their soul (birth traits)
- Who they’ve become through experience (dominant traits)
- The parts still evolving in real time (undertone traits)

Write a 3-paragraph closing reflection that:
1. Speaks to the **rarity and emotional richness** of their fingerprint
2. Reflects how this pattern is evolving and alive — not fixed
3. Ends with a grounded affirmation of who they are becoming, and how they can return to this truth when life feels uncertain

Speak directly to the person using “you” language.

Avoid all astrological or psychological labels. Do not reference systems (like “Enneagram”) or numerical types. Do not summarize the traits again. Deliver new, soulful insight — not recap.

Tone: clear, warm, and deeply personal — like a trusted guide reflecting their truth. Avoid horoscope clichés or mystical phrasing.
""".strip()

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85
        )
        final_text = response.choices[0].message.content.strip()

        formatted_paragraphs = [
            f"<p>{para.strip()}</p>" for para in final_text.split("\n\n")
        ]
        joined_paragraphs = "\n".join(formatted_paragraphs)

        return f"""
        <p>{preamble}</p>
        <div class='insight-box narrative-block' style='margin-top: 30px;'>
            {joined_paragraphs}
        </div>
        """

    except Exception as e:
        return f"<p><em>[Summary synthesis unavailable: {e}]</em></p>"



def get_planet_degrees(julian_day):
    planets = {
        'Sun': swe.SUN, 'Moon': swe.MOON, 'Mercury': swe.MERCURY, 'Venus': swe.VENUS,
        'Mars': swe.MARS, 'Jupiter': swe.JUPITER, 'Saturn': swe.SATURN,
        'Uranus': swe.URANUS, 'Neptune': swe.NEPTUNE, 'Pluto': swe.PLUTO
    }
    positions = {}
    for name, code in planets.items():
        pos, _ = swe.calc_ut(julian_day, code)
        positions[name] = pos[0]  # 0–360 degrees
    return positions



# ---------- TRANSIT CALCULATIONS ---------

def get_aspects_between_moon_and_planets(positions, orb=6.0):
    """
    Detects aspects between the Moon and all other planets.
    Returns a list of (planet, aspect_name, orb_distance) tuples.
    """
    moon_deg = positions.get("Moon")
    if moon_deg is None:
        return []

    aspects = {
        "conjunct": 0,
        "sextile": 60,
        "square": 90,
        "trine": 120,
        "opposition": 180
    }

    results = []

    for planet, deg in positions.items():
        if planet == "Moon" or deg is None:
            continue

        angle = abs((moon_deg - deg) % 360)
        angle = min(angle, 360 - angle)

        for name, target_angle in aspects.items():
            diff = abs(angle - target_angle)
            if diff <= orb:
                results.append((planet, name, round(diff, 2)))
                break

    return results


def get_real_transits(jd, months=12, offset=0):
    transits = []
    for m in range(months):
        forecast_date = datetime.now().replace(day=15) + timedelta(days=30 * (m + offset))
        jd_month = swe.julday(forecast_date.year, forecast_date.month, forecast_date.day, 0.0)

        positions = get_planet_degrees(jd_month)
        aspects = get_aspects_between_moon_and_planets(positions)

        print(f"🪐 Month {m+1} Aspects:", aspects)

        transits.append({
            "month": forecast_date.strftime("%B %Y"),
            "positions": positions,
            "aspects": aspects
        })

    return transits

def get_aspects_to_sun(positions, orb_tolerance=8.0):
    """
    Returns a list of tuples (planet, aspect_type, orb) between planets and Sun
    """
    aspect_angles = {
        "conjunct": 0,
        "sextile": 60,
        "square": 90,
        "trine": 120,
        "opposition": 180
    }

    sun_deg = positions.get("Sun")
    aspects = []

    for planet, deg in positions.items():
        if planet == "Sun":
            continue
        diff = abs(deg - sun_deg) % 360
        diff = min(diff, 360 - diff)

        for name, angle in aspect_angles.items():
            orb = abs(diff - angle)
            if orb <= orb_tolerance:
                aspects.append((planet, name, round(orb, 2)))

    return aspects


# ------------------ INTERPRETIVE NARRATIVE FUNCTIONS ------------------
def top_traits(trait_scores: Dict[str, Dict[str, float]], system: str, n: int = 2) -> List[str]:
    """
    Retrieve the top N traits with the highest scores for a given trait system.

    Args:
        trait_scores (Dict[str, Dict[str, float]]): Nested dictionary of trait scores by system.
            Example: {'sun': {'Aries': 2.0, 'Leo': 1.5}, 'enneagram': {'Type 1': 3.0, 'Type 2': 1.5}}
        system (str): The trait system to look up (e.g., "sun", "enneagram").
        n (int, optional): Number of top traits to return. Defaults to 2.

    Returns:
        List[str]: List of the top N trait names sorted by descending score.
    """
    system_traits = trait_scores.get(system, {})
    if not system_traits:
        return []

    sorted_traits = sorted(system_traits.items(), key=lambda x: x[1], reverse=True)
    return [trait for trait, _ in sorted_traits[:n]]


 # ---- RELATIONSHIP NARRATIVE BLOCK ---    
def generate_relationship_strengths(traits_dict, trait_libs):
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("relationships", "")
    lp_text = trait_libs["life_path_profiles"].get(lp, {}).get("relationships", "")
    cz_text = trait_libs["chinese_zodiac_profiles"].get(czn, {}).get("relationships", "")
    hd_text = trait_libs["human_design_profiles"].get(hdt, {}).get("relationships", "")
    ennea_text = trait_libs["enneagram_profiles"].get(f"Type {ennea}", {}).get("relationships", "")

    prompt = f"""
The user has these dominant traits in relationships:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}): {lp_text}
- Chinese Zodiac ({czn}): {cz_text}
- Human Design Type ({hdt}): {hd_text}
- Enneagram ({ennea}): {ennea_text}

Write a single paragraph explaining the **strengths** this person brings to relationships.

Speak directly to them using "you" language. Avoid “this person” or “they.”

Use a grounded, emotionally intelligent tone. No metaphors. No poetic language. No general coaching advice like “set boundaries” or “take care of yourself.”

Focus on strengths in how they emotionally bond, resolve tension, express care, and maintain relational depth.

This should feel like it’s coming from a grounded therapist — clear, compassionate, and insightful.
"""



    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        narrative_html = "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"
        return narrative_html
    except Exception as e:
        print("⚠️ Error in generate_relationship_strengths:", e)
        return "<p><em>[Strengths unavailable]</em></p>"

def generate_relationship_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates):
    sun = traits_dict["sun"]["undertone"]
    lp = traits_dict["life_path"]["undertone"]
    czn = traits_dict["chinese_zodiac"]["undertone"]
    hdt = traits_dict["human_design"]["undertone"]
    ennea = traits_dict["enneagram"]["undertone"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("relationships", "")
    lp_shadow = shadow_work_library["LifePaths"].get(lp, {}).get("shadow", "")
    cz_shadow = shadow_work_library["Chinese Zodiac"].get(czn, {}).get("shadow", "")
    hd_shadow = shadow_work_library["HumanDesign"].get(hdt, {}).get("shadow", "")
    ennea_shadow = shadow_work_library["Enneagram"].get(ennea, {}).get("shadow", "")

    # Gates summary (only if relevant)
    gate_texts = []
    relationship_gates = [39, 59, 22, 19, 46]
    for gate in human_design_gates:
        if gate in relationship_gates:
            gate_texts.append({
                39: "Gate 39 (provoking emotional truth)",
                59: "Gate 59 (intimacy and barrier-breaking)",
                22: "Gate 22 (emotional grace under pressure)",
                19: "Gate 19 (emotional sensitivity and need attunement)",
                46: "Gate 46 (embodiment and physical safety in love)"
            }[gate])

    gate_summary = ", ".join(gate_texts)


    prompt = f"""
You're writing the 'Shadowwork & Growth Opportunities' section for a relationship report.

This person’s **undertone traits** reflect their current emotional patterns and challenges in love.

Here are their undertone traits:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}) shadow: {lp_shadow}
- Chinese Zodiac ({czn}) shadow: {cz_shadow}
- Human Design ({hdt}) shadow: {hd_shadow}
- Enneagram ({ennea}) shadow: {ennea_shadow}

Their relevant Human Design gates are: {gate_summary}

Write 1–2 psychologically insightful paragraphs about how these traits influence their **emotional defenses, conflict patterns, and relational growth edges**.

Speak directly to the person using “you” language.

Do **not** list the traits or repeat them. Reflect how these influences interact and show up in behavior, especially under emotional stress.

Tone: grounded, emotionally honest, gently challenging — like a therapist offering constructive feedback. Avoid spiritual language, poetic metaphors, or general coaching advice.

Focus on:
- How their emotional defenses show up under stress (e.g. withdrawal, control, self-erasure)
- What emotional needs or fears trigger those patterns
- How greater self-awareness might support more authentic connection

You are not diagnosing — you're reflecting back their emotional survival strategies and how they might begin to soften or transform them.
"""


    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],  # <-- FIXED HERE
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        shadow_html = "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_relationship_shadows:", e)
        shadow_html = "<p><em>[Shadow narrative unavailable]</em></p>"
    return shadow_html

def generate_relationship_narrative(traits_dict, trait_libs, shadow_work_library, human_design_gates, client):
# 🔽 Now start a NEW narrative block (not nested)
    prompt = f"""
You are writing the opening 2–3 paragraph narrative for the 'Relationships & Love' section of a personalized astrology report.

This person was born with these traits (their core temperament in love and connection):
- Sun Sign: {traits_dict["sun"]["birth"]}
- Life Path: {traits_dict["life_path"]["birth"]}
- Chinese Zodiac: {traits_dict["chinese_zodiac"]["birth"]}
- Human Design Type: {traits_dict["human_design"]["birth"]}

Their current relational style is shaped by these dominant expressions:
- Sun Sign: {traits_dict["sun"]["dominant"]}
- Life Path: {traits_dict["life_path"]["dominant"]}
- Chinese Zodiac: {traits_dict["chinese_zodiac"]["dominant"]}
- Human Design: {traits_dict["human_design"]["dominant"]}
- Enneagram: {traits_dict["enneagram"]["dominant"]}

Their emotional undercurrents and relational defenses are reflected in these undertone traits:
- Sun Sign: {traits_dict["sun"]["undertone"]}
- Life Path: {traits_dict["life_path"]["undertone"]}
- Chinese Zodiac: {traits_dict["chinese_zodiac"]["undertone"]}
- Human Design: {traits_dict["human_design"]["undertone"]}
- Enneagram: {traits_dict["enneagram"]["undertone"]}

Write 2–3 paragraphs exploring how this person emotionally shows up in love and intimacy — especially how their dominant and undertone traits influence trust, conflict, closeness, and boundaries.

Focus on:
- How their early emotional design relates to their current patterns in relationships
- Where emotional habits (like avoidance, over-functioning, people-pleasing) emerge
- The emotional tension between their desire for closeness and their self-protective instincts


🛑 Do not name any traits or systems (e.g. “Sun sign” or “Type 5”). Do not recap or list traits. Instead, interpret how their full trait pattern converges into a relational style.

Avoid:
- Repeating emotional themes
- Vague advice like “take care of yourself” or “set boundaries”
- Mysticism, metaphors, or poetic language
Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
This honors the user's unique identity and avoids misidentification.

✅ Use “you” voice.
✅ Sound like a psychologically trained guide offering honest, clear insight.
✅ Anchor everything in emotional behavior — how they actually show up in love.
"""


    response = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.85,
    )

    response_text = response.choices[0].message.content
    narrative_html = "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"


    ### 🟢 Strengths
    strength_block = generate_relationship_strengths(traits_dict, trait_libs)

    ### 🔴 Shadow
    shadow_block = generate_relationship_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates)

    print("Narrative HTML:", narrative_html is not None)
    print("Strength Block:", strength_block is not None)
    print("Shadow Block:", shadow_block is not None)

    ### 💥 Final Synthesis (Mic Drop)
    prompt_synthesis = f"""
Write a 3-paragraph final reflection titled "This Means This is You" to close the 'Relationships & Love' section of a personalized astrology report.

You are integrating everything previously explored — the user’s dominant and undertone traits, emotional patterns, relational strengths, and growth edges.

🛑 Do NOT repeat or summarize earlier content. Instead, distill a fresh emotional truth — what all these patterns *mean* when taken together.

Tone: grounded, intimate, emotionally intelligent. No mysticism, metaphors, or poetic flourishes.

Use “you” language. Speak as if offering a deeply personal insight to the reader — something they’ve maybe felt but never fully articulated.

Focus on:
- The dynamic tension between how they love and how they protect themselves
- What is uniquely complex, resilient, or tender about the way they form connections
- What they may not realize about their emotional habits — and how awareness can open deeper, more authentic love

End with a quiet sense of insight and closure — like a therapist leaving them with something sacred to carry forward.
"""


    full_context = (narrative_html or "") + "\n\n" + (strength_block or "") + "\n\n" + (shadow_block or "")
    try:
        response2 = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "You are a skilled narrative astrologer and emotional interpreter."},
                {"role": "user", "content": prompt_synthesis + "\n\n" + full_context}
            ],
            temperature=0.9,
        )
        final_synthesis = "<div class='insight-box'><p>" + response2.choices[0].message.content.replace("\n\n", "</p><p>") + "</p></div>"
    except Exception as e:
        print("⚠️ Error in final synthesis:", e)
        final_synthesis = "<p><em>[Final synthesis unavailable]</em></p>"

    ### Final HTML block
    return f"""
    <div class="ai-generated">
        {narrative_html.strip()}

        <h3 style="margin-bottom: 0;">Strengths You Bring to Relationships</h3>
        {strength_block.strip()}

        <h3 style="margin-top: 20px; margin-bottom: 0;">Shadowwork & Growth Opportunities</h3>
        {shadow_block.strip()}

        <h3 style="margin-top: 20px; margin-bottom: 6px;">This Means This is You</h3>
        <p style="margin: 0;">{final_synthesis.strip()}</p>
    </div>
    """

# ----------------- MONEY NARRATIVE ---------------
def generate_money_strengths(traits_dict, trait_libs):
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("money", "")
    lp_text = trait_libs["life_path_profiles"].get(lp, {}).get("money", "")
    cz_text = trait_libs["chinese_zodiac_profiles"].get(czn, {}).get("money", "")
    hd_text = trait_libs["human_design_profiles"].get(hdt, {}).get("money", "")
    ennea_text = trait_libs["enneagram_profiles"].get(f"Type {ennea}", {}).get("money", "")

    prompt = f"""
You are writing the 'Money & Prosperity' section of a personalized astrology report.

This person expresses the following dominant traits in how they earn, spend, save, and relate to financial security:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}): {lp_text}
- Chinese Zodiac ({czn}): {cz_text}
- Human Design Type ({hdt}): {hd_text}
- Enneagram ({ennea}): {ennea_text}

Write a **single paragraph** describing the financial strengths this person naturally brings into the world. 

✅ Speak directly to them using “you” voice.  
🚫 Do not name or list traits or systems.

Tone: grounded, emotionally intelligent, psychologically clear — like a therapist who understands your internal money wiring.

Focus on:
- How you think about and move with money, security, and value
- Your strengths in earning, saving, giving, or receiving
- The emotional intelligence you bring to financial decision-making
- The unique way you create prosperity while staying true to your values

Avoid:
- Trait listing, mysticism, poetic or metaphorical phrasing
- Coaching language (“abundance,” “manifest,” etc.)
- General advice or cliché phrases (“trust your instincts,” “let go of fear”)

This should feel like a calm and clear reflection of how your dominant patterns positively express through your financial life.
"""


    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        return "<p>" + response.choices[0].message.content.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_money_strengths:", e)
        return "<p><em>[Money strengths unavailable]</em></p>"

def generate_money_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates):
    sun = traits_dict["sun"]["undertone"]
    lp = traits_dict["life_path"]["undertone"]
    czn = traits_dict["chinese_zodiac"]["undertone"]
    hdt = traits_dict["human_design"]["undertone"]
    ennea = traits_dict["enneagram"]["undertone"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("money", "")
    lp_shadow = shadow_work_library["LifePaths"].get(lp, {}).get("shadow", "")
    cz_shadow = shadow_work_library["Chinese Zodiac"].get(czn, {}).get("shadow", "")
    hd_shadow = shadow_work_library["HumanDesign"].get(hdt, {}).get("shadow", "")
    ennea_shadow = shadow_work_library["Enneagram"].get(ennea, {}).get("shadow", "")

    gate_texts = []
    money_gates = [21, 45, 14, 2, 54]
    for gate in human_design_gates:
        if gate in money_gates:
            gate_texts.append({
                21: "Gate 21 (control over resources)",
                45: "Gate 45 (leadership in prosperity)",
                14: "Gate 14 (creating wealth through doing what you love)",
                2:  "Gate 2 (direction of resources)",
                54: "Gate 54 (ambition and transformation through material success)"
            }[gate])

    gate_summary = ", ".join(gate_texts)

    prompt = f"""You are writing the 'Shadowwork & Financial Growth Edges' section of a Money & Prosperity astrology report.

This person’s **undertone traits** reflect emotional defenses, reactive behaviors, and financial stress patterns that may show up under pressure.

Their underlying emotional shadows are:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}) shadow: {lp_shadow}
- Chinese Zodiac ({czn}) shadow: {cz_shadow}
- Human Design ({hdt}) shadow: {hd_shadow}
- Enneagram ({ennea}) shadow: {ennea_shadow}

They also carry the following Human Design gates related to money: {gate_summary}

Write 1–2 emotionally grounded paragraphs explaining how these traits **converge** into a distinct emotional money pattern.

Speak directly to them using “you” voice.  
🚫 Do not name or list traits or systems.

Tone: clear, gently challenging, psychologically insightful — like a therapist reflecting back survival strategies around money.

Focus on:
- Emotional roots of scarcity, control, avoidance, or overgiving
- What triggers cycles of overspending, withholding, or burnout
- How old protective habits now undermine financial ease
- What these habits are trying to protect — and what awareness might unlock

Avoid:
- Trait listing, mystical or metaphorical language
- Generic self-help advice (“trust the flow,” “release blocks”)
- Repetition of emotional themes already covered in other sections

This should feel like a real and useful mirror of how stress-based financial habits were formed — and how they might gently evolve."""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        return "<p>" + response.choices[0].message.content.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_money_shadows:", e)
        return "<p><em>[Money shadow narrative unavailable]</em></p>"

def generate_money_narrative(traits_dict, trait_libs, shadow_work_library, human_design_gates, client):
    prompt = f"""
You are writing the opening 2–3 paragraph narrative for the 'Money & Prosperity' section of a personalized astrology report.

This person’s financial instincts and behaviors are shaped by the **unique convergence** of:
- Four core birth traits (emotional temperament around security and survival)
- Five dominant traits (conscious financial attitudes and preferences)
- Five undertone traits (reactive or stress-based emotional patterns)

Trait overview:
- Birth traits: Sun {traits_dict["sun"]["birth"]}, Life Path {traits_dict["life_path"]["birth"]}, Chinese Zodiac {traits_dict["chinese_zodiac"]["birth"]}, Human Design {traits_dict["human_design"]["birth"]}
- Dominant traits: Sun {traits_dict["sun"]["dominant"]}, Life Path {traits_dict["life_path"]["dominant"]}, Chinese Zodiac {traits_dict["chinese_zodiac"]["dominant"]}, Human Design {traits_dict["human_design"]["dominant"]}, Enneagram {traits_dict["enneagram"]["dominant"]}
- Undertone traits: Sun {traits_dict["sun"]["undertone"]}, Life Path {traits_dict["life_path"]["undertone"]}, Chinese Zodiac {traits_dict["chinese_zodiac"]["undertone"]}, Human Design {traits_dict["human_design"]["undertone"]}, Enneagram {traits_dict["enneagram"]["undertone"]}

Write 2–3 psychologically insightful paragraphs that interpret **how this layered pattern** affects the person’s relationship with money.

Speak directly to them using “you” voice.  
🚫 Do NOT name or list traits or systems.

Focus on:
- Emotional patterns in earning, saving, spending, or control
- Internal tension between safety and freedom, independence and support
- What habits reflect fear vs what reflects alignment
- How these patterns either honor or resist your deeper design

Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
This honors the user's unique identity and avoids misidentification.

Tone: grounded, emotionally intelligent, and specific.  
This should feel like a financial therapist describing your emotional fingerprint with clarity and compassion — no fluff, no mysticism.
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        narrative_html = "<p>" + response.choices[0].message.content.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in main money narrative:", e)
        narrative_html = "<p><em>[Main money narrative unavailable]</em></p>"

    strength_block = generate_money_strengths(traits_dict, trait_libs)
    shadow_block = generate_money_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates)

    prompt_synthesis = """
Write a 3-paragraph final reflection titled "This Means This is You" to close the 'Money & Prosperity' section of a personalized astrology report.

This section should **integrate all previous insights** — including the person’s financial temperament, dominant expressions, emotional defenses, core strengths, and reactive stress patterns — into a single, cohesive reflection.

🛑 Do NOT summarize what’s already been said.  
✅ Instead, offer fresh insight — a deeper truth about how this person relates to money on an emotional level.

Focus on:
- The internal tension between ambition and peace, generosity and control, scarcity and self-worth
- How emotional habits influence earning, saving, giving, receiving, and rest
- What is uniquely wise, adaptive, or resilient about their financial instincts
- What they may not yet fully see about how money mirrors deeper emotional patterns

Speak directly to them using “you” voice.  
Tone: emotionally grounded, intimate, and psychologically insightful — like a financial therapist offering clear truth without judgment.

End with a final sentence that offers closure and calm recognition — not advice, but a lasting awareness they can carry forward.
"""


    full_context = narrative_html + "\n\n" + strength_block + "\n\n" + shadow_block

    try:
        response2 = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "You are a skilled narrative astrologer and emotional interpreter."},
                {"role": "user", "content": prompt_synthesis + "\n\n" + full_context}
            ],
            temperature=0.88,
        )
        final_synthesis = "<div class='insight-box'><p>" + response2.choices[0].message.content.replace("\n\n", "</p><p>") + "</p></div>"
    except Exception as e:
        print("⚠️ Error in final money synthesis:", e)
        final_synthesis = "<p><em>[Final synthesis unavailable]</em></p>"

    return f"""
    <div class="ai-generated">
        {narrative_html}

        <h3>Strengths You Bring to Earning & Receiving</h3>
        {strength_block}

        <h3>Shadowwork & Financial Growth Edges</h3>
        {shadow_block}

        <h3>This Means This is You</h3>
        {final_synthesis}
    </div>
    """

# ----------------- CAREER NARRATIVE ---------------
# ---- CAREER NARRATIVE BLOCK ---    
def generate_career_strengths(traits_dict, trait_libs):
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("career", "")
    lp_text = trait_libs["life_path_profiles"].get(lp, {}).get("career", "")
    cz_text = trait_libs["chinese_zodiac_profiles"].get(czn, {}).get("career", "")
    hd_text = trait_libs["human_design_profiles"].get(hdt, {}).get("career", "")
    ennea_text = trait_libs["enneagram_profiles"].get(f"Type {ennea}", {}).get("career", "")

    prompt = f"""
You are writing the 'Career & Vocation' section of a personalized astrology report.

This person has the following dominant traits related to work and purpose:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}): {lp_text}
- Chinese Zodiac ({czn}): {cz_text}
- Human Design Type ({hdt}): {hd_text}
- Enneagram ({ennea}): {ennea_text}

Write one paragraph that reflects the **core psychological strengths** they bring to their professional life.

Do NOT name or describe traits or systems. Do NOT list traits.

Use “you” language and emotionally intelligent tone.

Focus on:
- How they work best (focus, creativity, decision-making)
- How they relate to others (empathy, leadership, collaboration)
- What internal values drive motivation and career success
- Their instinctive gifts that show up in high-stakes or meaningful roles

Avoid:
- Resume-style phrasing
- Clichés like “you are a natural leader” or “you thrive under pressure”
- Coaching advice

The goal is a clear reflection of what makes this person’s work style emotionally intelligent and distinctive.
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        return "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_career_strengths:", e)
        return "<p><em>[Career strengths unavailable]</em></p>"

def generate_career_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates):
    sun = traits_dict["sun"]["undertone"]
    lp = traits_dict["life_path"]["undertone"]
    czn = traits_dict["chinese_zodiac"]["undertone"]
    hdt = traits_dict["human_design"]["undertone"]
    ennea = traits_dict["enneagram"]["undertone"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("career", "")
    lp_shadow = shadow_work_library["LifePaths"].get(lp, {}).get("shadow", "")
    cz_shadow = shadow_work_library["Chinese Zodiac"].get(czn, {}).get("shadow", "")
    hd_shadow = shadow_work_library["HumanDesign"].get(hdt, {}).get("shadow", "")
    ennea_shadow = shadow_work_library["Enneagram"].get(ennea, {}).get("shadow", "")

    # Only include relevant career gates
    gate_texts = []
    career_gates = [34, 54, 32, 44, 16]
    for gate in human_design_gates:
        if gate in career_gates:
            gate_texts.append({
                34: "Gate 34 (independent power and work drive)",
                54: "Gate 54 (ambition and material transformation)",
                32: "Gate 32 (career longevity and adaptability)",
                44: "Gate 44 (recognition of patterns and timing)",
                16: "Gate 16 (enthusiasm and skill mastery)"
            }[gate])

    gate_summary = ", ".join(gate_texts)

    prompt = f"""
You are writing the 'Shadowwork & Growth Edges' section for the Career & Vocation part of an astrology report.

This person’s undertone traits represent how they emotionally react to pressure, instability, or visibility at work.

Here are their undertone traits:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}) shadow: {lp_shadow}
- Chinese Zodiac ({czn}) shadow: {cz_shadow}
- Human Design ({hdt}) shadow: {hd_shadow}
- Enneagram ({ennea}) shadow: {ennea_shadow}

Their Human Design gates related to career are: {gate_summary}

Write 1–2 grounded, psychologically honest paragraphs exploring:
- How emotional defenses show up under stress at work
- Habits like over-functioning, conflict avoidance, invisibility, control, or burnout
- How these patterns serve as protection, and how awareness could shift them

🛑 Do not list or name traits/systems. Do not explain them individually.

✅ Speak in “you” language.  
✅ Sound like a career counselor or therapist — emotionally honest, non-judgmental.  
✅ Reflect their *unique emotional fingerprint at work*, not general advice.

Avoid spiritual phrases, poetic language, or coaching tips.
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        return "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_career_shadows:", e)
        return "<p><em>[Career shadow unavailable]</em></p>"

def generate_career_narrative(traits_dict, trait_libs, shadow_work_library, human_design_gates, client):
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    sun_u = traits_dict["sun"]["undertone"]
    lp_u = traits_dict["life_path"]["undertone"]
    czn_u = traits_dict["chinese_zodiac"]["undertone"]
    hdt_u = traits_dict["human_design"]["undertone"]
    ennea_u = traits_dict["enneagram"]["undertone"]

    prompt = f"""
You are writing the opening 2–3 paragraph narrative for the 'Career & Vocation' section of a personalized astrology report.

This person’s relationship to work is shaped by three layers of traits:
- Birth traits (core temperament)
- Dominant traits (current personality)
- Undertone traits (emotional defenses and stress patterns)

Trait snapshot:
- Birth: Sun {traits_dict["sun"]["birth"]}, Life Path {traits_dict["life_path"]["birth"]}, Chinese Zodiac {traits_dict["chinese_zodiac"]["birth"]}, Human Design {traits_dict["human_design"]["birth"]}
- Dominant: Sun {traits_dict["sun"]["dominant"]}, Life Path {traits_dict["life_path"]["dominant"]}, Chinese Zodiac {traits_dict["chinese_zodiac"]["dominant"]}, Human Design {traits_dict["human_design"]["dominant"]}, Enneagram {traits_dict["enneagram"]["dominant"]}
- Undertone: Sun {traits_dict["sun"]["undertone"]}, Life Path {traits_dict["life_path"]["undertone"]}, Chinese Zodiac {traits_dict["chinese_zodiac"]["undertone"]}, Human Design {traits_dict["human_design"]["undertone"]}, Enneagram {traits_dict["enneagram"]["undertone"]}

Write a 2–3 paragraph reflection on how these layers interact to shape:
- Their drive for meaning, safety, or recognition in work
- Their style of contribution (leadership, support, innovation, strategy, etc.)
- Internal emotional tension between ambition vs burnout, control vs harmony, or purpose vs obligation
- How their unique emotional design shows up in the way they relate to tasks, people, and expectations

🛑 Do NOT name traits or systems. Do NOT list or recap.

Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
This honors the user's unique identity and avoids misidentification.

✅ Speak directly to them using “you.”  
✅ Sound like a therapist — clear, emotionally intelligent, and observant.  
✅ Help them understand what their behaviors at work are *really about* — from an emotional lens.

Avoid coaching tips, spiritual themes, or poetic tone.
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        narrative_html = "<p>" + response.choices[0].message.content.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_relationship_shadows:", e)
        return "<p><em>[Shadow narrative unavailable]</em></p>"

    strength_block = generate_career_strengths(traits_dict, trait_libs)
    shadow_block = generate_career_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates)

    prompt_synthesis = f"""
Write a 3-paragraph final synthesis titled "This Means This is You at Work."

Draw on the full pattern of this person's career temperament — including their core design (birth traits), dominant work behaviors, and emotional undertones — to reveal how they actually operate in their professional life.

Focus on:
- Their emotional and behavioral patterns in career settings
- How they handle clarity, motivation, structure, and stress
- The dynamic tension between their deeper purpose and current career behaviors

Do NOT repeat or summarize earlier content. Do NOT list traits or mention system names.

Speak directly to them using "you" language. The tone should be clear, grounded, and emotionally intelligent — like a career coach offering insight they hadn’t fully seen before.

Your goal is to leave them with a deeper understanding of how they move through their work life — and what they might finally claim, release, or trust in order to grow.
"""
    full_context = (narrative_html or "") + "\n\n" + (strength_block or "") + "\n\n" + (shadow_block or "")
    try:
        response2 = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "You are a grounded psychological astrologer."},
                {"role": "user", "content": prompt_synthesis + "\n\n" + full_context}
            ],
            temperature=0.88,
        )
        final_synthesis = "<div class='insight-box'><p>" + response2.choices[0].message.content.replace("\n\n", "</p><p>") + "</p></div>"
    except Exception as e:
        print("⚠️ Error in final synthesis (career):", e)
        final_synthesis = "<p><em>[Career synthesis unavailable]</em></p>"

    return f"""
    <div class="ai-generated">
        {narrative_html}

        <h3>Strengths You Bring to Work</h3>
        {strength_block}

        <h3>Shadowwork & Growth Edges</h3>
        {shadow_block}

        <h3>This Means This is You at Work</h3>
        {final_synthesis}
    </div>
    """

# ----------------- FAMILY NARRATIVE BLOCK ---------------
def generate_family_strengths(traits_dict, trait_libs): 
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("family", "")
    lp_text = trait_libs["life_path_profiles"].get(lp, {}).get("family", "")
    cz_text = trait_libs["chinese_zodiac_profiles"].get(czn, {}).get("family", "")
    hd_text = trait_libs["human_design_profiles"].get(hdt, {}).get("family", "")
    ennea_text = trait_libs["enneagram_profiles"].get(f"Type {ennea}", {}).get("family", "")

    prompt = f"""
You are writing the 'Strengths You Bring to Family' section of a personalized astrology report.

This person has the following dominant traits that influence how they show up in family relationships:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}): {lp_text}
- Chinese Zodiac ({czn}): {cz_text}
- Human Design Type ({hdt}): {hd_text}
- Enneagram ({ennea}): {ennea_text}

Write a single paragraph that explains the **strengths** they bring to family roles, caregiving, and emotional presence.

Speak directly to them using “you.” Do not refer to traits, systems, or labels. Do not list traits.

Focus on:
- How they contribute to emotional safety and belonging in family systems
- Their instincts around protection, harmony, guidance, or support
- Their ability to communicate, nurture, or show up during conflict or need

Tone: grounded, emotionally intelligent, and insight-driven — like a therapist or family coach who sees their value clearly.

Avoid poetic, mystical, or abstract language. Speak plainly with heart.
"""
    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        return "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_family_strengths:", e)
        return "<p><em>[Family strengths unavailable]</em></p>"

def generate_family_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates):
    sun = traits_dict["sun"]["undertone"]
    lp = traits_dict["life_path"]["undertone"]
    czn = traits_dict["chinese_zodiac"]["undertone"]
    hdt = traits_dict["human_design"]["undertone"]
    ennea = traits_dict["enneagram"]["undertone"]

    sun_text = trait_libs["sun_sign_profiles"].get(sun, {}).get("family", "")
    lp_shadow = shadow_work_library["LifePaths"].get(lp, {}).get("shadow", "")
    cz_shadow = shadow_work_library["Chinese Zodiac"].get(czn, {}).get("shadow", "")
    hd_shadow = shadow_work_library["HumanDesign"].get(hdt, {}).get("shadow", "")
    ennea_shadow = shadow_work_library["Enneagram"].get(ennea, {}).get("shadow", "")

    gate_texts = []
    family_gates = [27, 50, 37, 40]
    for gate in human_design_gates:
        if gate in family_gates:
            gate_texts.append({
                27: "Gate 27 (nurturing and responsibility)",
                50: "Gate 50 (values and protective instincts)",
                37: "Gate 37 (community bonding and harmony)",
                40: "Gate 40 (providing through hard work)"
            }[gate])
    gate_summary = ", ".join(gate_texts)

    prompt = f"""
You are writing the 'Shadowwork & Growth Edges' section of a personalized astrology report focused on family dynamics.

This person’s current growth challenges in family relationships are shaped by these undertone traits:
- Sun Sign ({sun}): {sun_text}
- Life Path ({lp}) shadow: {lp_shadow}
- Chinese Zodiac ({czn}) shadow: {cz_shadow}
- Human Design ({hdt}) shadow: {hd_shadow}
- Enneagram ({ennea}) shadow: {ennea_shadow}

They also have the following active Human Design gates relevant to family: {gate_summary}

Write 1–2 grounded paragraphs describing this person’s **emotional and relational growth edges in family systems**.

Speak directly to them using “you.” Never refer to traits or systems. Avoid listing. Instead, interpret the emotional patterns that emerge from this trait mix.

Focus on:
- Roles they tend to absorb or resist (caretaker, rebel, peacekeeper, etc.)
- Emotional coping patterns like control, withdrawal, guilt, or overfunctioning
- Intergenerational behaviors they may unconsciously repeat — and how they can evolve

Tone: honest, psychologically clear, emotionally attuned. Avoid mysticism, metaphor, or cosmic framing.
"""
    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        return "<p>" + response_text.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in generate_family_shadows:", e)
        return "<p><em>[Family shadowwork unavailable]</em></p>"

def generate_family_narrative(traits_dict, trait_libs, shadow_work_library, human_design_gates, client):
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    sun_u = traits_dict["sun"]["undertone"]
    lp_u = traits_dict["life_path"]["undertone"]
    czn_u = traits_dict["chinese_zodiac"]["undertone"]
    hdt_u = traits_dict["human_design"]["undertone"]
    ennea_u = traits_dict["enneagram"]["undertone"]

    prompt = f"""
You are writing the 'Family & Roots' section of a personalized astrology report.

This person was born with:
- Sun Sign: {traits_dict["sun"]["birth"]}
- Life Path: {traits_dict["life_path"]["birth"]}
- Chinese Zodiac: {traits_dict["chinese_zodiac"]["birth"]}
- Human Design Type: {traits_dict["human_design"]["birth"]}

Their current dominant family style reflects:
- Sun Sign: {traits_dict["sun"]["dominant"]}
- Life Path: {traits_dict["life_path"]["dominant"]}
- Chinese Zodiac: {traits_dict["chinese_zodiac"]["dominant"]}
- Human Design: {traits_dict["human_design"]["dominant"]}
- Enneagram: {traits_dict["enneagram"]["dominant"]}

Their emotional undercurrents and reactive family patterns are shaped by:
- Sun Sign: {traits_dict["sun"]["undertone"]}
- Life Path: {traits_dict["life_path"]["undertone"]}
- Chinese Zodiac: {traits_dict["chinese_zodiac"]["undertone"]}
- Human Design: {traits_dict["human_design"]["undertone"]}
- Enneagram: {traits_dict["enneagram"]["undertone"]}

Please write a 2–3 paragraph narrative that synthesizes how this person’s full energetic fingerprint shapes their experience of family.

Speak directly to them using “you.” Do not list traits or name systems in the output.

Interpret how:
- Their birth design shaped their original family role and sense of belonging
- Their dominant traits shape how they currently show up in family systems
- Their undertones influence emotional reactivity, inherited habits, or intergenerational healing

Avoid repeating earlier themes from other report sections. Focus on unique emotional patterns specific to family life.
Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
This honors the user's unique identity and avoids misidentification.

The tone should be psychologically grounded, emotionally attuned, and completely free of metaphors or cosmic phrasing. Think like a wise therapist reflecting someone’s real patterns in family with clear insight.
"""



    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        narrative_html = "<p>" + response.choices[0].message.content.replace("\n\n", "</p><p>") + "</p>"
    except Exception as e:
        print("⚠️ Error in family narrative:", e)
        narrative_html = "<p><em>[Family narrative unavailable]</em></p>"

    ### Strengths & Shadow
    strength_block = generate_family_strengths(traits_dict, trait_libs)
    shadow_block = generate_family_shadows(traits_dict, trait_libs, shadow_work_library, human_design_gates)

    ### Final Synthesis
    prompt_synthesis = """
Write a final 3-paragraph synthesis titled "This Means This is You" to close the Family & Roots section of a personalized astrology report.

This section should integrate all previous content — birth dynamics, dominant roles, and emotional undertones — into a fresh reflection that brings clarity and meaning to how this person operates in their family system today.

This is not a summary. It’s a mirror moment: offer new insight into how their inherited roles, emotional habits, and relational behaviors shape who they’ve become.

Speak directly to them using “you.” Do not name traits or systems. Avoid astrology jargon, poetic language, or recap.

Tone: emotionally grounded, psychologically reflective, and gently honest — like a trusted guide helping them see the deeper truth of their evolution in family life.
"""
    full_context = (narrative_html or "") + "\n\n" + (strength_block or "") + "\n\n" + (shadow_block or "")

    try:
        response2 = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "You are a skilled narrative astrologer and emotional interpreter."},
                {"role": "user", "content": prompt_synthesis + "\n\n" + full_context}
            ],
            temperature=0.88,
        )
        final_synthesis = "<div class='insight-box'><p>" + response2.choices[0].message.content.replace("\n\n", "</p><p>") + "</p></div>"
    except Exception as e:
        print("⚠️ Error in final synthesis (family):", e)
        final_synthesis = "<p><em>[Final family synthesis unavailable]</em></p>"

    return f"""
    <div class="ai-generated">
        {narrative_html}

        <h3>Strengths You Bring to Family Life</h3>
        {strength_block}

        <h3>Shadowwork & Growth in Family Patterns</h3>
        {shadow_block}

        <h3>This Means This is You</h3>
        {final_synthesis}
    </div>
    """

 # ----------------- CORE GIFT & CALLING -----------------
def generate_core_gift_and_calling(traits_dict, moon_sign, moon_sun_aspect, sun_transits, client):
    sun = traits_dict["sun"]["dominant"]
    lp = traits_dict["life_path"]["dominant"]
    czn = traits_dict["chinese_zodiac"]["dominant"]
    hdt = traits_dict["human_design"]["dominant"]
    ennea = traits_dict["enneagram"]["dominant"]

    # Include themed transit insights
    def get_transit_insights(transits):
        insights = []
        for t in transits:
            if isinstance(t, dict):
                key = f"sun {t.get('aspect', '').lower()}"
                label = f"Sun {t.get('aspect', '').title()} {t.get('planet', '')}"
            else:
                key = " ".join(t.lower().split()[:2])
                label = t

            if key in transit_meanings:
                meaning = transit_meanings[key]
                insights.append(f"{label}: {meaning['theme']}. {meaning['guidance']}")
            else:
                insights.append(label)
        return insights

    transit_insights = get_transit_insights(sun_transits)
    transits_text = "\n".join(transit_insights)

    prompt = f"""
You are writing the "Core Gift and Calling" section of a personalized astrology report.

This is the most integrative and soulful part of the report. It should reflect the person’s **energetic fingerprint** — the deep convergence of their emotional architecture, core strengths, and innate purpose.

Use these traits to guide the narrative:
- Sun Sign: {sun}
- Life Path Number: {lp}
- Enneagram Type: {ennea}
- Human Design Type: {hdt}
- Chinese Zodiac: {czn}
- Moon Sign: {moon_sign}
- Moon–Sun Aspect: {moon_sun_aspect}
- Planetary Transits on Birth Day:
{transits_text}

Write three emotionally intelligent paragraphs that:
1. Reflect on the person’s **spiritual and emotional wiring** — how their birth design shapes their inner compass and how they move through the world
2. Describe the **type of contribution** someone with this exact makeup is built for — what they’re here to offer, express, or embody
3. Deliver a reverent **closing synthesis** that affirms why this particular combination of traits is rare, powerful, and meaningful

Then close with:
- One sentence naming their **Core Gift** — the essence of what they bring to others
- One sentence naming their **Calling** — how that gift is meant to be expressed or shared

Speak to the person using “you.” Avoid mysticism, astrological jargon, or abstract metaphors. Use second-person voice and emotionally resonant language — like a grounded soul coach holding up a mirror to what’s already true.
"""


    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85,
        )
        response_text = response.choices[0].message.content
        return "<div class='ai-generated'><p>" + response_text.replace("\n\n", "</p><p>") + "</p></div>"
    except Exception as e:
        print("⚠️ Error generating Core Gift and Calling:", e)
        return "<div class='ai-generated'><p><em>[Core Gift and Calling unavailable]</em></p></div>"
            
# ------- NEW MOON CHART BLOCK --------
def get_real_moon_phases(jd, months=12, offset=0):
    """
    Calculate the Moon phase (New, Waxing, Full, Waning) for each month,
    starting from the current date + offset.
    """
    phases = []
    start_date = datetime.now() + relativedelta(months=offset)

    for i in range(months):
        forecast_date = start_date + relativedelta(months=i)
        jd_month = swe.julday(forecast_date.year, forecast_date.month, 15)

        sun_pos = swe.calc_ut(jd_month, swe.SUN)[0][0]
        moon_pos = swe.calc_ut(jd_month, swe.MOON)[0][0]
        angle = (moon_pos - sun_pos) % 360

        if angle < 45:
            phases.append("New")
        elif angle < 90:
            phases.append("Waxing")
        elif angle < 135:
            phases.append("Full")
        elif angle < 180:
            phases.append("Waning")
        elif angle < 225:
            phases.append("New")
        elif angle < 270:
            phases.append("Waxing")
        elif angle < 315:
            phases.append("Full")
        else:
            phases.append("Waning")

    return phases

# ----- Moon Phase Icon -----
def get_moon_phase_icon(date_obj):
    MOON_PHASE_ICONS = {
        "New Moon": "https://i.imgur.com/NmSKgoL.png",
        "First Quarter": "https://i.imgur.com/RZOBg2D.png",
        "Full Moon": "https://i.imgur.com/wHByWVi.png",
        "Last Quarter": "https://i.imgur.com/rz9jwn8.png"
    }

    known_full_moon = datetime(2024, 2, 24)
    days_since = (date_obj - known_full_moon).days % 29.53

    if days_since < 1.5 or days_since > 28:
        return "New Moon", MOON_PHASE_ICONS["New Moon"]
    elif days_since < 7:
        return "First Quarter", MOON_PHASE_ICONS["First Quarter"]
    elif days_since < 14:
        return "Full Moon", MOON_PHASE_ICONS["Full Moon"]
    elif days_since < 21:
        return "Last Quarter", MOON_PHASE_ICONS["Last Quarter"]
    else:
        return "New Moon", MOON_PHASE_ICONS["New Moon"]

def get_shadow_actions(traits):
    results = []
    for system, value in traits.items():
        if system == "Sun" and value in shadow_work_library["SunSigns"]:
            results.append(f"<b>{value} (Sun Sign):</b> {shadow_work_library['SunSigns'][value]}")
        elif system == "LifePath" and int(value) in shadow_work_library["LifePaths"]:
            results.append(f"<b>Life Path {value}:</b> {shadow_work_library['LifePaths'][int(value)]}")
        elif system == "ChineseZodiac" and value in shadow_work_library["ChineseZodiac"]:
            results.append(f"<b>{value} (Chinese Zodiac):</b> {shadow_work_library['ChineseZodiac'][value]}")
        elif system == "Enneagram" and int(value) in shadow_work_library["Enneagram"]:
            results.append(f"<b>Enneagram {value}:</b> {shadow_work_library['Enneagram'][int(value)]}")
        elif system == "HumanDesign" and value in shadow_work_library["HumanDesign"]:
            results.append(f"<b>{value} (Human Design):</b> {shadow_work_library['HumanDesign'][value]}")
    return "<br>".join(results)

# ------- Journal Prompts MOON THEME -----------
def get_monthly_journal_prompt(birth_traits, moon_theme, used_prompts, trait_scores):
    trait_order = ["Sun", "Life Path", "Chinese Zodiac", "Enneagram", "Human Design"]
    lib_map = {
        "Sun": "SunSigns",
        "Life Path": "LifePaths",
        "Chinese Zodiac": "ChineseZodiac",
        "Enneagram": "Enneagram",
        "Human Design": "HumanDesign"
    }
    key_map = {
        "Sun": "sun",
        "Life Path": "life_path",
        "Chinese Zodiac": "chinese_zodiac",
        "Enneagram": "enneagram",
        "Human Design": "human_design"
    }

    poetic_fallbacks = [
        "How can I meet this moment with curiosity and self-trust?",
        "What emotion have I been avoiding?",
        "Where is there beauty in the breakdown?",
        "What would I say if I were completely honest today?",
        "What needs my attention beneath the surface?",
        "How do I soothe myself without hiding from truth?",
        "Where in my body am I holding a story I haven't spoken?",
        "What’s the truth I’ve been circling but not claiming?",
        "What feeling have I mistaken for fact?",
        "Where am I ready to trade fear for honesty?",
        "How does silence speak in my life?",
        "What part of me is still waiting to be heard?",
        "What have I softened to that used to scare me?",
        "Where can I be more present, not perfect?"
    ]

    is_shadow = any(k in moon_theme.lower() for k in [
        "reactivity", "alchemy", "crisis", "boundaries", "opposition", "pressure", "sensitivity"
    ])
    prompt_type = "shadow_journal_prompts" if is_shadow else "celebration_prompts"

    # Tier 1: Prompt from birth trait
    for trait_type in trait_order:
        lib_key = lib_map.get(trait_type)
        birth_value = birth_traits.get(trait_type)
        if not lib_key or not birth_value:
            continue
        try:
            trait_key = int(str(birth_value).replace("Type ", "")) if lib_key in ["LifePaths", "Enneagram"] else birth_value
        except:
            continue
        block = shadow_work_library.get(lib_key, {}).get(trait_key, {})
        if block:
            available = [p for p in block.get(prompt_type, []) if p not in used_prompts]
            if available:
                chosen = random.choice(available)
                used_prompts.add(chosen)
                return chosen

    # Tier 2: Prompt from undertone trait
    for trait_type in trait_order:
        std_key = key_map.get(trait_type)
        system_scores = trait_scores.get(std_key, {})
        undertone = system_scores.get("undertone") or system_scores.get("dominant")
        if not undertone:
            continue
        lib_key = lib_map.get(trait_type)
        try:
            undertone_key = int(str(undertone).replace("Type ", "")) if lib_key in ["LifePaths", "Enneagram"] else undertone
        except:
            continue
        block = shadow_work_library.get(lib_key, {}).get(undertone_key, {})
        if block:
            available = [p for p in block.get(prompt_type, []) if p not in used_prompts]
            if available:
                chosen = random.choice(available)
                used_prompts.add(chosen)
                return chosen

    # Tier 3: Fallback poetic
    available_fallbacks = [p for p in poetic_fallbacks if p not in used_prompts]
    if available_fallbacks:
        chosen = random.choice(available_fallbacks)
        used_prompts.add(chosen)
        return chosen
    return "What part of you still needs grace to grow?"

# ==== CHART IMAGE INFO ====
import base64
import matplotlib.pyplot as plt
import numpy as np
from matplotlib.patches import Patch
from matplotlib.ticker import MaxNLocator


# --------------------------------------------
# HELPER: Format growth actions (bullets)
def format_growth_actions(raw: str) -> str:
    lines = re.split(r"\d+\.\s+|•\s+|-+\s+", raw)
    items = []
    for line in lines:
        line = line.strip()
        if not line:
            continue
        parts = line.split(":", 1)
        if len(parts) == 2:
            items.append(f"<li><strong>{parts[0].strip()}:</strong> {parts[1].strip()}</li>")
        else:
            items.append(f"<li>{line}</li>")
    return "<ul style='margin-top: 4px; margin-bottom: 12px; padding-left: 20px;'>\n" + "\n".join(items) + "\n</ul>"

# --------------------------------------------
def render_synchronicity_forecast_html(sync_data, aspects_list, birth_traits, standardized_scores):
    used_prompts = set()
    from datetime import datetime, timedelta  # ⬅️ Also include timedelta
    html_output = "<div class='forecast-section'>"
    html_output += "<h2>🌙 Emotional Forecast by Month</h2>"

    today = datetime.today()
    for i in range(12):
        forecast_date = today.replace(day=15) + timedelta(days=30*i)
        month_name = forecast_date.strftime("%B")
        moon_phase, icon_url = get_moon_phase_icon(forecast_date)

        # ✅ Emoji instead of image
        icon = moon_phase_emojis.get(moon_phase, "🌙")

        # Get transit info
        transit, theme, guidance = get_moon_transit_by_month(i)

        # Grab entry data
        entry = sync_data[i]
        tightest = entry.get("tightest_aspect", "Unknown")
        orb = entry.get("aspect_orb", "")
        aspect_info = f"<p><strong>Closest Aspect:</strong> {tightest} ({orb}°)</p>" if tightest != "Unknown" else ""

        aspect_label = tightest.lower()
        is_best_day = any(k in aspect_label for k in ["conjunct", "trine"])
        best_day_badge = "🌟 <strong>Best Emotional Day This Month</strong><br>" if is_best_day else ""

        journal_prompt = get_monthly_journal_prompt(birth_traits, theme, used_prompts, standardized_scores)

        html_output += f"""
        <div class='monthly-forecast'>
            <h3>{month_name}</h3>
            <div class='moon-meta'>
                <span><strong>{icon} {moon_phase}</strong></span>
            </div>
            <p><em>{transit}</em><br>
            {theme} — {guidance}</p>
            {aspect_info}
            {best_day_badge}
            <p><strong>📓 Journal Prompt:</strong> {journal_prompt}</p>
        </div>
        <hr>
        """

    html_output += "</div>"
    return html_output

def generate_combined_synchronicities(trait_scores, sun_sign, real_transits, traits_dict, start_month_offset):
    """
    Combines quiz-derived dominant traits with lunar and solar transit data to generate monthly emotional themes.
    """

    months = len(real_transits)
    today = datetime.today()

    trait_keys = {
        "sun": "sun",
        "life_path": "life_path",
        "chinese_zodiac": "chinese_zodiac",
        "enneagram": "enneagram",
        "human_design": "human_design"
    }

    top_traits_by_system = {
    "sun": [traits_dict["sun"]["undertone"], traits_dict["sun"]["dominant"]],
    "life_path": [traits_dict['life_path']['undertone'], traits_dict['life_path']['dominant']],
    "chinese_zodiac": [traits_dict["chinese_zodiac"]["undertone"], traits_dict["chinese_zodiac"]["dominant"]],
    "enneagram": [traits_dict['enneagram']['undertone'], traits_dict['enneagram']['dominant']],
    "human_design": [traits_dict["human_design"]["undertone"], traits_dict["human_design"]["dominant"]],
    }

    monthly_data = []
    overall_domain_counter = Counter()
    aspects_list = []
    tightest_aspects = []

    print("🧠 Top Traits by System:")
    for category, traits in top_traits_by_system.items():
        print(f" - {category}: {traits}")

    # Aspect strength priority
    aspect_priority = {
        "conjunct": 5,
        "opposition": 4,
        "square": 3,
        "trine": 2,
        "sextile": 1,
        "aspecting": 0
    }
    print(f"📉 Number of months to process: {months}")
    for m in range(months):
        print(f"✅ Appending data for Month {m+1}")
        print(f"⏳ Processing month {m+1}/{months}")  # ← ADD THIS
        domain_counter = Counter()
        print(f"\n🟡 Month {m+1}")

        for category, system_traits in top_traits_by_system.items():
            if system_traits:
                trait = system_traits[m % len(system_traits)]
                print(f"🔍 Raw Trait for {category}: '{trait}'")
                domain = map_trait_to_domain(trait)
                print(f" - {category}: {trait} → {domain}")
                if domain:
                    domain_counter[domain] += 1

        aspects = real_transits[m].get("aspects", [])
        print(f"📆 Month {m+1} — Raw Aspects: {aspects}")

        if aspects:
            tightest = sorted(aspects, key=lambda x: x[2])[0]
            print(f"🎯 Tightest Aspect: {tightest}")
            tightest_aspects.append((f"{tightest[0]} {tightest[1]}", tightest[2]))

            dominant = sorted(aspects, key=lambda x: -aspect_priority.get(x[1], 0))[0]
            aspects_list.append(f"{dominant[0]} {dominant[1]}")
        else:
            print(f"⚠️ No aspects found for Month {m+1}")
            tightest_aspects.append(("Unknown", 999))
            aspects_list.append("aspecting")

        overall_domain_counter.update(domain_counter)
        domains = list(domain_counter.keys())
        domain_score = len(domains)

        positions = real_transits[m].get("positions", {})
        sun_deg = positions.get("Sun")
        moon_deg = positions.get("Moon")
        transit_score = calculate_transit_score(sun_deg, positions) or 0

        moon_aspect = get_moon_aspect_to_sun(sun_deg, moon_deg)
        moon_transit_label = f"Moon {moon_aspect}"

        # ✅ Use only the offset in the transit generation, not again here
        forecast_month_index = (today.month + m - 1) % 12 + 1
        forecast_year = today.year + ((today.month + m - 1) // 12)
        forecast_date = datetime(forecast_year, forecast_month_index, 15)

        try:
            phase_label, icon_url = get_moon_phase_icon(forecast_date)
        except Exception as e:
            print(f"⚠️ Failed to get moon phase icon for {forecast_date}: {e}")
            phase_label, icon_url = "New", ""

        monthly_data.append({
            "month": real_transits[m].get("month", f"Month {m+1}"),
            "domains": domains,
            "count": domain_score,
            "transit_score": transit_score,
            "transit_label": tightest_aspects[m][0],
            "aspect_orb": tightest_aspects[m][1],
            "moon_transit": moon_transit_label,
            "moon_theme": transit_meanings.get(moon_transit_label.lower(), {}).get("theme", "emotional current"),
            "moon_insight": transit_meanings.get(moon_transit_label.lower(), {}).get("guidance", "Tune in and feel what's changing."),
            "transit_positions": positions,
            "phase_label": phase_label.split()[0],
            "icon_url": icon_url,
            "date": forecast_date
        })

        print(f"✅ Appended data for Month {m+1}")

    print(f"📦 Month {m+1} Domains: {domains} (Count: {domain_score})")

    return monthly_data, aspects_list, dict(overall_domain_counter)

def get_ai_forecast_block(month, year, transit_label, orb, phase_label, theme, guidance, client,
                          birth_traits, birth_chart, transit_positions, standardized_scores,
                          used_prompts, aspects=None):
    traits = {
        "sun": {
            "birth": birth_traits.get("Sun"),
            "dominant": standardized_scores.get("sun", {}).get("dominant"),
            "undertone": standardized_scores.get("sun", {}).get("undertone")
        },
        "life_path": {
            "birth": birth_traits.get("LifePath"),
            "dominant": standardized_scores.get("life_path", {}).get("dominant"),
            "undertone": standardized_scores.get("life_path", {}).get("undertone")
        },
        "chinese_zodiac": {
            "birth": birth_traits.get("ChineseZodiac"),
            "dominant": standardized_scores.get("chinese_zodiac", {}).get("dominant"),
            "undertone": standardized_scores.get("chinese_zodiac", {}).get("undertone")
        },
        "human_design": {
            "birth": birth_traits.get("HumanDesign"),
            "dominant": standardized_scores.get("human_design", {}).get("dominant"),
            "undertone": standardized_scores.get("human_design", {}).get("undertone")
        },
        "enneagram": {
            "dominant": standardized_scores.get("enneagram", {}).get("dominant"),
            "undertone": standardized_scores.get("enneagram", {}).get("undertone")
        }
    }

    # Natal Sun aspect
    transit_planet = None
    if transit_label:
        parts = transit_label.split()
        if len(parts) >= 2:
            transit_planet = parts[-1]

    natal_sun_deg = birth_chart.get("Sun")
    personalized_note = "Natal chart information not available."
    if natal_sun_deg and transit_planet in transit_positions:
        personal_aspects = get_sun_transit_aspects(natal_sun_deg, transit_positions)
        for planet, aspect, angle in personal_aspects:
            if planet == transit_planet:
                personalized_note = f"This transit forms a {aspect} to the user's natal Sun ({angle:.1f}° difference)."
                break

    # Include up to 2 key aspect influences (excluding the main one)
    extra_influences = []
    if aspects:
        for planet, aspect, orb_val in sorted(aspects, key=lambda x: x[2]):
            key = f"{planet.lower()} {aspect.lower()}"
            if key != transit_label.lower() and key in transit_meanings:
                info = transit_meanings[key]
                extra_influences.append(f"{planet} {aspect} — {info['theme']}")
            if len(extra_influences) >= 2:
                break

    influences_text = ""
    if extra_influences:
        influences_text = "Other emotional influences this month include: " + "; ".join(extra_influences) + "."

    # Trait snapshot
    user_profile = f"""
TRAITS

Birth Design:
- Sun Sign: {traits["sun"]["birth"]}
- Life Path: {traits["life_path"]["birth"]}
- Chinese Zodiac: {traits["chinese_zodiac"]["birth"]}
- Human Design Type: {traits["human_design"]["birth"]}

Dominant:
- Sun: {traits["sun"]["dominant"]}
- Life Path: {traits["life_path"]["dominant"]}
- Chinese Zodiac: {traits["chinese_zodiac"]["dominant"]}
- Human Design: {traits["human_design"]["dominant"]}
- Enneagram: Type {traits["enneagram"]["dominant"]}

Undertone:
- Sun: {traits["sun"]["undertone"]}
- Life Path: {traits["life_path"]["undertone"]}
- Chinese Zodiac: {traits["chinese_zodiac"]["undertone"]}
- Human Design: {traits["human_design"]["undertone"]}
- Enneagram: Type {traits["enneagram"]["undertone"]}
"""

    prompt = f"""
You are an emotionally grounded astrologer writing a personal forecast for {month} {year}.

Include:
- Moon Phase: {phase_label}
- Transit: {transit_label} ({orb}° orb)
- Natal Sun Link: {personalized_note}
- {influences_text}
- Trait Context:
{user_profile}

Write 5 concise labeled blocks:
<what it means>
<why it matters>
<growth actions>
<journal prompt>
<affirmation>

Tone: intelligent, supportive, and personal. Avoid fluff. Keep it grounded and dense.
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85
        )
        raw = response.choices[0].message.content.strip()
        labels = ["<what it means>", "<why it matters>", "<growth actions>", "<journal prompt>", "<affirmation>"]
        parsed = {label.strip("<>"): "" for label in labels}
        current = None
        for line in raw.splitlines():
            if line.lower().strip() in labels:
                current = line.strip("<>").lower()
                continue
            if current:
                parsed[current] += line.strip() + " "

        if used_prompts is not None and parsed["journal prompt"].strip() in used_prompts:
            parsed["journal prompt"] += " (Variation)"
        if used_prompts is not None:
            used_prompts.add(parsed["journal prompt"].strip())

        actions_html = format_growth_actions(parsed["growth actions"])
        html = f"""
        <div class="month-subsection ai-generated">
            <p><strong>What it means:</strong> {parsed['what it means'].strip()}</p>
            <p><strong>Why it matters:</strong> {parsed['why it matters'].strip()}</p>
            <p><strong>Try This:</strong></p>
            {actions_html}
            <p><strong>📓 Journal Prompt:</strong> {parsed['journal prompt'].strip()}</p>
            <p><strong>✨ Affirmation:</strong> <em>“{parsed['affirmation'].strip().strip('"')}”</em></p>
        </div>
        """
        return html
    except Exception as e:
        return f"<p><em>AI forecast unavailable for {month}: {e}</em></p>"
# --------------------------------------------
# BAR CHART: Emotional intensity by month
def generate_emotional_weather_chart(sync_data, aspects_list, traits_dict, output_path="emotional_weather_chart.png"):
    import matplotlib.pyplot as plt
    from matplotlib.patches import Patch
    from matplotlib.ticker import MaxNLocator
    import numpy as np

    # Extract data
    months = [entry["month"] for entry in sync_data]
    raw_phases = [entry["phase_label"] for entry in sync_data]

    # Define emotional intensity per aspect type
    aspect_to_score = {
        "conjunct": 6,
        "opposition": 5,
        "square": 4,
        "trine": 3,
        "sextile": 2,
        "aspecting": 1
    }

    # Compute intensity per month based on dominant aspect
    intensities = []
    multiplier = get_emotional_sensitivity_multiplier(traits_dict)  # ✅ Move outside the loop

    for aspect in aspects_list:
        try:
            key = aspect.split()[-1].lower()
            score = aspect_to_score.get(key, 1)
        except:
            score = 1
        intensities.append(min(score * multiplier, 6))  # ✅ Optional: clip to max 6

    # Define moon phase colors
    colors = {
        "New": "#1e1b4b",             # Deep Indigo
        "Waxing": "#cbd5e1",          # Silver Blue
        "Full": "#14b8a6",            # Vivid Turquoise
        "Waning": "#334155",          # Charcoal
        "First Quarter": "#f59e0b",   # Amber
        "Last Quarter": "#9333ea"     # Violet
    }

    # Normalize phases and assign colors
    def normalize_phase(p):
        p = p.lower()
        if "new" in p:
            return "New"
        elif "waxing" in p:
            return "Waxing"
        elif "full" in p:
            return "Full"
        elif "waning" in p:
            return "Waning"
        elif "first" in p:
            return "First Quarter"
        elif "last" in p or "third" in p:
            return "Last Quarter"
        else:
            return "Unknown"

    phases = [normalize_phase(p) for p in raw_phases]
    print("🎯 Final normalized phases in chart:", set(phases))
    print("🔍 Normalized Moon Phases:", phases)
    
    bar_colors = [colors.get(phase, "#AAAAAA") for phase in phases]

    # Identify the most intense month
    max_intensity = max(intensities)
    max_index = intensities.index(max_intensity)

    # Build chart
    fig, ax = plt.subplots(figsize=(14, 6))
    ax.set_facecolor("#ffffff")
    fig.patch.set_facecolor("#f8fafc")

    bars = ax.bar(months, intensities, color=bar_colors, edgecolor="black")

    # Highlight most intense month
    bars[max_index].set_edgecolor("red")
    bars[max_index].set_linewidth(2)
    ax.text(
        bars[max_index].get_x() + bars[max_index].get_width() / 2,
        intensities[max_index] + 0.3,
        "✦ Most Intense",
        ha='center',
        va='bottom',
        fontsize=10,
        color='red'
    )

    # Add moon phase labels above bars
    for bar, phase in zip(bars, phases):
        ax.text(bar.get_x() + bar.get_width() / 2, bar.get_height() + 0.1, f"{phase} Moon",
                ha='center', va='bottom', fontsize=8)

    # Titles and labels
    ax.set_title("Emotional Intensity by Month", fontsize=14)
    ax.set_ylabel("Intensity (1–6)", fontsize=12)
    ax.set_ylim(0, 6.5)
    ax.yaxis.set_major_locator(MaxNLocator(integer=True))
    ax.set_xticks(np.arange(len(months)))
    ax.set_xticklabels(months, rotation=45, ha='right')

    # Build clean legend
    legend_elements = [
        Patch(facecolor=color, label=f"{label} Moon")
        for label, color in colors.items()
    ]

    ax.legend(
        handles=legend_elements,
        title="Moon Phase",
        loc='center left',          # ✅ Move to the left
        bbox_to_anchor=(1.01, 0.5), # ✅ Push outside the chart area
    borderaxespad=0.
    )

    plt.tight_layout()
    plt.savefig(output_path)
    plt.close()

    return output_path

def get_emotional_sensitivity_multiplier(traits_dict):
    """
    Calculates the average emotional sensitivity multiplier from all systems/layers.
    """
    multipliers = []
    for system, weights in emotional_sensitivity.items():
        layers = traits_dict.get(system, {})
        for trait in [layers.get("birth"), layers.get("dominant"), layers.get("undertone")]:
            if trait in weights:
                multipliers.append(weights[trait])

    return sum(multipliers) / len(multipliers) if multipliers else 1.0

def get_emotional_rhythm_ai_block(birth_traits, standardized_scores, trait_libs) -> str:
    """
    Generates a personalized emotional rhythm description based on Moon-Sun traits,
    dominant and undertone influences, and Human Design Type.
    """
    all_traits = get_all_traits(standardized_scores)
    birth_labels = get_birth_traits(standardized_scores)

    prompt = f"""
    The following traits represent someone's unique emotional makeup and moon reactivity.

    Birth Traits: {birth_labels}
    Full Trait Overlay: {all_traits}

    Please write a 3-paragraph emotionally intelligent explanation of this person’s “emotional rhythm.”
    Address:
    1. Their natural emotional style and response to change or stress.
    2. How moon phases might affect their mood, energy, and clarity.
    3. Tips for balancing emotional highs/lows or navigating lunar intensity.

    Do not list traits. Speak in "you" language. Avoid astrology jargon or signs unless relevant.
    Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
    Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
    This honors the user's unique identity and avoids misidentification.
    """

    response = call_openai_chat(prompt)  # This assumes you have a helper function for OpenAI
    return response.strip()


def render_emotional_rhythm_html(chart_base64: str, ai_block: str) -> str:
    formatted_paragraphs = [
        f"<p>{para.strip()}</p>" for para in ai_block.split("\n\n") if para.strip()
    ]
    joined_paragraphs = "\n".join(formatted_paragraphs)

    return f"""
    <div class="ai-generated">
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="{chart_base64}" alt="Emotional Intensity Chart" style="width:100%; max-width:700px; display: block; margin: 0 auto;" />
        </div>

        <p>
            The Moon plays a key role in shaping your internal weather — from subtle emotional nudges to powerful waves of insight.
            This chart shows the intensity of your emotional climate over the coming months, based on planetary alignments and Moon phases.
        </p>

        <p>
            Rather than forecasting events, this rhythm helps you understand your natural cycles of feeling, intuition, and inner focus.
            The taller the bar, the stronger the emotional activation based on your traits and transits.
        </p>

        {joined_paragraphs}

        <ul style="margin-top: 20px;">
            <li><strong>New Moon:</strong> Clarity, intention-setting, a need to go inward</li>
            <li><strong>Waxing Moon:</strong> Drive builds, emotion gains momentum</li>
            <li><strong>Full Moon:</strong> Feelings peak — your energy may surge or overflow</li>
            <li><strong>Waning Moon:</strong> A time to release, slow down, and reflect</li>
        </ul>
    </div>
    """

    # ----------------- SHADOW WORK SECTION -----------------
def generate_shadowwork_section(birth_traits, standardized_scores, shadow_work_library, client, traits_dict):
    import re, html

    trait_map = {
        "sun": ("SunSigns", "Sun Sign"),
        "life_path": ("LifePaths", "Life Path"),
        "chinese_zodiac": ("ChineseZodiac", "Chinese Zodiac"),
        "enneagram": ("Enneagram", "Enneagram"),
        "human_design": ("HumanDesign", "Human Design")
    }

    # Trait layers
    trait_breakdown = f"""
Birth Design (core personality):
- Sun: {traits_dict['sun']['birth']}
- Life Path: {traits_dict['life_path']['birth']}
- Chinese Zodiac: {traits_dict['chinese_zodiac']['birth']}
- Human Design: {traits_dict['human_design']['birth']}

Dominant Traits (active behavioral patterns):
- Sun: {traits_dict['sun']['dominant']}
- Life Path: {traits_dict['life_path']['dominant']}
- Chinese Zodiac: {traits_dict['chinese_zodiac']['dominant']}
- Human Design: {traits_dict['human_design']['dominant']}
- Enneagram: Type {traits_dict['enneagram']['dominant']}

Undertones (emotional reactivity & unconscious patterns):
- Sun: {traits_dict['sun']['undertone']}
- Life Path: {traits_dict['life_path']['undertone']}
- Chinese Zodiac: {traits_dict['chinese_zodiac']['undertone']}
- Human Design: {traits_dict['human_design']['undertone']}
- Enneagram: Type {traits_dict['enneagram']['undertone']}
"""

    # Collect trait shadow summaries
    shadow_descriptions = []
    for trait_type, (lib_key, label) in trait_map.items():
        def get_shadow(val):
            try:
                if lib_key in ["LifePaths", "Enneagram"]:
                    val = int(str(val).replace("Type ", ""))
                return shadow_work_library.get(lib_key, {}).get(val, {}).get("shadow", "")
            except:
                return ""
        birth = birth_traits.get(trait_type, {}).get("birth") if isinstance(birth_traits.get(trait_type), dict) else birth_traits.get(trait_type)
        dom = traits_dict[trait_type]["dominant"]
        undertone = traits_dict[trait_type]["undertone"]
        for layer, val in [("Birth", birth), ("Dominant", dom), ("Undertone", undertone)]:
            if val:
                summary = get_shadow(val)
                if summary:
                    shadow_descriptions.append(f"{layer} {label} ({val}): {summary}")

    full_shadow_text = "\n".join(shadow_descriptions)

    # Upgraded AI prompt
    prompt = f"""
You are a psychological astrologer writing a 'Shadow Work' section of a personalized self-integration report.

This person has 14 traits across 5 systems — Sun, Life Path, Human Design, Chinese Zodiac, and Enneagram — evaluated at three layers: birth, dominant, and undertone.

Trait Snapshot:
{trait_breakdown}

Below are their shadow themes across all 14 traits:
{full_shadow_text}

Write the following sections using markdown headers. Use bullet points (•) — not dashes or numbers — for lists.

Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
This honors the user's unique identity and avoids misidentification.

### What You're Learning About Yourself
Write a deep, emotionally intelligent paragraph exploring the inner contradictions and blind spots this person may face. Focus on:
- How their desire to give, perform, or belong can conflict with their need to feel seen, safe, and sovereign.
- The emotional cost of people-pleasing, invisibility, control, or perfectionism.
- Where validation-seeking masks true self-worth — and what they’re really craving.

### Shadow Journal Prompts
List 3 cleanly worded, emotionally provocative journal prompts. Each one should help them **reflect on behaviors or beliefs that block healing**.

### Integration Practices
List 3 grounded actions, rituals, or mindset shifts they can begin to reclaim energy and shift the deeper patterns.

Tone: clear, grounded, therapist-level insight — not spiritual or vague. Speak truthfully but kindly. Focus on internal *awareness → integration → self-trust*.
"""

    # Call GPT
    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.83
        )
        raw = response.choices[0].message.content.strip()
    except Exception as e:
        print("⚠️ Shadow GPT call failed:", e)
        raw = "### What You're Learning About Yourself\n[Unavailable]\n### Shadow Journal Prompts\n• [Unavailable]\n### Integration Practices\n• [Unavailable]"

    # Parser for markdown headers
    def extract_md(header):
        pattern = rf"### {re.escape(header)}\s+(.*?)(?=\n### |\Z)"
        match = re.search(pattern, raw, re.DOTALL)
        return html.escape(match.group(1).strip()).replace("\n", "<br>") if match else "[Section missing]"

    insight_text = extract_md("What You're Learning About Yourself")
    prompts_text = extract_md("Shadow Journal Prompts")
    practices_text = extract_md("Integration Practices")

    # Final HTML Output
    section_html = f"""
    <p>Shadow work is the practice of witnessing the parts of you that operate beneath the surface — your patterns, fears, emotional reflexes, and inherited beliefs. It’s not about fixing — it’s about reclaiming every part of your design so it can support your growth instead of sabotaging it.</p>

    <p>This reflection pulls from all 14 of your birth, dominant, and undertone traits, offering clarity on what's happening beneath the surface — and what it’s time to evolve.</p>

    <h4>What You're Learning About Yourself</h4>
    <p>{insight_text}</p>

    <h4>Shadow Journal Prompts</h4>
    <p>{prompts_text}</p>


    <h4>Integration Practices</h4>
    <p>{practices_text}</p>

    """

    return section_html


# ------------------ PDF EXPORT ------------------

def save_report_as_pdf(html_report, filename="astrology_report.pdf"):
    """
    Save an HTML report as a PDF file using WeasyPrint.

    Args:
        html_report (str): The HTML content of the report to be converted.
        filename (str, optional): The output PDF file name. Defaults to "astrology_report.pdf".

    Returns:
        None
    """
    HTML(string=html_report).write_pdf(filename)

# ------------------ USER INTAKE FUNCTIONS ------------------

def get_user_info():
    print("✨ Let's gather your birth details to generate your Astrological Fingerprint:\n", flush=True)
    
    name = input("🖊️  Full name: ").strip().title()

    while True:
        email = input("📧  Email address (to receive your report): ").strip()
        if re.match(r"[^@]+@[^@]+\.[^@]+", email):
            break
        else:
            print("⚠️  Please enter a valid email address.", flush=True)
        
    print(f"Hi, {name} — report loading...", flush=True)

    while True:
        birth_date = input("📅 Birth date (MM/DD/YYYY): ").strip()
        try:
            datetime.strptime(birth_date, "%m/%d/%Y")
            break
        except ValueError:
            print("⚠️  Please enter a valid date in MM/DD/YYYY format (e.g., 04/23/1992).", flush=True)

    while True:
        birth_time = input("⏰ Birth time (HH:MM, 24-hour): ").strip()
        try:
            datetime.strptime(birth_time, "%H:%M")
            break
        except ValueError:
            print("⚠️  Please enter a valid time in 24-hour format (e.g., 14:30 for 2:30 PM).", flush=True)

    while True:
        birth_place = input("📍 Birth place (City, State if U.S. or City, Country if outside U.S.): ").strip()
        if birth_place:
            break
        else:
            print("⚠️  Please enter your birth place.", flush=True)


    return name, email, birth_date, birth_time, birth_place

# ------------------ VALIDATE LOCATION ------------------
def validate_location(birth_place, api_key):
    url = f"https://api.opencagedata.com/geocode/v1/json"
    params = {"q": birth_place, "key": api_key, "limit": 1}
    response = requests.get(url, params=params)
    data = response.json()

    if data["results"]:
        return data["results"][0]  # contains 'geometry', 'components', etc.
    else:
        return None
# ------------------ CELEBRATION SECTION ------------------ 
def generate_celebration_section(traits_dict, shadow_work_library, All_Images, client):
    trait_map = {
        "sun": ("SunSigns", "Sun Sign"),
        "life_path": ("LifePaths", "Life Path"),
        "chinese_zodiac": ("ChineseZodiac", "Chinese Zodiac"),
        "enneagram": ("Enneagram", "Enneagram"),
        "human_design": ("HumanDesign", "Human Design")
    }

    # Collect trait strengths
    strengths_text = []

    for system_key, (lib_key, label) in trait_map.items():
        birth = traits_dict.get(system_key, {}).get("birth")
        undertone = traits_dict.get(system_key, {}).get("undertone")

        def get_strength(val):
            try:
                if lib_key in ["LifePaths", "Enneagram"]:
                    val = int(str(val).replace("Type ", "").replace("Life Path ", ""))
                return shadow_work_library.get(lib_key, {}).get(val, {}).get("strength", "")
            except:
                return ""

        if birth:
            summary = get_strength(birth)
            if summary:
                strengths_text.append(f"Birth {label} ({birth}): {summary}")
        if undertone and undertone != birth:
            summary = get_strength(undertone)
            if summary:
                strengths_text.append(f"Undertone {label} ({undertone}): {summary}")

    full_strengths = "\n".join(strengths_text)

    # Prompt to GPT
    prompt = f"""
# Prompt to GPT

You are a celebration coach writing the final section of a personalized astrology report.
This person has been evaluated through 5 systems — Sun Sign, Life Path, Human Design, Chinese Zodiac, and Enneagram — with birth and undertone layers for each.

Here are their trait-based strengths:
{full_strengths}

Write the following sections using markdown headers. Use bullet points (•) — not dashes or numbers — for all lists.

Constraint: Do not use language that presents the user as a specific sign, type, or archetype (e.g., "you are a Rabbit," "you are a Projector"). 
Instead, describe the qualities or archetypal expressions that are present in their energetic makeup (e.g., "the diplomatic qualities of the Rabbit are present in your Chinese Zodiac undertones," "the Projector energy within you leads you to guide others"). 
This honors the user's unique identity and avoids misidentification.

### What You're Remembering About Yourself
Write a single, warm, and concrete paragraph that synthesizes the person’s unique strengths.
Do **not** individually list traits from the different systems (e.g., "Your Sun Sign is..."). Instead, analyze how the dominant and undertone strengths from all 14 traits interact and combine in positive ways. Focus on the *synergy*—what new, powerful quality or ability is created by this specific blend that wouldn't exist otherwise?
Explain how this unique intersection of strengths would naturally show up in real life: in their way of thinking, feeling, acting, and relating to others. Be specific, insightful, and personal. Avoid vague compliments, generic inspiration, or overused spiritual phrases.

### Celebration Prompts
Return exactly three reflective prompts that help them feel proud of their growth and alignment. Use bullet points (•).

### Integration Practices
Return exactly three uplifting actions, mantras, or rituals to help them live more fully in their light. Use bullet points (•).

Tone: clear, emotionally intelligent, grounded, and inspiring. Avoid clichés or overused spiritual phrases.
""".strip()

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.85
        )
        raw = response.choices[0].message.content.strip()
    except Exception as e:
        print("⚠️ Celebration GPT call failed:", e)
        raw = "### What You're Remembering About Yourself\n[Unavailable]\n### Celebration Prompts\n- [Unavailable]\n### Integration Practices\n- [Unavailable]"

    # Extract blocks
    def extract_md(header):
        pattern = rf"### {re.escape(header)}\s+(.*?)(?=\n### |\Z)"
        match = re.search(pattern, raw, re.DOTALL)
        return html.escape(match.group(1).strip()).replace("\n", "<br>") if match else "[Section missing]"

    insight = extract_md("What You're Remembering About Yourself")
    prompts = extract_md("Celebration Prompts")
    practices = extract_md("Integration Practices")

    if "[Section missing]" in insight + prompts + practices:
        print("⚠️ GPT celebration section formatting issue:\n", raw)

   # Celebration block, now styled like other narrative sections
    return f"""
    <div class="ai-generated">

        <p style="margin: 0 0 12px 0;">
            This section honors the strengths encoded in your energetic fingerprint — qualities you radiate when you're aligned with your truth. 
            These are not traits to earn — they are already yours.
        </p>

        <h3 style="margin-top: 20px; margin-bottom: 6px;">What You're Remembering About Yourself</h3>
        <p style="margin: 0 0 10px 0;">{insight}</p>

        <h3 style="margin-top: 18px; margin-bottom: 6px;">Celebration Prompts</h3>
        <p style="margin: 0 0 10px 0;">{prompts}</p>

        <h3 style="margin-top: 18px; margin-bottom: 6px;">Living in Your Light</h3>
        <p style="margin: 0 0 10px 0;">{practices}</p>

    </div>
"""

# ------------------ QUIZ LOADING FUNCTION ------------------

def load_quiz(path: str = 'quiz_35_questions.json') -> list | None:
    """
    Load quiz data from a JSON file.

    Args:
        path (str): Path to the quiz JSON file.

    Returns:
        list or None: Parsed quiz data if successful, otherwise None.
    """
    try:
        with open(path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"❌ File not found: '{path}'. Please check the file path.")
    except json.JSONDecodeError:
        print(f"❌ Error decoding JSON from '{path}'. Ensure the file is valid JSON.")
    except Exception as e:
        print(f"❌ Unexpected error loading quiz: {e}")
    return None

# ------------------ QUIZ RESPONSE INTAKE ------------------

def get_user_answers(quiz: list[dict]) -> list[str]:
    """
    Prompt the user to answer each quiz question by selecting one of the available options.

    Args:
        quiz (list of dict): The quiz data, each dict containing 'question' and 'answers'.

    Returns:
        list of str: The user's selected answers corresponding to each question.
    """
    answers = []
    print("\nAnswer each question by typing the letter (A, B, C, or D):")

    for i, q in enumerate(quiz, 1):
        print(f"\nQ{i}: {q['question']}")
        for opt, descs in q['answers'].items():
            print(f" {opt.upper()}) {descs[0]}")

        while True:
            choice = input("Your answer: ").strip().upper()
            if choice in q['answers']:
                answers.append(choice)
                break
            else:
                print("❌ Invalid choice. Please enter A, B, C, or D.")

    return answers


# ----- Location + Timezone Lookup via OpenCage -----
def get_location_from_opencage(place_name, api_key):
    url = "https://api.opencagedata.com/geocode/v1/json"
    params = {
        'q': place_name,
        'key': api_key,
        'limit': 1,
        'no_annotations': 0
    }
    response = requests.get(url, params=params)
    response.raise_for_status()
    data = response.json()
    
    if not data['results']:
        raise ValueError(f"No results found for '{place_name}'")

    result = data['results'][0]
    lat = result['geometry']['lat']
    lon = result['geometry']['lng']
    timezone_name = result['annotations']['timezone']['name']
    
    return lat, lon, timezone_name

# ------------------ BIRTH TRAIT EXTRACTION ------------------

def calculate_human_design(birth_date_str: str, birth_time_str: str, birth_place: str) -> str:
    """
    Calculate Human Design type based on birth date, time, and place.

    This is a placeholder. Replace with your actual Human Design calculation logic or API integration.

    Args:
        birth_date_str (str): Birth date in MM/DD/YYYY format.
        birth_time_str (str): Birth time in HH:MM (24-hour) format.
        birth_place (str): Birth place (city, country).

    Returns:
        str: Human Design type (e.g., 'Generator', 'Projector', etc.)
    """
    # TODO: Implement actual Human Design calculation or import here
    return "Generator"  # Example fallback value

def calculate_sun_sign(month: int, day: int) -> str:
    """
    Determine the Sun sign based on birth month and day.

    Args:
        month (int): Birth month (1-12).
        day (int): Birth day (1-31).

    Returns:
        str: Sun sign name.
    """
    if (month == 12 and day >= 22) or (month == 1 and day <= 19):
        return "Capricorn"
    elif (month == 1 and day >= 20) or (month == 2 and day <= 18):
        return "Aquarius"
    elif (month == 2 and day >= 19) or (month == 3 and day <= 20):
        return "Pisces"
    elif (month == 3 and day >= 21) or (month == 4 and day <= 19):
        return "Aries"
    elif (month == 4 and day >= 20) or (month == 5 and day <= 20):
        return "Taurus"
    elif (month == 5 and day >= 21) or (month == 6 and day <= 20):
        return "Gemini"
    elif (month == 6 and day >= 21) or (month == 7 and day <= 22):
        return "Cancer"
    elif (month == 7 and day >= 23) or (month == 8 and day <= 22):
        return "Leo"
    elif (month == 8 and day >= 23) or (month == 9 and day <= 22):
        return "Virgo"
    elif (month == 9 and day >= 23) or (month == 10 and day <= 22):
        return "Libra"
    elif (month == 10 and day >= 23) or (month == 11 and day <= 21):
        return "Scorpio"
    else:
        return "Sagittarius"

def calculate_life_path(date_str: str) -> int:
    """
    Calculate the Life Path number from a birth date string (MM/DD/YYYY).

    Args:
        date_str (str): Birth date string.

    Returns:
        int: Single-digit Life Path number.
    """
    digits = [int(c) for c in date_str if c.isdigit()]
    while len(digits) > 1:
        digits = list(map(int, str(sum(digits))))
    return digits[0]

# ------------------ CHINESE NEW YEAR AWARE FUNCTION ------------------

chinese_new_years = {
    1988: "1988-02-17", 1989: "1989-02-06", 1990: "1990-01-27",
    1991: "1991-02-15", 1992: "1992-02-04", 1993: "1993-01-23",
    1994: "1994-02-10", 1995: "1995-01-31", 1996: "1996-02-19",
    1997: "1997-02-07", 1998: "1998-01-28", 1999: "1999-02-16",
    2000: "2000-02-05", 2001: "2001-01-24", 2002: "2002-02-12",
    2003: "2003-02-01", 2004: "2004-01-22", 2005: "2005-02-09",
    2006: "2006-01-29", 2007: "2007-02-18", 2008: "2008-02-07",
    2009: "2009-01-26", 2010: "2010-02-14", 2011: "2011-02-03",
    2012: "2012-01-23", 2013: "2013-02-10", 2014: "2014-01-31",
    2015: "2015-02-19", 2016: "2016-02-08", 2017: "2017-01-28",
    2018: "2018-02-16", 2019: "2019-02-05", 2020: "2020-01-25",
    2021: "2021-02-12", 2022: "2022-02-01", 2023: "2023-01-22",
    2024: "2024-02-10", 2025: "2025-01-29"
}

def get_chinese_zodiac_fixed(birth_date: datetime) -> str:
    animals = [
        "Rat", "Ox", "Tiger", "Rabbit", "Dragon", "Snake",
        "Horse", "Goat", "Monkey", "Rooster", "Dog", "Pig"
    ]
    year = birth_date.year
    cny_str = chinese_new_years.get(year, f"{year}-02-04")
    cny_date = datetime.strptime(cny_str, "%Y-%m-%d")
    zodiac_year = year - 1 if birth_date < cny_date else year
    return animals[(zodiac_year - 1900) % 12]
def identify_hd_type_from_gates(gates: List[str]) -> str:
    """
    Placeholder function to identify Human Design type from a list of gates.

    Args:
        gates (List[str]): List of activated gate numbers as strings.

    Returns:
        str: One of the five HD types: 'Generator', 'Manifesting Generator', 
             'Projector', 'Manifestor', or 'Reflector'.
    """
    # Very rough placeholder logic — you should refine this with real gate-to-type mappings
    generator_gates = {"2", "5", "14", "29", "34"}  # Example: sacral/response gates
    projector_gates = {"1", "13", "43", "23"}       # Example: individual insight gates
    manifestor_gates = {"51", "21", "45"}           # Example: ego/throat connections
    reflector_gates = {"64", "47", "61", "24"}      # Crown/Ajna, etc.

    gate_set = set(gates)

    if gate_set & generator_gates:
        return "Generator"
    elif gate_set & projector_gates:
        return "Projector"
    elif gate_set & manifestor_gates:
        return "Manifestor"
    elif gate_set & reflector_gates:
        return "Reflector"
    else:
        return "Manifesting Generator"  # Fallback for now

def extract_all_birth_traits(
    birth_date_str: str,
    birth_time_str: str,
    birth_place: str,
    lat: float = None,
    lon: float = None,
    jd: float = None
) -> Dict[str, Union[str, int, list]]:
    """
    Extract key birth traits including Sun sign, Life Path number,
    Chinese Zodiac, and Human Design (via real planetary gates).

    Args:
        birth_date_str (str): Birth date in MM/DD/YYYY format.
        birth_time_str (str): Birth time in HH:MM AM/PM format.
        birth_place (str): Birth place string.
        lat (float): Latitude (optional).
        lon (float): Longitude (optional).
        jd (float): Julian Day (optional, required for Human Design gate logic).

    Returns:
        dict: Dictionary with keys like 'Sun', 'LifePath', 'ChineseZodiac', 'HumanDesign', 'HumanDesignGates'.
    """
    try:
        dt = datetime.strptime(birth_date_str, "%m/%d/%Y")
    except ValueError:
        print("⚠️ Invalid birth date format. Please use MM/DD/YYYY.")
        return {
            "Sun": "Unknown",
            "LifePath": "Unknown",
            "ChineseZodiac": "Unknown",
            "HumanDesign": "Unknown",
            "HumanDesignGates": []
        }

    sun_sign = calculate_sun_sign(dt.month, dt.day)
    life_path = calculate_life_path(birth_date_str)
    chinese_zodiac = get_chinese_zodiac_fixed(dt)

    human_design = "Unknown"
    gates = []

    if jd is not None:
        gates = get_human_design_gates(jd)
        human_design = identify_hd_type_from_gates(gates)

    return {
        "Sun": sun_sign,
        "LifePath": life_path,
        "ChineseZodiac": chinese_zodiac,
        "HumanDesign": human_design,
        "HumanDesignGates": [int(g.replace("Gate ", "")) for g in gates if g.startswith("Gate ")]
    }

# ------------------ TRAIT SCORING FUNCTION ------------------
def score_traits(quiz: List[Dict[str, Any]], user_answers: List[str], birth_traits: Dict[str, Any]) -> Dict[str, Dict[str, float]]:
    """
    Scores user-selected traits based on quiz answers and birth traits.
    Assumes answer format: [label, Sun, LifePath, ChineseZodiac, Enneagram, HumanDesign]
    """

    trait_scores = {
        "Sun": {},
        "LifePath": {},
        "ChineseZodiac": {},
        "Enneagram": {},
        "HumanDesign": {}
    }

    multipliers = {
        "Sun": 2.0,
        "LifePath": 1.8,
        "ChineseZodiac": 1.5,
        "Enneagram": 1.5,
        "HumanDesign": 1.5
    }

    categories = ["Sun", "LifePath", "ChineseZodiac", "Enneagram", "HumanDesign"]
    user_life_path = str(birth_traits.get("LifePath", ""))

    print("🧪 DEBUG: Inputs to score_traits:")
    print("→ quiz length:", len(quiz))
    print("→ user_answers:", user_answers)
    print("→ birth_traits:", birth_traits)

    for question, answer in zip(quiz, user_answers):
        traits = question.get('answers', {}).get(answer, [])
        if len(traits) < 6:
            print(f"⚠️ Skipping incomplete traits for answer '{answer}': {traits}")
            continue

        for i, category in enumerate(categories, start=1):  # skip label
            trait = traits[i]
            if not trait:
                continue

            weight = multipliers.get(category, 1.0)

            # Add bonus if LifePath match
            if category == "LifePath" and trait.strip() == f"Life Path {user_life_path}":
                weight += 0.5

            trait_scores[category][trait] = trait_scores[category].get(trait, 0) + weight

    print("\n✅ Final trait_scores from score_traits():")
    for system, traits in trait_scores.items():
        print(f"🎯 {system}: {traits}")

    return trait_scores

#-------- Get Human Design -------------
def convert_degree_to_gate(degree):
    # 360° circle divided into 64 I Ching gates → each gate = 5.625°
    gate_number = int(degree / 5.625) + 1
    return f"Gate {gate_number}"

def get_human_design_gates(julian_day):
    # Gate conversion per planet is approximate; Human Design uses the I Ching wheel
    planet_names = [
        swe.SUN, swe.MOON, swe.MERCURY, swe.VENUS, swe.MARS,
        swe.JUPITER, swe.SATURN, swe.URANUS, swe.NEPTUNE, swe.PLUTO
    ]
    gate_list = []

    for planet in planet_names:
        pos, _ = swe.calc_ut(julian_day, planet)
        degree = pos[0]  # Only care about longitude
        gate = convert_degree_to_gate(degree)
        gate_list.append(gate)

    return gate_list


#-------- Human Design Info -------------

def get_human_design_planets(birth_date, birth_time, birth_place):
    try:
        # Parse birth_date and time
        dt = datetime.strptime(f"{birth_date} {birth_time}", "%m/%d/%Y %H:%M")

        # Geocode location using OpenCage
        lat, lon, timezone_name = get_location_from_opencage(birth_place, OPENCAGE_API_KEY)

        # Get timezone
        tf = TimezoneFinder()
        tz_name = tf.timezone_at(lng=lon, lat=lat)
        if not tz_name:
            raise ValueError("Could not determine timezone.")
        local_tz = timezone(tz_name)
        local_dt = local_tz.localize(dt)
        utc_dt = local_dt.astimezone(timezone("UTC"))

        # Get Julian Day
        jd = swe.julday(utc_dt.year, utc_dt.month, utc_dt.day, utc_dt.hour + utc_dt.minute / 60)

        # Calculate planetary longitudes
        planet_map = {
            "Sun": swe.SUN,
            "Moon": swe.MOON,
            "Mercury": swe.MERCURY,
            "Venus": swe.VENUS,
            "Mars": swe.MARS,
            "Jupiter": swe.JUPITER,
            "Saturn": swe.SATURN,
            "Uranus": swe.URANUS,
            "Neptune": swe.NEPTUNE,
            "Pluto": swe.PLUTO,
        }

        positions = {}
        for name, code in planet_map.items():
            lon, _ = swe.calc_ut(jd, code)
            positions[name] = lon

        return positions

    except Exception as e:
        print(f"[ERROR] Human Design calc failed: {e}")
        return {}

# ------------------ HTML REPORT ASSEMBLY BLOCK ------------------
ZODIAC_SIGNS = [
    "Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo",
    "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"
]

def map_trait_to_domain(trait):
    """
    Map a trait to a domain (e.g., Love, Career, Expression).
    Handles Enneagram ('Type 9'), LifePath ('Life Path 6'), etc.
    """
    trait = str(trait).strip()

    # Detect system based on format
    is_enneagram = trait.startswith("Type ")
    is_life_path = trait.startswith("Life Path ")

    # Normalize numeric trait values
    if is_enneagram:
        trait_id = trait.replace("Type ", "").strip()
        trait_key = f"enneagram_{trait_id}"
    elif is_life_path:
        trait_id = trait.replace("Life Path ", "").strip()
        trait_key = f"lifepath_{trait_id}"
    else:
        trait_key = trait.title()  # For sun signs, HD types, CZ signs

    domain_map = {
        # ☀️ Sun Signs
        "Pisces": "Spirituality",
        "Aries": "Action",
        "Taurus": "Stability",
        "Gemini": "Communication",
        "Cancer": "Emotions",
        "Leo": "Expression",
        "Virgo": "Discipline",
        "Libra": "Relationships",
        "Scorpio": "Power",
        "Sagittarius": "Adventure",
        "Capricorn": "Career",
        "Aquarius": "Innovation",

        # 🔢 Life Path Numbers
        "lifepath_1": "Leadership",
        "lifepath_2": "Relationships",
        "lifepath_3": "Creativity",
        "lifepath_4": "Stability",
        "lifepath_5": "Freedom",
        "lifepath_6": "Responsibility",
        "lifepath_7": "Spirituality",
        "lifepath_8": "Power",
        "lifepath_9": "Humanitarianism",
        "lifepath_11": "Vision",

        # 🧬 Human Design
        "Generator": "Work",
        "Manifestor": "Initiation",
        "Manifesting Generator": "Adaptability",
        "Projector": "Guidance",
        "Reflector": "Wisdom",

        # 🐉 Chinese Zodiac
        "Rat": "Resourcefulness",
        "Ox": "Endurance",
        "Tiger": "Courage",
        "Rabbit": "Sensitivity",
        "Dragon": "Power",
        "Snake": "Wisdom",
        "Horse": "Adventure",
        "Goat": "Compassion",
        "Monkey": "Intellect",
        "Rooster": "Precision",
        "Dog": "Loyalty",
        "Pig": "Pleasure",

        # 🌀 Enneagram Types
        "enneagram_1": "Integrity",
        "enneagram_2": "Caregiving",
        "enneagram_3": "Achievement",
        "enneagram_4": "Individuality",
        "enneagram_5": "Knowledge",
        "enneagram_6": "Security",
        "enneagram_7": "Joy",
        "enneagram_8": "Power",
        "enneagram_9": "Harmony"
    }

    domain = domain_map.get(trait_key)
    if not domain:
        print(f"⚠️ Trait not mapped to domain: '{trait}' → key '{trait_key}'")
        return None

    print(f"🧪 Mapping trait: '{trait}' → {domain}")
    return domain


def generate_synchronicity_calendar(trait_scores, months=12):
    colors = {
        "sun": "\033[95m",
        "life_path": "\033[94m",
        "chinese_zodiac": "\033[92m",
        "enneagram": "\033[93m",
        "human_design": "\033[91m",
        "ENDC": "\033[0m"
    }

    top_traits = {}
    for category, traits in trait_scores.items():
        sorted_traits = sorted(traits.items(), key=lambda x: x[1], reverse=True)
        top_traits[category] = [t[0] for t in sorted_traits[:2]]

    score_lookup = {cat: dict(trait_scores[cat]) for cat in trait_scores}

    today = datetime.today()
    print("\n--- 12-Month Synchronicity Calendar ---")
    for m in range(months):
        month_dt = today + relativedelta(months=m)
        month_name = calendar.month_name[month_dt.month]
        year = month_dt.year

        synchs = []
        for category in top_traits.keys():
            traits_list = top_traits[category]
            trait = traits_list[m % len(traits_list)] if traits_list else None
            if trait:
                score = score_lookup[category].get(trait, 0)
                bar = "█" * int(score * 10)
                synchs.append(f"{colors.get(category, '')}{trait} ({category}) {bar}{colors['ENDC']}")

        print(f"\n{month_name} {year}:")
        for s in synchs:
            print(f"  - {s}")



# ------- Journal Prompts GENERAL -----------
def get_monthly_journal_prompts(birth_traits):
    prompts_html = []
    for system, value in birth_traits.items():
        lib_key = {
            "Sun": "SunSigns",
            "LifePath": "LifePaths",
            "ChineseZodiac": "ChineseZodiac",
            "Enneagram": "Enneagram",
            "HumanDesign": "HumanDesign"
        }.get(system)

        if not lib_key:
            continue

        key = int(value) if lib_key in ["LifePaths", "Enneagram"] else value
        trait_entry = shadow_work_library.get(lib_key, {}).get(key, {})
        prompts = trait_entry.get("journal_prompts", [])[:1]  # Keep or change number as desired

        if prompts:
            prompts_html.extend(f"<p class='tight-paragraph'>• {p}</p>" for p in prompts)

    return "\n".join(prompts_html)



#----- HD Rendering Gates ---------
def render_human_design_gates_section(gate_list, gate_descriptions):
    """
    Render the Human Design Gates section with 2-sentence interpretations per gate.
    """
    if not gate_list:
        return ""

    title_block = """
    <div class='section' id='gates'>
        <h2>Your Human Design Gates</h2>
        <p>
            Each of the gates below represents a specific energetic signature activated in your birth chart.
            These are the frequencies you're here to explore, express, and master.
        </p>
    """
    
    gate_lines = []
    for gate in gate_list:
        try:
            desc = human_design_gates[int(gate)]
            if desc.lower().startswith(f"gate {gate}".lower()):
                desc = desc[len(f"Gate {gate}") + 1:].strip()
        except (KeyError, ValueError):
            continue

        sentences = desc.strip().split(".")
        if len(sentences) >= 2:
            summary = f"<p><strong>Gate {gate}:</strong> {sentences[0].strip()}.</p><p>{sentences[1].strip()}.</p>"
        else:
            summary = f"<p><strong>Gate {gate}:</strong></p><p>{desc.strip()}</p>"

        gate_lines.append(summary)

    return title_block + "".join(gate_lines) + "</div>"

def render_gate_insights(natal_gates: List[int], transit_positions: Dict[str, float]) -> str:
    highlight_planets = ["Moon", "Venus", "Mars", "Neptune", "Pluto"]
    planet_gates = {}
    highlight_gates = []

    for planet, degree in transit_positions.items():
        gate = zodiac_degree_to_gate(degree)
        if gate:
            planet_gates[planet] = gate
            if planet in highlight_planets:
                highlight_gates.append(gate)

    gate_hits = set(highlight_gates) & set(natal_gates)
    html = ""

    if gate_hits:
        html += "<div class='hd-gates'><p><strong>🌟 Transit activation of your natal Human Design gates:</strong></p>"
        for g in gate_hits:
            desc = human_design_gates.get(g, "")
            if desc:
                html += f"<p><strong>Gate {g}:</strong> {desc.split('.')[0].strip()}.</p>"
        html += "</div>"
    elif highlight_gates:
        html += "<div class='hd-gates'><p><strong>🌀 Emotional gates active via transit:</strong></p>"
        for g in set(highlight_gates):
            desc = human_design_gates.get(g, "")
            if desc:
                html += f"<p><strong>Gate {g}:</strong> {desc.split('.')[0].strip()}.</p>"
        html += "</div>"

    return html
# ----- Generate Final Script -----
def generate_final_synthesis(domain, traits, narrative, insights=3, tone="grounded"):
    """
    Generate insight lines for any life domain.
    tone = "grounded" | "poetic" | "balanced"
    """
    if tone == "poetic":
        style_instruction = """
    Use metaphor or lyrical phrasing to deepen clarity and emotional resonance.
    Avoid clichés. Use subtle, elegant language.
    """
    elif tone == "balanced":
        style_instruction = """
    Use language that balances clarity and feeling.
    Mix reflective phrases with occasional poetic turns — but make sure every line is emotionally understandable and grounded in real growth.
    Avoid overly abstract metaphors or obscure images.
    """
    else:
        style_instruction = """
    Use calm, wise, human language. Avoid metaphors or overly poetic style.
    Keep it clear, emotionally resonant, and grounded in real-life integration.
    """

    prompt = f"""
    You are a narrative astrologer and integration-focused life coach.

    The user has the following profile:
    - Sun Sign: {traits.get('sun')}
    - Life Path: {traits.get('life_path')}
    - Enneagram: {traits.get('enneagram')} (dominant), {traits.get('enneagram_undertone')} (undertone)
    - Chinese Zodiac: {traits.get('chinese_zodiac')} (dominant), {traits.get('chinese_zodiac_undertone')} (undertone)
    - Human Design: {traits.get('hd_core')} (core), {traits.get('hd_undertone')} (undertone)

    Below is the full narrative for the domain of {domain}:

    {narrative.strip()}

    Write {insights} final reflections based on the narrative above.

    Each line should:
    - Sound like a soul-level conclusion drawn from what was just explored
    - Speak to emotional evolution and personal integration
    - Feel like a mirror that reflects: “Here’s what you’ve come to understand about yourself”

    {style_instruction}

    Do not number or label the lines. Separate them by newlines.
    """

    response = client.chat.completions.create(
        model="gpt-4-1106-preview",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.88
    )

    return response.choices[0].message.content.strip()


def extract_trait_dict(birth_traits, standardized_scores):
    return {
        "sun": {
            "birth": birth_traits.get("Sun"),
            "dominant": standardized_scores.get("sun", {}).get("dominant"),
            "undertone": standardized_scores.get("sun", {}).get("undertone")
        },
        "life_path": {
            "birth": int(birth_traits.get("LifePath")) if str(birth_traits.get("LifePath")).isdigit() else birth_traits.get("LifePath"),
            "dominant": standardized_scores.get("life_path", {}).get("dominant"),
            "undertone": standardized_scores.get("life_path", {}).get("undertone")
        },
        "chinese_zodiac": {
            "birth": birth_traits.get("ChineseZodiac"),
            "dominant": standardized_scores.get("chinese_zodiac", {}).get("dominant"),
            "undertone": standardized_scores.get("chinese_zodiac", {}).get("undertone")
        },
        "human_design": {
            "birth": birth_traits.get("HumanDesign"),
            "dominant": standardized_scores.get("human_design", {}).get("dominant"),
            "undertone": standardized_scores.get("human_design", {}).get("undertone")
        },
        "enneagram": {
            "dominant": standardized_scores.get("enneagram", {}).get("dominant"),
            "undertone": standardized_scores.get("enneagram", {}).get("undertone")
        }
    }

#-----------Emotional Rhythm Section -----------
def generate_emotional_rhythm_section(traits_dict, trait_libs, client, moon_sign):
    all_traits = get_all_traits(traits_dict)

    prompt = f"""
You are writing an emotionally intelligent, self-awareness-focused narrative called "Your Emotional Rhythm." 
This section is designed to educate and reflect, using the reader’s trait pattern and Moon sign to describe how they process emotion and respond to lunar cycles.

They have the following traits: {all_traits}, and their Moon sign is {moon_sign}. Use this information to guide your insights.

The final section should be structured into three thematic blocks — not as numbered lists — but as a flowing teaching narrative. Organize the output as follows:

• Emotional Expression and Regulation:  
Begin by describing how someone with these traits is likely to experience and regulate emotion. What is their natural emotional baseline? Do they tend to feel first and think later, or vice versa? Are they sensitive, measured, reactive, intuitive? Help them understand how their traits shape their emotional lens.

• Lunar Phases and Inner Cycles:  
Now educate them on how the Moon’s rhythm interacts with their natural emotional wiring. Describe what typically happens for them during the New Moon, Waxing period, Full Moon, and Waning phase — based on their energetic profile. Do certain phases bring clarity, confusion, intensity, grounding?

• Practices for Balance and Flow:  
Finally, offer grounded suggestions to help them navigate emotional highs and lows. These might include self-reflection, journaling, nature, solitude, connection, or creative practices. Make the advice practical, psychologically attuned, and inspired by their unique rhythm.

Tone: Warm, grounded, and self-aware. Avoid astrological jargon. Do not list traits or use bullet points. Speak directly to the reader using “you.” Your goal is to help them understand their emotional ecosystem — how their traits and the moon together shape their inner weather.
"""


    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.85
    )
    return response.choices[0].message.content.strip()

#------ DIVIDERS FUNCTION -----------
def insert_divider(style="moon", page_break=False):
    img_urls = {
        "moon": "https://imgur.com/5F7dg6E.png",
        "star": "https://imgur.com/dohbVra.png",
        "sunmoon": "https://imgur.com/oyuWlVS.png",
        "sun": "https://imgur.com/b4uprtc.png",
        "earth": "https://imgur.com/DugzvOo.png",
        "fire": "https://imgur.com/CYYlI7C.png",
        "water": "https://imgur.com/by8UAyg.png",
        "wind": "https://imgur.com/hujdKqG.png"
    }

    alt_texts = {
        "moon": "Moon divider",
        "star": "Star divider",
        "sunmoon": "Sun + Moon divider",
        "sun": "Sun divider",
        "earth": "Earth element",
        "fire": "Fire element",
        "water": "Water element",
        "wind": "Wind element"
    }

    url = img_urls.get(style, img_urls["moon"])
    alt = alt_texts.get(style, "divider")
    
    return f"""
        <div class="divider-wrapper" style="page-break-before: always; break-before: always;">
            <div style="text-align:center; margin: 40px 0;">
                <img src="{url}" alt="{alt}" style="height: 50px;">
            </div>
        </div>
    """
    # 🌙 Moon Divider — introspective/emotional, includes page break
    {insert_divider("moon")}

    # ✨ Star Divider — general separator, includes page break
    {insert_divider("star")}

    # 🌞🌙 Sun + Moon Divider — symbolic transformation, includes page break
    {insert_divider("sunmoon")}

    # 🔥 Fire Element Divider — bold energy, NO page break
    {insert_divider("fire")}

    # 🌬️ Wind Element Divider — light/flowy, NO page break
    {insert_divider("wind")}

# ----- Wrap Narratives ------

def wrap_narrative_section(title, subtitle, html_body, divider_key, All_Images):
    """
    Wraps a narrative block with consistent styling, including section headers,
    body content, TOC link, and a closing divider image.
    """
    import re
    divider = All_Images.get(divider_key, "")
    section_id = re.sub(r"[^\w\s-]", "", title.lower()).replace(" ", "-")

    return f"""
    <div id="{section_id}" class="section">
        <div style="break-inside: avoid;">
            <h3>{title}</h3>
            <h2>{subtitle}</h2>
            {html_body}
            <p style="text-align: right; margin-top: 10px;">
                <a href="#toc">↑ Back to Table of Contents</a>
            </p>
        </div>
        <div class="divider-wrapper" style="text-align: center;">
            <img src="data:image/png;base64,{divider}" alt="" style="width: 100%; margin: 40px 0;" />
        </div>
    </div>
    """

# ----- GENERATE FULL HTML REPORT FUNCTION ------
def generate_full_html_report(
    name,
    trait_scores,              # ✅ 2nd argument
    standardized_scores,       # ✅ 3rd argument
    birth_traits,
    shadow_work_library,
    All_Images,
    traits_dict,
    trait_libs,
    human_design_gates,
    real_transits,
    sun_transits,
    real_moon_phases,
    moon_sign,
    moon_sun_aspect,
    start_month_offset,
    birth_chart,
    sun_sign,
    sun_deg,
    moon_deg):

    """
    Assemble the complete HTML report including cover page, narratives, synchronicity chart,
    shadow work, and summary using all available data and images.

    Args:
        name (str): User's name.
        trait_scores (dict): Trait scores from quiz.
        birth_traits (dict): Sun, LifePath, ChineseZodiac, Enneagram, HumanDesign.

    Returns:
        str: Full HTML report as a string.
    """
    sun_sign = birth_traits.get("Sun", "")
    sun_sign_img_url = SUN_SIGN_IMAGES.get(sun_sign, "")

    def extract_top_traits(trait_scores, top_n=2):
        top_dominants = {}
        for system, traits in trait_scores.items():
            sorted_traits = sorted(traits.items(), key=lambda x: x[1], reverse=True)
            top_dominants[system] = [trait for trait, _ in sorted_traits[:top_n]]
        return top_dominants

    top_traits = extract_top_traits(trait_scores)
    dom_traits = [t[0] for t in top_traits.values() if t]
    undertones = [t[1] for t in top_traits.values() if len(t) > 1]

    def clean_trait_name(t):
        return t.replace("Type Type ", "Type ") if t.startswith("Type Type ") else t

    dom_traits = [clean_trait_name(t) for t in dom_traits]
    undertones = [clean_trait_name(t) for t in undertones]

    if birth_traits.get("HumanDesignGates"):
        gate_list = traits_dict.get("HumanDesignGates", [])
        gate_list_str = ", ".join(str(g) for g in sorted(gate_list))
        gate_block = f"""
        <div class="section">
            <h3>Human Design Gates Activated at Birth</h3>
            <p>Your design is shaped by the following gates, activated at the moment of your birth:</p>
            <p style="font-size: 16px;"><strong>{gate_list_str}</strong></p>
            <p style="font-size: 14px; color: #666;">
                (Each gate corresponds to a theme or archetype that contributes to your energetic blueprint.)
            </p>
        </div>
        """
    else:
        gate_block = ""

    gate_section_html = ""
    if birth_traits.get("HumanDesignGates"):
        gate_section_html = render_human_design_gates_section(traits_dict["HumanDesignGates"],human_design_gates)

    def explain_trait(trait):
        if trait in chinese_zodiac_profiles:
            return f"({trait}: {chinese_zodiac_profiles[trait]['relationships']})"
        elif trait in human_design_profiles:
            return f"({trait}: {human_design_profiles[trait]['relationships']})"
        elif trait in sun_sign_profiles:
            return f"({trait}: {sun_sign_profiles[trait]['relationships']})"
        elif trait in life_path_profiles:
            return f"(Life Path {trait}: {life_path_profiles[trait]['relationships']})"
        elif trait.startswith("Type ") and trait[5:] in enneagram_profiles:
            return f"({trait}: {enneagram_profiles[trait[5:]]['relationships']})"
        elif trait in enneagram_profiles:
            return f"(Type {trait}: {enneagram_profiles[trait]['relationships']})"
        return ""

    dom_explained = [f"{t} {explain_trait(t)}" for t in dom_traits]
    undertone_explained = [f"{t} {explain_trait(t)}" for t in undertones]

    dominant_block = f"<strong>Dominant Traits:</strong> {', '.join(dom_explained)}"
    undertone_block = f"<strong>Influencing Undertones:</strong> {', '.join(undertone_explained)}"

    # Generate and encode chart
    sun_deg = birth_traits.get("SunDegree", 0)  # make sure this is already stored earlier

    aspects_per_month = [
        get_sun_transit_aspects(sun_deg, month["positions"])
        for month in real_transits
    ]

    # Simplify: just pick 1 main aspect per month (e.g., the most intense one)
    # Define priority
    aspect_priority = {
        "conjunct": 6, "opposition": 5, "square": 4,
        "trine": 3, "sextile": 2, "aspecting": 1
    }

    aspects_list = []
    tightest_aspects = []
    transit_labels = []
    aspect_data_per_month = []  # ✅ FIXED: initialize here

    for aspects in aspects_per_month:
        if aspects:
            # Tightest = smallest orb
            tightest = sorted(aspects, key=lambda x: x[2])[0]  # (planet, aspect, orb)
            tightest_aspects.append((f"{tightest[0]} {tightest[1]}", tightest[2]))

            # Dominant = highest priority aspect
            dominant = sorted(aspects, key=lambda x: -aspect_priority.get(x[1], 0))[0]
            aspects_list.append(f"{dominant[0]} {dominant[1]}")

            # Clean transit label
            planet = tightest[0].capitalize()
            aspect = tightest[1].lower()
            label = f"{planet} {aspect}"
            transit_labels.append(label)

            # ✅ Append structured data
            aspect_data_per_month.append({
                "tightest": (planet, aspect, tightest[2]),
                "dominant": f"{dominant[0]} {dominant[1]}",
                "label": label
            })
        else:
            tightest_aspects.append(("Unknown", 999))
            aspects_list.append("aspecting")
            transit_labels.append("Moon aspecting")
            aspect_data_per_month.append({
                "tightest": ("Unknown", "aspecting", 999),
                "dominant": "aspecting",
                "label": "Moon aspecting"
            })

    moon_phases_list = real_moon_phases  # Should already be generated earlier

    print(f"DEBUG: months: 12")
    print(f"DEBUG: aspects_list: {len(aspects_list)} → {aspects_list}")
    print(f"DEBUG: moon_phases_list: {len(moon_phases_list)} → {moon_phases_list}")

    # ✅ Build list of planetary positions per month (for GPT personalization)
    transit_positions_per_month = [month["positions"] for month in real_transits]

    # ✅ Step 1: Get the forecast data in correct structure
    sync_data, aspects_list, domain_summary = generate_combined_synchronicities(trait_scores, sun_sign, real_transits, traits_dict, start_month_offset)

    print(f"✅ sync_data length: {len(sync_data)}")


    # Inject tightest aspect info into each month’s entry
    for i in range(len(sync_data)):
        sync_data[i]["tightest_aspect"] = tightest_aspects[i][0]
        sync_data[i]["aspect_orb"] = round(tightest_aspects[i][1], 1)

    # ✅ Debug: show sample monthly forecast entry
    print("\n🔍 DEBUG: Sample sync_data[0] entry:")
    pprint.pprint(sync_data[0])

    # ✅ Check the actual planet positions for the first month
    print("\n🪐 DEBUG: real_transits[0]['positions'] =")
    pprint.pprint(real_transits[0]['positions'])

    # ✅ Step 2: Generate the chart using that data
    chart_path = generate_emotional_weather_chart(sync_data, aspects_list, traits_dict)

    # ✅ Step 3: Encode the image for HTML embedding
    with open(chart_path, "rb") as img_file:
        encoded_chart = base64.b64encode(img_file.read()).decode("utf-8")

    print("Saved chart at:", chart_path)
    print("Chart exists?", os.path.exists(chart_path))

        # ✅ Prepare data for emotional forecast
    birth_chart = {
        "Sun": {
            "degree": birth_traits.get("SunDegree", 0),
            "sign": birth_traits.get("Sun", "Unknown")
        },
        "Moon": {
            "degree": birth_traits.get("MoonDegree", 0),
            "sign": birth_traits.get("Moon", "Unknown")
        },
        "Mercury": {
            "degree": birth_traits.get("MercuryDegree", 0),
            "sign": birth_traits.get("Mercury", "Unknown")
        },
        "Venus": {
            "degree": birth_traits.get("VenusDegree", 0),
            "sign": birth_traits.get("Venus", "Unknown")
        },
        "Mars": {
            "degree": birth_traits.get("MarsDegree", 0),
            "sign": birth_traits.get("Mars", "Unknown")
        },
        "Jupiter": {
            "degree": birth_traits.get("JupiterDegree", 0),
            "sign": birth_traits.get("Jupiter", "Unknown")
        },
        "Saturn": {
            "degree": birth_traits.get("SaturnDegree", 0),
            "sign": birth_traits.get("Saturn", "Unknown")
        }
    }


    html_output = ""

    relationship_html = generate_relationship_narrative(
        traits_dict, 
        trait_libs, 
        shadow_work_library, 
        human_design_gates, 
        client
    )

    html_output += wrap_narrative_section(
        title="RELATIONSHIPS",
        subtitle="Your Astrological Fingerprint in Love",
        html_body=relationship_html,
        divider_key="pb_moon",
        All_Images=All_Images
    )

    money_html= generate_money_narrative(
        traits_dict, 
        trait_libs, 
        shadow_work_library, 
        human_design_gates, 
        client
    )

    html_output += wrap_narrative_section(
        title="MONEY",
        subtitle="Your Relationship to Value & Flow",
        html_body=money_html,
        divider_key="pb_sun",
        All_Images=All_Images  # ✅ added
    )

    career_html = generate_career_narrative(
        traits_dict,
        trait_libs,
        shadow_work_library,
        human_design_gates,
        client
    )

    html_output += wrap_narrative_section(
        title= "CAREER",
        subtitle="Career & Vocation",
        html_body=career_html,
        divider_key="pb_star",
        All_Images=All_Images
    )

    family_html = generate_family_narrative(traits_dict, 
        trait_libs, 
        shadow_work_library, 
        human_design_gates, 
        client)

    html_output += wrap_narrative_section(
        title= "FAMILY",
        subtitle= "Emotional Roots and Relational Patterns",
        html_body=family_html,
        divider_key="pb_moon",
        All_Images=All_Images
    )

    core_gift_html = generate_core_gift_and_calling(
        traits_dict, 
        moon_sign, 
        moon_sun_aspect, 
        sun_transits, 
        client
    )

    # Insert an explicit anchor so TOC links always work, even in PDFs
    core_gift_html_with_anchor = f"<span id='core-gift-calling'></span>{core_gift_html}"

    html_output += wrap_narrative_section(
        title="CORE GIFT & CALLING",
        subtitle="The Essence You’re Here to Express",
        html_body=core_gift_html_with_anchor,
        divider_key="pb_sun",
        All_Images=All_Images
    )

    shadow_html = generate_shadowwork_section(
        birth_traits, 
        standardized_scores, 
        shadow_work_library, 
        client, 
        traits_dict
    )

    html_output += wrap_narrative_section(
        title= "SHADOW WORK",
        subtitle="The Growth Edge Beneath Your Traits",
        html_body= shadow_html,
        divider_key="pb_star",
        All_Images=All_Images,
    )

    celebration_html = generate_celebration_section(
        traits_dict, 
        shadow_work_library, 
        All_Images, 
        client
    )

    html_output += wrap_narrative_section(
        title="CELEBRATION",
        subtitle="Owning Your Gifts & Growth",
        html_body=celebration_html,
        divider_key="pb_moon",
        All_Images=All_Images
    )

    # ✅ Emotional Rhythm — keep this version only
    emotional_rhythm_text = generate_emotional_rhythm_section(
        traits_dict=traits_dict,
        trait_libs=trait_libs,
        client=client,
        moon_sign=moon_sign
    )
    chart_base64 = f"data:image/png;base64,{encoded_chart}"
    emotional_rhythm_html = render_emotional_rhythm_html(
        chart_base64,
        emotional_rhythm_text
    )
    html_output += wrap_narrative_section(
        title="YOUR EMOTIONAL RHYTHM",
        subtitle="How You Process Feeling and Intuition",
        html_body=emotional_rhythm_html,
        divider_key="pb_sun",
        All_Images=All_Images
    )
    summary_html = generate_summary_synthesis(
        birth_traits,
        standardized_scores,
        client,
        sun_deg,
        moon_deg
    )

    html_output += wrap_narrative_section(
        title="SUMMARY",  # or "🧬 Your Patterns, Your Power, Your Path"
        subtitle="Your Patterns, Your Power, Your Path",
        html_body=summary_html,
        divider_key="pb_star",
        All_Images=All_Images
    )


    print("🔍 Final HTML output length:", len(html_output))
    print("✅ 'RELATIONSHIPS' in output?", "RELATIONSHIPS" in html_output)
    print("✅ Chart base64 present?", "data:image/png;base64" in html_output)

    html_content = f""" 
<!DOCTYPE html>
<html>
<head>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Cormorant+Garamond:wght@400;700&family=Playfair+Display:wght@500;700&display=swap');
    /* ----------- Base Styles ----------- */
    body {{
        font-family: 'Cormorant Garamond', serif;
        font-size: 18px;  /* ✅ Set consistent base size */
        line-height: 1.6;
        color: #000000;
        margin: 0.5in;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background: white;  /* ✅ Optional: helps with rendering in some PDF tools */
    }}
    h1 {{
        font-family: 'Great Vibes', cursive;
        font-size: 36px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
        color: #5E3A87;
    }}
    h2 {{
        font-family: 'Great Vibes', cursive;
        font-size: 36px;
        margin-top: 10px;
        font-weight: 700; /* ✅ Bold for headings */
        color: #5E3A87;
        page-break-after: avoid;
    }}
    h3 {{
        font-family: 'Cormorant Garamond', serif;
        font-size: 24px;
        margin-top: 10px;
        font-weight: 700; /* ✅ Bold for subheadings */
        color: #5E3A87;
    }}
    h4 {{
        margin-top: 10px;
        margin-bottom: 10px;
        color: #5E3A87;
        font-size: 20px;
    }}
    p {{
        font-size: 18px;
        margin-top: 18px;
    }}
    ul {{
        list-style-type: disc;
        margin: 10px 0 20px 30px;
        padding: 0;
        text-align: left;
    }}
    li {{
        font-size: 17px;
        margin-bottom: 6px;
    }}
    a {{
        color: #444;
        text-decoration: none;
    }}
    a:hover {{
        text-decoration: underline;
        color: #333;
    }}

    /* ----------- Layout & Blocks ----------- */
    .section {{
        margin-bottom: 10px;
        page-break-inside: avoid;
    }}
    .narrative-block {{
        text-align: left;
        padding: 0;
        width: 100%;
        box-sizing: border-box;
    }}
    .cover {{
        text-align: center;
        padding: 40px 0;
        max-width: 700px;
        margin: 0 auto;
        page-break-inside: avoid;
    }}
    .cover img {{
        max-width: 220px;
        margin: 20px auto 40px;
        display: block;
    }}
    .page-break {{
        page-break-after: always;
    }}
    .divider-wrapper {{
    break-inside: avoid;
    page-break-inside: avoid;
    text-align: center;
    }}

    /* ----------- Article Style ----------- */
    .ai-generated p,
    .ai-generated li,
    .narrative-block p {{
        margin-bottom: 10px;
        page-break-inside: avoid;
    }}
    .trait-explainer {{
        font-size: 16px;
        margin-bottom: 15px;
        line-height: 1.6;
    }}
    .tight-paragraph {{
        margin-top: 4px;
        margin-bottom: 4px;
        line-height: 1.4;
        font-size: 17px;
    }}

    /* ----------- Monthly Forecast Card (if used) ----------- */
    .forecast-month {{
        background: #f9f9fc;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 20px;
        font-size: 16px;
        page-break-inside: avoid;
    }}
    .forecast-month h3 {{
        margin-top: 0;
        font-size: 20px;
        color: #4b0082;
    }}
    .forecast-month p {{
        margin: 6px 0;
        line-height: 1.5;
    }}
    .best-day-badge {{
        background: #f9f4ff;
        border-left: 4px solid #8855cc;
        padding: 6px 10px;
        margin-top: 12px;
        font-weight: bold;
        font-size: 16px;
        color: #222;
    }}

    /* ----------- Summary Box ----------- */
    .forecast-summary {{
        margin-top: 30px;
        padding: 12px;
        background: #f4f4fa;
        border-left: 4px solid #8888cc;
        font-size: 14px;
    }}

    /* ----------- Footer / Page Marker ----------- */
    .page-watermark {{
        page-break-before: avoid !important;
        break-inside: avoid !important;
        margin-top: 12px;
        font-size: 12px;
        color: #888;
        text-align: center;
    }}
    @bottom-center {{
        content: "Page " counter(page);
        font-size: 12px;
        color: #888;
    }}
    </style>

</head>
<body>
    <div id="cover" class="cover page-break">
        <h1>Your Astrological Fingerprint</h1>
        {f'<img src="{sun_sign_img_url}" alt="{sun_sign} image" style="max-width: 180px; display: block; margin: 20px auto;" />' if sun_sign_img_url else ""}
        
        <p style="
            font-family: 'Playfair Display', serif;
            font-size: 30px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin: 12px 0;
            color: #111;
        ">
            {name}
        </p>

        <p>
            {birth_traits.get("Sun", "Unknown")} | Life Path {birth_traits.get("LifePath", "Unknown")} | {birth_traits.get("ChineseZodiac", "Unknown")}
        </p>

        <div style="display: flex; justify-content: center; gap: 40px; margin-top: 15px; flex-wrap: wrap; text-align: center;">
            <div style="min-width: 220px;">
                <h3 style="margin-bottom: 8px;">Dominant Traits</h3>
                <ul style="list-style-position: inside; padding: 0; margin: 0 auto; display: inline-block; text-align: left;">
                    {''.join(f"<li>{t}</li>" for t in dom_traits)}
                </ul>
            </div>
            <div style="min-width: 220px;">
                <h3 style="margin-bottom: 8px;">Influencing Undertones</h3>
                <ul style="list-style-position: inside; padding: 0; margin: 0 auto; display: inline-block; text-align: left;">
                    {''.join(f"<li>{t}</li>" for t in undertones)}
                </ul>
            </div>
        </div>

            <blockquote>
                "The cosmos does not move randomly — it moves with intention. And so do you."
            </blockquote>
        </div>
    {insert_divider("sunmoon")}
    <div class="trait-explainer">
        <p><strong>Understanding Your Trait Dynamics</strong></p>
        <p>
            Your <em>Dominant Traits</em> are the core energies you lead with — the head of your expression.
            Your <em>Undertone Traits</em> are the subtle drivers beneath — the neck that turns the head.
            They shape the tone, timing, and direction of your dominant energy.
        </p>
        <p>
            As an example, someone with a bold Aries dominant might move fast — but if paired with a Cancer undertone, they might express emotional sensitivity, softening their impact or creating moments of hesitation. 
            The beauty of your fingerprint lies in this blend — it’s yours alone.
        </p>
        {insert_divider("star")}
    </div>

    <div id="toc" class="toc section page-break" style="text-align: center;">
        <h2 style="font-size: 38px; margin-bottom: 30px;">Table of Contents</h2>
        <ul style="list-style: none; padding: 0; font-size: 20px; line-height: 1.8; display: inline-block; text-align: left;">
            <li><a href="#relationships">Relationships & Love</a></li>
            <li><a href="#career">Career & Vocation</a></li>
            <li><a href="#money">Money & Abundance</a></li>
            <li><a href="#family">Family & Roots</a></li>
            <li><a href="#core-gift-calling">Core Gift &amp; Calling</a></li>
            <li><a href="#shadow-work">Shadow Work & Growth Practices</a></li>
            <li><a href="#celebration">Celebration & Strengths</a></li>
            <li><a href="#your-emotional-rhythm">The Moon & Your Emotional Rhythm</a></li>
            <li><a href="#summary">Summary & Integration</a></li>
            <li><a href="#sources">Sources & Methodology</a></li>
            <li><a href="#appendix">Appendix – Explaining Your Chart Logic</a></li>
            <li><a href="#appendix-report-logic">Appendix – How This Report Was Built</a></li>
            <li><a href="#glossary">Glossary</a></li>
            <li><a href="#faq">FAQ</a></li>
        </ul>
    </div>

    {{WRAPPED_SECTIONS}}

    <div class="page-break"></div>
    <div id="sources" class="section" style="margin-top: 60px;">
        <h2>Expand Your Journey</h2>
        <p class="trait-explainer">This report is just the beginning. Below are books and authors that inspired the interpretations within these pages.</p>
        <h3><span role="img" aria-label="Crystal Ball">🔮</span> Astrology</h3>
        <ul>
        <li>The Inner Sky — Steven Forrest</li>
        <li>You Were Born for This — Chani Nicholas</li>
        </ul>

        <h3><span role="img" aria-label="Abacus">🧮</span> Numerology</h3>
        <ul>
        <li>The Life You Were Born to Live — Dan Millman</li>
        </ul>

        <h3><span role="img" aria-label="Dragon">🐉</span> Chinese Zodiac</h3>
        <ul>
        <li>The Handbook of Chinese Horoscopes — Theodora Lau</li>
        </ul>

        <h3><span role="img" aria-label="Wrench">🔧</span> Enneagram</h3>
        <ul>
        <li>The Wisdom of the Enneagram — Riso & Hudson</li>
        </ul>

        <h3><span role="img" aria-label="DNA">🧬</span> Human Design</h3>
        <ul>
        <li>The Definitive Book of Human Design — Lynda Bunnell</li>
        </ul>
        <p style="text-align: right; margin-top: 40px;">
            <a href="#toc">↑ Back to Table of Contents</a>
        </p>
    </div>
    <div class="page-break"></div>
    <div id="terms" class="section" style="margin-top: 60px; color: #666; font-size: 14px; line-height: 1.6;">
        <h3 style="color: #444;">Terms & Conditions</h3>
        <p>This report is intended solely for personal growth and reflection. It is not a substitute for medical, legal, or financial advice. Interpretations are symbolic, and individual results may vary.</p>
        <p>All report content — including text, structure, narrative style, and design — is the intellectual property of <strong>Jedadora</strong>. This material may not be copied, reproduced, distributed, or sold without explicit written permission.</p>
        <p style="font-style: italic; font-size: 13px; margin-top: 20px;">
            © {str(datetime.now().year)} Liliana Dinwoodey. All rights reserved.
        </p>
        <p style="text-align: right; margin-top: 40px;">
            <a href="#toc">↑ Back to Table of Contents</a>
        </p>
    </div>
        <div id="appendix" class="section page-break" style="margin-top: 60px;">
            <h2>Appendix – Explaining Your Chart Logic</h2>

            <p><strong><span role="img" aria-label="Milky Way">🌌</span> What is this forecast based on?</strong><br>
            Your Emotional Rhythm chart blends two key principles: <em>Moon Phases</em> and <em>Sun–Moon Aspects</em>. Together, they show when you are likely to feel more emotionally activated or internally steady throughout the year.</p>

            <h3><span role="img" aria-label="Moon">🌙</span> Moon Phases</h3>
            <p>The Moon moves through predictable phases each month, shaping emotional tone and focus:</p>
            <ul>
                <li><strong>New Moon:</strong> Clarity, intention-setting, a need to go inward</li>
                <li><strong>Waxing Moon:</strong> Drive builds, emotion gains momentum</li>
                <li><strong>Full Moon:</strong> Feelings peak — your energy may surge or overflow</li>
                <li><strong>Waning Moon:</strong> A time to release, slow down, and reflect</li>
                <li><strong>First Quarter:</strong> Motivation, pressure, internal push</li>
                <li><strong>Last Quarter:</strong> Reflection, closure, and adjustment</li>
            </ul>

            <h3>🔄 Aspects to Your Natal Sun</h3>
            <p>An <em>aspect</em> is the angle between two celestial points — here, between the current Moon and the Sun’s position at your birth. Different angles carry different emotional intensities. Stronger aspects bring sharper influence.</p>
            <table style="width: 100%; max-width: 600px; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background: #f3f3f3;">
                        <th style="text-align: left; padding: 6px;">Aspect</th>
                        <th style="text-align: left; padding: 6px;">Degrees</th>
                        <th style="text-align: left; padding: 6px;">Emotional Tone</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 6px;">Conjunction</td><td style="padding: 6px;">0°</td><td style="padding: 6px;">Strong clarity or intensity</td></tr>
                    <tr><td style="padding: 6px;">Opposition</td><td style="padding: 6px;">180°</td><td style="padding: 6px;">Contrast, heightened awareness</td></tr>
                    <tr><td style="padding: 6px;">Square</td><td style="padding: 6px;">90°</td><td style="padding: 6px;">Challenge, growth pressure</td></tr>
                    <tr><td style="padding: 6px;">Trine</td><td style="padding: 6px;">120°</td><td style="padding: 6px;">Ease, emotional flow</td></tr>
                    <tr><td style="padding: 6px;">Sextile</td><td style="padding: 6px;">60°</td><td style="padding: 6px;">Opportunities, subtle encouragement</td></tr>
                </tbody>
            </table>

            <h3><span role="img" aria-label="Bar Chart">📊</span> How to read your chart</h3>
            <p>Each bar represents the emotional activation for a given month, calculated by combining the strength of the dominant Moon–Sun aspect with the Moon phase at that time. The height of the bar reflects the total intensity score, adjusted for your personal emotional sensitivity based on your birth and trait overlays.</p>
            <p>The tallest bar marks the month with the strongest overall activation — not necessarily “good” or “bad,” but a time when feelings, clarity, and self-awareness may be especially heightened.</p>

            <h3><span role="img" aria-label="Target">🎯</span> Why this is different</h3>
            <p>Most forecasts generalize for everyone. This chart is calculated for <em>your</em> birth Sun position, your unique sensitivity profile, and your dominant monthly aspect — making it a personalized map of emotional rhythms rather than a one-size-fits-all horoscope.</p>

            <p style="text-align: right; margin-top: 40px;">
                <a href="#toc" style="font-size: 16px; color: #444; text-decoration: none;">↑ Back to Table of Contents</a>
            </p>
        </div>
        <div id="appendix-report-logic" class="section page-break" style="margin-top: 60px;">
        <h2>Appendix – How This Report Was Built</h2>
        <p><strong><span role="img" aria-label="Brain">🧠</span> What is this report based on?</strong><br>
        This report blends astrology, numerology, the Enneagram, Chinese Zodiac, and Human Design to reflect your energetic fingerprint. It uses your birth data and your responses to a personality quiz to create a layered profile of 14 traits: 4 birth-based traits and 10 dynamic ones (5 dominant, 5 undertone).</p>
        <h3><span role="img" aria-label="Numbered list">🔢</span> Your 14 Trait Profile</h3>
        <p>We analyze these 5 systems:</p>
        <ul>
            <li><strong>Sun Sign</strong> (birth)</li>
            <li><strong>Life Path Number</strong> (birth)</li>
            <li><strong>Chinese Zodiac</strong> (birth)</li>
            <li><strong>Human Design Type</strong> (birth)</li>
            <li><strong>Enneagram</strong> (inferred)</li>
        </ul>
        <p>Each system contributes 3 layers:
            <strong>birth trait</strong>, <strong>dominant trait</strong> (how you lead), and <strong>undertone trait</strong> (emotional/reactive energy). Together, these create the emotional, behavioral, and energetic landscape explored in each section of the report.</p>
        <h3><span role="img" aria-label="DNA strand">🧬</span> Trait Scoring Logic</h3>
        <p>Your answers to 35 reflection questions are scored to identify which traits are most active for you right now. The system doesn't just tally answers — it compares your birth pattern with your lived responses to highlight what energies are leading and which are subtly influencing your decisions and emotions.</p>
        <h3><span role="img" aria-label="Writing hand">✍️</span> Narrative Generation</h3>
        <p>Each narrative section (Relationships, Career, Money, Family) is crafted using a blend of structured text and AI-generated interpretation. We use your 14-trait blend to describe how your strengths and shadow patterns interact. This creates a personalized narrative that feels emotionally intelligent and grounded — no generic horoscopes here.</p>
        <h3><span role="img" aria-label="New moon">🌑</span> Shadow + Celebration Work</h3>
        <p>Two full sections are dedicated to growth and integration. Your shadow section draws from your undertone traits and includes self-reflection prompts. The celebration section reflects your strengths, helping you recognize and own the energy you're already living into.</p>
        <h3><span role="img" aria-label="Bar chart">📊</span> Forecast Logic</h3>
        <p>The Emotional Intensity Forecast combines actual Moon phases and Sun-Moon aspects personalized to your natal Sun. The result is a yearlong emotional weather map — unique to you — highlighting periods of clarity, challenge, and ease.</p>
        <h3><span role="img" aria-label="Target">🎯</span> Bottom Line</h3>
        <p>This report was designed to reflect <em>you</em> — not just your Sun Sign. The blend of ancient wisdom and modern narrative tools helps you understand how your internal patterns and cosmic rhythms work together in daily life.</p>
        <p style="text-align: right; margin-top: 40px;">
            <a href="#toc" style="font-size: 16px; color: #444; text-decoration: none;">↑ Back to Table of Contents</a>
        </p>
    </div>
        <div id="glossary" class="section page-break" style="margin-top: 60px;">
        <h2>Glossary</h2>
        <ul style="font-size: 16px; line-height: 1.8;">
            <li><strong>Dominant Traits:</strong> Your most actively expressed energies — how you show up in the world.</li>
            <li><strong>Undertone Traits:</strong> Subtle, reactive, or emotionally triggered patterns influencing your core expression.</li>
            <li><strong>Birth Traits:</strong> Your foundational traits determined by birth data (Sun Sign, Life Path, etc.).</li>
            <li><strong>Human Design Gates:</strong> Specific energetic themes derived from your exact birth moment and planetary alignments.</li>
            <li><strong>Aspect:</strong> A geometric angle between planets (e.g. Sun and Moon), indicating emotional tone.</li>
            <li><strong>Conjunction:</strong> 0° angle — intensifies emotional clarity and focus.</li>
            <li><strong>Trine:</strong> 120° angle — brings ease, emotional harmony.</li>
            <li><strong>Shadow Work:</strong> The process of exploring and integrating unconscious patterns, often rooted in undertone traits.</li>
            <li><strong>Core Gift:</strong> The integrated expression of your full trait map — your natural brilliance when all parts align.</li>
        </ul>
        <p style="text-align: right; margin-top: 40px;">
            <a href="#toc" style="font-size: 16px; color: #444; text-decoration: none;">↑ Back to Table of Contents</a>
        </p>
    </div>
    <div id="faq" class="section page-break" style="margin-top: 60px;">
        <h2>Frequently Asked Questions</h2>
        <h4>Q: Is this a horoscope?</h4>
        <p>No. This report is not based on transiting planets for your Sun sign. It uses your birth chart and your quiz answers to map your personal energetic patterns.</p>
        <h4>Q: What if I don’t resonate with a trait?</h4>
        <p>Sometimes undertone traits show up in reactive or shadow form. If a trait doesn’t feel “like you,” it may reflect unconscious or situational patterns that emerge under stress.</p>
        <h4>Q: Why is Human Design included?</h4>
        <p>Human Design helps clarify how your energy flows through time — especially your decision-making, work style, and interactions. It adds nuance beyond astrology.</p>
        <h4>Q: Can this change over time?</h4>
        <p>Yes. Your birth traits remain constant, but your dominant and undertone traits can shift with growth, healing, or changing priorities. You can retake the quiz any time.</p>
        <h4>Q: How is the forecast calculated?</h4>
        <p>The forecast blends lunar phase data with Moon-Sun angles specific to your birth chart, highlighting high-emotion windows each month and a “Best Emotional Day.”</p>
        <p style="text-align: right; margin-top: 40px;">
            <a href="#toc" style="font-size: 16px; color: #444; text-decoration: none;">↑ Back to Table of Contents</a>
        </p>
    </div>
</body>
    </html>
    """
    html_report = html_content.replace("{WRAPPED_SECTIONS}", html_output)
    return html_report, sync_data, aspects_list, real_moon_phases

#--------------MAIN-----------------------------

def main():
    start_time = time()
    quiz = load_quiz()
    if not quiz:
        print("❌ Quiz loading failed.")
        return

    # Get user info
    name, email, birth_date, birth_time, birth_place = get_user_info()
    print(f"\n🧾 Generating report for: {name} ({email})")

    # Geocode before time conversion
    try:
        lat, lon, tz_name = get_location_from_opencage(birth_place, OPENCAGE_API_KEY)
        local_tz = timezone(tz_name)
    except Exception as e:
        print(f"❌ Geolocation failed: {e}")
        return

    # Convert to UTC and compute Julian Day
    birth_dt = datetime.strptime(f"{birth_date} {birth_time}", "%m/%d/%Y %H:%M")
    local_dt = local_tz.localize(birth_dt)
    utc_dt = local_dt.astimezone(timezone("UTC"))

    jd = swe.julday(
        utc_dt.year, utc_dt.month, utc_dt.day,
        utc_dt.hour + utc_dt.minute / 60 + utc_dt.second / 3600
    )

    sun_transits = calculate_sun_transits(jd)
    print("🌞 Sun Transits Passed to Report:", sun_transits)
    print(f"✅ Julian Day: {jd}")
    print(f"📍 Location: {birth_place} ({lat}, {lon})")
    print(f"🕓 UTC Time: {utc_dt}")

    # Trait extraction
    birth_traits = extract_all_birth_traits(birth_date, birth_time, birth_place, lat, lon, jd)
    positions = get_planet_degrees(jd)
    birth_chart = positions
    sun_deg = positions.get("Sun")
    moon_deg = positions.get("Moon")
    sun_sign = birth_traits.get("Sun")

    # Calculate moon sign now
    moon_sign_index = int(moon_deg // 30)
    moon_sign = ZODIAC_SIGNS[moon_sign_index]
    moon_sun_aspect = get_moon_aspect_to_sun(sun_deg, moon_deg) if sun_deg and moon_deg else "aspecting"

    # Quiz scoring
    user_answers = get_user_answers(quiz)
    try:
        trait_scores = score_traits(quiz, user_answers, birth_traits)
        pprint.pprint(trait_scores)

        standardized_scores = {
            "sun": {
                "dominant": max(trait_scores["Sun"], key=trait_scores["Sun"].get, default=None),
                "undertone": sorted(trait_scores["Sun"], key=trait_scores["Sun"].get, reverse=True)[1] if len(trait_scores["Sun"]) > 1 else None
            },
            "life_path": {
                "dominant": max(trait_scores["LifePath"], key=trait_scores["LifePath"].get, default=None),
                "undertone": sorted(trait_scores["LifePath"], key=trait_scores["LifePath"].get, reverse=True)[1] if len(trait_scores["LifePath"]) > 1 else None
            },
            "chinese_zodiac": {
                "dominant": max(trait_scores["ChineseZodiac"], key=trait_scores["ChineseZodiac"].get, default=None),
                "undertone": sorted(trait_scores["ChineseZodiac"], key=trait_scores["ChineseZodiac"].get, reverse=True)[1] if len(trait_scores["ChineseZodiac"]) > 1 else None
            },
            "human_design": {
                "dominant": max(trait_scores["HumanDesign"], key=trait_scores["HumanDesign"].get, default=None),
                "undertone": sorted(trait_scores["HumanDesign"], key=trait_scores["HumanDesign"].get, reverse=True)[1] if len(trait_scores["HumanDesign"]) > 1 else None
            },
            "enneagram": {
                "dominant": max(trait_scores["Enneagram"], key=trait_scores["Enneagram"].get, default=None),
                "undertone": sorted(trait_scores["Enneagram"], key=trait_scores["Enneagram"].get, reverse=True)[1] if len(trait_scores["Enneagram"]) > 1 else None
            }
        }

        traits_dict = {
            "sun": {"birth": birth_traits.get("Sun"), "dominant": standardized_scores["sun"]["dominant"], "undertone": standardized_scores["sun"]["undertone"]},
            "life_path": {"birth": birth_traits.get("LifePath"), "dominant": standardized_scores["life_path"]["dominant"], "undertone": standardized_scores["life_path"]["undertone"]},
            "chinese_zodiac": {"birth": birth_traits.get("ChineseZodiac"), "dominant": standardized_scores["chinese_zodiac"]["dominant"], "undertone": standardized_scores["chinese_zodiac"]["undertone"]},
            "human_design": {"birth": birth_traits.get("HumanDesign"), "dominant": standardized_scores["human_design"]["dominant"], "undertone": standardized_scores["human_design"]["undertone"]},
            "enneagram": {"dominant": standardized_scores["enneagram"]["dominant"], "undertone": standardized_scores["enneagram"]["undertone"]},
            "SunDegree": sun_deg,
            "MoonDegree": moon_deg,
            "MoonSign": moon_sign,
            "HumanDesignGates": birth_traits.get("HumanDesignGates", [])
        }

    except Exception as e:
        print("❌ Failed to score traits:", e)
        return

    # Forecast inputs
    start_month_offset = 1
    real_transits = get_real_transits(jd, months=12, offset=start_month_offset)
    real_moon_phases = get_real_moon_phases(jd, months=12, offset=start_month_offset)
    human_design_gates = birth_traits.get("HumanDesignGates", [])

    # Generate HTML report
    html_report, sync_data, aspects_list, real_moon_phases = generate_full_html_report(
        name,
        trait_scores,
        standardized_scores,
        birth_traits,
        shadow_work_library,
        All_Images,
        traits_dict,
        trait_libs,
        human_design_gates,
        real_transits,
        sun_transits,
        real_moon_phases,
        moon_sign,
        moon_sun_aspect,
        start_month_offset,
        birth_chart,
        sun_sign,
        sun_deg,
        moon_deg
    )

    # Debug sync
    for i, month in enumerate(sync_data):
        print(f"🔍 Month {i+1}: {month.get('month', 'Unknown')} | Domains: {month.get('domains')} | Date: {month.get('date')}")

    # Safety check: all lists must be complete
    if not (len(sync_data) == len(aspects_list) == len(real_moon_phases) == 12):
        print("❌ Data length mismatch:")
        print(f" - sync_data: {len(sync_data)}")
        print(f" - aspects_list: {len(aspects_list)}")
        print(f" - moon_phases: {len(real_moon_phases)}")
        return

    # Final HTML validation
    if not html_report.strip():
        print("❌ HTML report is empty.")
        return


    save_report_as_pdf(html_report, filename=f"{name.replace(' ', '_')}_report.pdf")
    print(f"\n✅ Report generated successfully: {name.replace(' ', '_')}_report.pdf")
    print(f"\n🕒 Total generation time: {round(time() - start_time, 2)} seconds.")

if __name__ == "__main__":
    main()
